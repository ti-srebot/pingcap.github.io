<!DOCTYPE html>
<html lang="en"><head>
<meta name="robots" content="noindex"><meta charset="utf-8"/><meta content="IE=edge" http-equiv="X-UA-Compatible"/><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" name="viewport"/>
<script>
window.ga =
    window.ga ||
    function() {
        ;(ga.q = ga.q || []).push(arguments)
    }
ga.l = +new Date()
ga('create', 'UA-99991864-4', 'auto')
ga('send', 'pageview')
</script>
<script async="" src="https://download.pingcap.com/js/ga-analytics.js"></script>
<link href="https://download.pingcap.com/style/github-markdown.css" rel="stylesheet"/>
<link href="/css/doc.css" rel="stylesheet"/>
<title>Futures and gRPC in Rust |Â TiDB</title><link href="/images/favicon.ico" rel="icon" type="image/x-icon"/>
<link href="/images/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
<link href="/images/apple-touch-icon.png" rel="apple-touch-icon"/>
<meta content="This is the speech Siddon Tang gave at Bay Area Rust Meetup August 2017." name="description"/>
<meta content="noodp" name="robots"/>
<meta content="TiDB, MySQL, HTAP, Open Source, Cloud-Native, NewSQL, Aurora Alternative" name="keywords"/>
<meta content="en_US" property="og:locale"/>
<meta content="website" property="og:type"/>
<meta content="Futures and gRPC in Rust | TiDB" property="og:title"/>
<meta content="This is the speech Siddon Tang gave at Bay Area Rust Meetup August 2017." property="og:description"/>
<meta content="https://pingcap.com/blog/2017-09-12-futuresandgrpc/" property="og:url"/>
<meta content="MySQL at Scale. No more manual sharding" property="og:site_name"/>
<meta content="/images/pingcap-opengraph.jpg" property="og:image"/>
<meta content="/images/pingcap-opengraph.jpg" property="og:image:secure_url"/><meta content="summary" name="twitter:card"/><meta content="This is the speech Siddon Tang gave at Bay Area Rust Meetup August 2017." name="twitter:description"/>
<meta content="Futures and gRPC in Rust | TiDB" name="twitter:title"/>
<meta content="@pingcap" name="twitter:site"/>
<meta content="https://download.pingcap.com/images/pingcap-opengraph.jpg" name="twitter:image"/><meta content="@pingcap" name="twitter:creator"/>
<script type="application/ld+json">
{
    "@context": "http:\/\/schema.org",
    "@type": "WebSite",
    "url": "https:\/\/pingcap.com\/",
    "name": "PingCAP",
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https:\/\/pingcap.com\/?s={search_term_string}",
        "query-input": "required name=search_term_string"
    }
}
</script>
<script>
    (function(){
        var bp = document.createElement('script');
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
<script async="" src="https://accounts.pingcap.com/static/pingcap_sso/js/track.beta.js" type="text/javascript"></script>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.woff" rel="preload" type="font/woff"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.ttf" rel="preload" type="font/ttf"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff" rel="preload" type="font/woff"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.ttf" rel="preload" type="font/ttf"/>
<link as="script" href="https://download.pingcap.com/js/jquery.min.js" rel="preload"/>
<link href="/css/main.css" rel="stylesheet"/>
<link href="https://download.pingcap.com/style/docsearch.min.css" rel="stylesheet"/>
<script type="text/javascript">
var trackOutboundLink = function(url) {
  var redirectTriggered = false
  ga('send', 'event', 'outbound', 'click', url, {
    hitCallback: function() {
      redirectTriggered = true
      document.location = url
    }
  })
  setTimeout(function() {
    if (!redirectTriggered) {
      document.location = url
    }
  }, 1500)
}

var trackViews = function(btn_type, event_category) {
  var event_label = btn_type
  var eventCategory = event_category
  ga('send', 'event', {
    'eventCategory': eventCategory,
    'eventAction': 'click',
    'eventLabel': event_label,
    'transport': 'beacon'
  });
}
</script>
<script>if (location.pathname === '/') {
        if (location.hostname === 'pingcap.github.io') {
            location.href = '/en/'
        }
    }</script></head> <body data-lang="en"><div id="page-content">
<header class="fixed-top" role="navigation">
<div class="container">
<a class="nav-brand" href="/en"><img alt="PingCAP" src="/images/pingcap-logo.png"/></a>
<div class="nav-wrapper">
<div class="navigation">
<ul>
<li><a class="a-en" href="https://en.pingcap.com">Cloud</a></li>
<li><a class="a-en" href="/tidb-academy">TiDB Academy</a></li>
<li class="docs-type-selector " id="docsTypeSelector">
<a class="header-doc-nav" href="#">Docs</a>
<div class="header-dropdown-menu" id="docsTypeSelectorItem">
<a class="header-dropdown-item" href="/docs/stable/">TiDB</a>
<a class="header-dropdown-item" href="/docs/tidb-in-kubernetes/stable/">TiDB in Kubernetes</a>
<a class="header-dropdown-item" href="/docs/tidb-data-migration/stable/">TiDB Data Migration (DM)</a>
</div>
</li>
<li><a class="a-en" href="/success-stories">Success
                    Stories</a></li>
<li class="sel"><a class="a-en" href="/blog">Blog</a></li>
<li><a class="link-download link-download-en" href="/download">Free Download</a></li>
</ul>
</div>
<div class="global-search">
<div class="search-wrapper">
<span class="icon-search"><svg fill="#fff" height="18" viewbox="0 0 67.125 67.125" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M23.902 0C11.01 0 .523 10.488.523 23.38c0 12.891 10.487 23.379 23.379 23.379a23.258 23.258 0 0 0 14.471-5.037l24.816 24.817c.391.391.902.586 1.414.586s1.023-.195 1.414-.586a2 2 0 0 0 0-2.828L41.293 38.985c3.721-4.142 5.989-9.613 5.989-15.605C47.282 10.488 36.794 0 23.902 0zM4.523 23.38C4.523 12.694 13.216 4 23.902 4c10.687 0 19.38 8.694 19.38 19.38 0 5.396-2.221 10.279-5.791 13.795a1.959 1.959 0 0 0-.488.349 2.003 2.003 0 0 0-.271.343C33.31 40.9 28.825 42.76 23.903 42.76c-10.686-.001-19.38-8.695-19.38-19.38z"></path><path d="M24.075 8.591c-8.25 0-14.962 6.712-14.962 14.962a2 2 0 0 0 4 0c0-6.044 4.918-10.962 10.962-10.962a2 2 0 0 0 0-4z"></path></svg></span>
<input data-lang="en" data-type="" id="search-input" name="q" placeholder="Search TiDB Docs" type="search"/>
</div>
<script>
    const inputNode = document.getElementById("search-input")

    inputNode.addEventListener('keyup', ({key}) => {
        if (key === "Enter") {
            if ($('#search-input').data('lang') == 'cn') {
                lang = 'zh'
            }

            const query = $('#search-input').val()
            if (query) {
                url = "https://docs.pingcap.com/" + (lang == 'zh' ? 'zh/' : '') + "search/?lang=" + lang + "&type=tidb&version=v4.0&q=" + query
                window.location.href = url
            }
        }
    })
</script>
</div>
</div>
<div class="nav-btn nav-slider">
<i class="material-icons"><svg height="16" viewbox="0 0 459 459" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M0 382.5h459v-51H0v51zM0 255h459v-51H0v51zM0 76.5v51h459v-51H0z" fill="#FFF"></path></svg></i>
</div>
</div>
</header>
<nav class="mobile-sidebar">
<div class="nav-header">
<div class="logo-wrap">
<a class="nav-brand" href="/en"><img alt="PingCAP" src="/images/pingcap-logo.png"/></a>
</div>
</div>
<ul class="ul-base">
<li><a href="https://en.pingcap.com/">Cloud</a></li>
<li><a class="tidb-academy" href="/tidb-academy">TiDB Academy</a></li>
<li class="docs-type-selector " id="docsTypeSelector">
<p class="header-doc-nav">Docs</p>
<div class="header-dropdown-menu" id="docsTypeSelectorItem">
<a class="header-dropdown-item" href="/docs/stable/">TiDB</a>
<a class="header-dropdown-item" href="/docs/tidb-in-kubernetes/stable/">TiDB in Kubernetes</a>
<a class="header-dropdown-item" href="/docs/tidb-data-migration/stable/">TiDB Data Migration (DM)</a>
</div>
</li>
<li><a href="/success-stories">Success Stories</a></li>
<li class="sel"><a href="/blog">Blog</a></li>
<li><a class="link-download" href="/download">Free Download</a></li>
</ul>
<div class="nav-footer">
<div class="contact-list-wrap">
<div class="flex-list">
<h4 class="list-title"><strong>Contact</strong></h4>
<ul class="social ul-base">
<li><a class="twitter" href="https://twitter.com/PingCAP" target="_blank"><svg height="18" viewbox="0 0 612 612" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"></path></svg></a></li>
<li><a class="linkedin" href="https://www.linkedin.com/company/pingcap/" target="_blank"><svg height="18" viewbox="0 0 438.536 438.535" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"></path></svg></a></li>
<li><a class="reddit" href="https://www.reddit.com/r/TiDB/" target="_blank"><svg height="18" viewbox="0 0 279.748 279.748" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"></path></svg></a></li>
<li><a class="google-plus" href="https://groups.google.com/forum/#!forum/tidb-user" target="_blank"><svg height="18" viewbox="0 0 491.858 491.858" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"></path></svg></a></li>
<li><a class="stack-overflow" href="https://stackoverflow.com/questions/tagged/tidb" target="_blank"><svg height="18" viewbox="0 0 547.597 547.597" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"></path><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"></path><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"></path></svg></a></li>
</ul>
</div>
<div class="subscribe">
<a href="https://share.hsforms.com/1e2W03wLJQQKPd1d9rCbj_Q2npzm"><button class="btn btn-subscribe f-tc" style="margin-left: 0.75rem;">Subscribe to Blog</button></a>
</div>
</div>
<div class="container">
<a class="btn-lang" href="/blog-cn" id="lang">ä¸­æ</a>
</div>
</div>
</nav>
<div class="blog">
<div class="blogArticle__container">
<div class="archive"><div class="article-nav">
<a href="/blog/#Engineering">BLOG HOME</a> <span> &gt; </span>Engineering</div><div class="content markdown-body">
<h1 class="title">Futures and gRPC in Rust</h1>
<ul class="blog-post-meta">
<li class="meta-item">
<img alt="Date icon" src="/images/svgs/icon-date.svg"/>Tue, Sep 12, 2017</li>
<li class="meta-item">
<img alt="Pen icon" src="/images/svgs/icon-writer.svg"/>Siddon Tang</li>
</ul>
<div class="blog-text"><p>This is the speech Tang Liu (<a href="mailto:tl@pingcap.com">tl@pingcap.com</a>) gave at the Bay Area Rust Meetup August 2017. <a href="https://air.mozilla.org/bay-area-rust-meetup-august-2017/">See the video</a>.</p>
<!-- TOC -->
<ul>
<li><a href="#speaker-introduction">Speaker Introduction</a></li>
<li><a href="#async-programming">Async Programming</a>
<ul>
<li><a href="#why-not-sync">Why not Sync?</a></li>
<li><a href="#why-async">Why Async?</a>
<ul>
<li><a href="#callback-hell">Callback Hell</a></li>
<li><a href="#coroutine-makes-it-easy">Coroutine Makes it Easy</a></li>
<li><a href="#future-another-way">Future, Another Way</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#futures-in-rust">Futures in Rust</a>
<ul>
<li><a href="#futures">Futures</a></li>
<li><a href="#combinator">Combinator</a></li>
<li><a href="#synchronization">Synchronization</a></li>
<li><a href="#stream">Stream</a></li>
<li><a href="#sink">Sink</a></li>
<li><a href="#task">Task</a></li>
</ul>
</li>
<li><a href="#grpc">gRPC</a>
<ul>
<li><a href="#why-grpc">Why gRPC?</a></li>
<li><a href="#http2">HTTP/2</a></li>
<li><a href="#grpc-based-on-http2">gRPC based on HTTP/2</a></li>
</ul>
</li>
<li><a href="#combine-futures-and-grpc">Combine Futures and gRPC</a>
<ul>
<li><a href="#c-grpc-keywords">C gRPC Keywords</a></li>
<li><a href="#pseudo-flow">Pseudo Flow</a></li>
<li><a href="#unary">Unary</a></li>
<li><a href="#client-streaming">Client Streaming</a></li>
<li><a href="#server-streaming">Server Streaming</a></li>
<li><a href="#duplex-streaming">Duplex Streaming</a></li>
</ul>
</li>
<li><a href="#unary-future-implementation">Unary Future Implementation</a>
<ul>
<li><a href="#client-unary">Client Unary</a></li>
<li><a href="#unary-future">Unary Future</a></li>
<li><a href="#resolve-future">Resolve Future</a></li>
</ul>
</li>
<li><a href="#benchmark">Benchmark</a></li>
<li><a href="#misc">Misc</a></li>
</ul>
<!-- /TOC -->
<h2 id="speaker-introduction">Speaker Introduction</h2>
<p>Hi everyone! I am very glad to join the meetup here. Thanks, the Rust team.</p>
<p>Today I will talk about the Futures and gRPC in Rust. Before we start, let me introduce myself briefly. My name is Siddon Tang, and siddontang on Github, chief engineer at PingCAP. I have been working on the next generation SQL database, <a href="https://github.com/pingcap/tidb">TiDB</a>, and a distributed key-value store, <a href="https://github.com/pingcap/tikv">TiKV</a>. By the way, TiKV is also written in Rust. I'm also an open source lover, and have some open source projects, such as LedisDB, go-mysql, go-mysql-elasticsearch, rust-prometheus, etc.</p>
<p>Today, I will first discuss Async briefly, then I will introduce Futures in Rust. Of course, you guys here are very familiar with them, so I will just go through it quickly. Then I will talk about gRPC, and in the end, I will show you how we use futures to wrap the gRPC in Rust.</p>
<h2 id="async-programming">Async Programming</h2>
<p>Let's begin. About Async.</p>
<h3 id="why-not-sync">Why not Sync?</h3>
<p>The first thing is why not Sync. As we all know, the Sync programming is easier. If the load of your service is low, using Sync may be better. You just need to start some threads to handle the concurrence.</p>
<p><img alt="Why not Sync?" class="lazy" data-original="https://download.pingcap.com/images/blog/why-not-sync.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>But if we want to support a high performance service, such as a database, Sync is not enough. Sync I/O can block the execution, which reduces the performance. Although we can use threads, but thread is heavy and wastes system resources. What's more, frequent thread switching is inefficient and causes the performance to reduce seriously.</p>
<h3 id="why-async">Why Async?</h3>
<p>So we chose Async.</p>
<p><img alt="Why Async?" class="lazy" data-original="https://download.pingcap.com/images/blog/why-async.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>There is no blocking in Async programming, so we don't have to wait the slow I/O and can do other things. When the I/O is ready, the system can notify us and we can handle it again. This is very efficient and therefore, the performance is high. But as you can see, the Async way is much more complex and it is hard to write the code correctly. The code logic is split into pieces when the I/O is not ready and we have to switch to do other things.</p>
<h4 id="callback-hell">Callback Hell</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">auto r <span style="color:#f92672">=</span> make_shared<span style="color:#f92672">&lt;</span>int<span style="color:#f92672">&gt;</span>();
do_async_foo() {
 do_foo_a(<span style="color:#f92672">|</span><span style="color:#f92672">|</span> {
 do_finish(<span style="color:#f92672">|</span><span style="color:#f92672">|</span> {
  <span style="color:#f92672">*</span>r <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
    })
  })
})
</code></pre></div><p>Sometimes, we have to use the callback mechanism to handle the I/O or other asynchronous notifications, and may sink into the callback hell, like this. Oh, so many callbacks.</p>
<h4 id="coroutine-makes-it-easy">Coroutine Makes it Easy</h4>
<p><img alt="Coroutine makes Async easy" class="lazy" data-original="https://download.pingcap.com/images/blog/coroutine-makes-it-easy.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>Of course, if we have to write code like this, it might drive us crazy. Luckily, we have at least two ways to bypass it. First, it is the coroutine.</p>
<p>Coroutine is a lightweight thread which is supported in many languages. Like the boost coroutine library, WebChat libco library in C plus plus, yield and greenlet in Python, and of course, goroutine in Go.</p>
<p>Here is a simple example to use goroutine and channel in Go. The two internal cool features allow us to write high performance concurrent code easily. I personally believe that it is the main reason that Go becomes more and more popular nowadays.</p>
<h4 id="future-another-way">Future, Another Way</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">let</span> future <span style="color:#f92672">=</span> do_async( future() )
 .then( future_a() )
 .then( future_b() )
 .then( future_c() );
future.wait();
</code></pre></div><p>Some languages don't provide coroutine, but we can have another workaround, which is future. Future is a kind-of promise. When we begin to resolve a future, the result of the future may not be ready now and cannot be retrieved now, but after the future is performed later, we can get the result again.</p>
<p>You can wait the future to be finished, and multiple futures can be combined into a future chain.</p>
<h2 id="futures-in-rust">Futures in Rust</h2>
<p>So what about futures in Rust?</p>
<p>In Rust, future has already been supported by <a href="https://github.com/alexcrichton">Alex</a>. Thanks, Alex!</p>
<p>Based on the Rust trait, the future is zero cost, which means that you don't need to do extra heap allocation or dynamic dispatch. Future is easy to use, you can combine many futures into a chain, and use the combinator like an Iterator API.</p>
<p>The future is demand-driven, not callback, you should poll the future explicitly to check whether the future is ready or not. No callback can also avoid the heap allocation, and we can cancel the future easily too.</p>
<h3 id="futures">Futures</h3>
<p>Future is a trait and the main function is poll.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> Future {
 <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Item</span>;
 <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Error</span>;
 <span style="color:#75715e">// check the future is resolved, return Ready or NotReady
</span><span style="color:#75715e"></span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Self::Item, Self::Error<span style="color:#f92672">&gt;</span>;
 <span style="color:#75715e">// wait until the future is resolved
</span><span style="color:#75715e"></span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">wait</span>() -&gt; <span style="color:#a6e22e">result</span>::Result<span style="color:#f92672">&lt;</span>Self::Item, Self::Error<span style="color:#f92672">&gt;</span>;
}

<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>T, E<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> Result<span style="color:#f92672">&lt;</span>Async<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>, E<span style="color:#f92672">&gt;</span>;
<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Async</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> {
    Ready(T),
    NotReady,
}
</code></pre></div><p>We must implement the poll for our customized future. The poll can return <code>NotReady</code>, which means the future is not ready and we should poll later. If <code>Ready</code> is returned, the future is finished and we can get the result. We can also wait the future to finish explicitly. If we call wait, the execution will be blocked until the future is performed.</p>
<p><strong>Future Example</strong></p>
<p>Here are some very simple future examples. For the <code>ok</code> future, <code>wait</code> will return <code>Ready</code>, the result is <code>1</code>; for the <code>empty</code> future, <code>poll</code> will return <code>NotReady</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">let</span> f <span style="color:#f92672">=</span> ok::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u32</span>, <span style="color:#66d9ef">u32</span><span style="color:#f92672">&gt;</span>(<span style="color:#ae81ff">1</span>);
assert_eq<span style="color:#f92672">!</span>(f.wait().unwrap(), <span style="color:#ae81ff">1</span>);

<span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> f <span style="color:#f92672">=</span> empty::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u32</span>, <span style="color:#66d9ef">u32</span><span style="color:#f92672">&gt;</span>();
assert_eq<span style="color:#f92672">!</span>(f.poll(), Ok(Async::NotReady));
</code></pre></div><h3 id="combinator">Combinator</h3>
<p>We can use combinator to chain the futures.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">let</span> f <span style="color:#f92672">=</span> ok::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u32</span>, <span style="color:#66d9ef">u32</span><span style="color:#f92672">&gt;</span>(<span style="color:#ae81ff">1</span>).map(<span style="color:#f92672">|</span>x<span style="color:#f92672">|</span> x <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>);
assert_eq<span style="color:#f92672">!</span>(f.wait().unwrap(), <span style="color:#ae81ff">2</span>);

<span style="color:#66d9ef">let</span> f1 <span style="color:#f92672">=</span> ok::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u32</span>, <span style="color:#66d9ef">u32</span><span style="color:#f92672">&gt;</span>(<span style="color:#ae81ff">1</span>);
<span style="color:#66d9ef">let</span> f2 <span style="color:#f92672">=</span> ok::<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u32</span>, <span style="color:#66d9ef">u32</span><span style="color:#f92672">&gt;</span>(<span style="color:#ae81ff">2</span>);
<span style="color:#66d9ef">let</span> (_, next) <span style="color:#f92672">=</span> f1.select(f2).wait().ok().unwrap();
assert_eq<span style="color:#f92672">!</span>(next.wait().unwrap(), <span style="color:#ae81ff">2</span>);
</code></pre></div><p>For example, we can use the <code>ok</code> future plus map combinator, and the end result is <code>2</code>. We can use <code>select</code> to wait for two futures. If either future is ready, the <code>select</code> future is finished and returns the result plus a next future to be resolved later.</p>
<h3 id="synchronization">Synchronization</h3>
<p>The future library provides two synchronization channels. One-shot is for SPSC and channel is for MPSC. Both can be used for communication cross threads.</p>
<p><img alt="Two synchronization channels" class="lazy" data-original="https://download.pingcap.com/images/blog/synchronization.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="trackable-btns">
<a href="/download" onclick="trackViews('Futures and gRPC in Rust', 'download-tidb-btn-middle')"><button>Download TiDB</button></a>
<a href="https://share.hsforms.com/1e2W03wLJQQKPd1d9rCbj_Q2npzm" onclick="trackViews('Futures and gRPC in Rust', 'subscribe-blog-btn-middle')"><button>Subscribe to Blog</button></a>
</div>
<h3 id="stream">Stream</h3>
<p>Stream is like Future, and you can resolve the value one by one until the stream is finished.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> Stream {
 <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Item</span>;
 <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Error</span>;
 <span style="color:#75715e">// check the future is resolved, return Ready or NotReady
</span><span style="color:#75715e"></span> <span style="color:#75715e">// Ready(Some) means next value is on the stream
</span><span style="color:#75715e"></span> <span style="color:#75715e">// Ready(None) means the stream is finished
</span><span style="color:#75715e"></span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>Option<span style="color:#f92672">&lt;</span>Self::Item<span style="color:#f92672">&gt;</span>, Self::Error<span style="color:#f92672">&gt;</span>;
}
</code></pre></div><p>If the poll of the stream returns <code>Ready Some</code>, it means you can still get the next value of the stream. If <code>Ready None</code> is returned, it means the stream is finished and you can never poll the stream again.</p>
<h3 id="sink">Sink</h3>
<p>Sink is a way to send value asynchronously.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> Sink {
 <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SinkItem</span>;
 <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SinkError</span>;
 <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">start_send</span>(self, item: <span style="color:#a6e22e">Self</span>::SinkItem) -&gt; <span style="color:#a6e22e">StartSend</span><span style="color:#f92672">&lt;</span>Self::SinkItem, Self::SinkError<span style="color:#f92672">&gt;</span>;
 <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll_complete</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>(), Self::SinkError<span style="color:#f92672">&gt;</span>;
 <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">close</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>(), Self::SinkError<span style="color:#f92672">&gt;</span>;
}
</code></pre></div><p>We can use <code>start_send</code> to send one value, and use <code>poll_complete</code> to flush the sink and check whether all values are sent or not, or you can use <code>close</code> to close the sink.</p>
<h3 id="task">Task</h3>
<p>The task is used to drive the future computation.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#960050;background-color:#1e0010">#</span> If the future is not ready<span style="color:#f92672">?</span>
<span style="color:#66d9ef">let</span> handle <span style="color:#f92672">=</span> task::current();

<span style="color:#960050;background-color:#1e0010">#</span> If the event of interest occurs<span style="color:#f92672">?</span>
handle.notify();

<span style="color:#960050;background-color:#1e0010">#</span> What to <span style="color:#66d9ef">do</span> after notify<span style="color:#f92672">?</span>
executor.poll(f);

</code></pre></div><p>If the future is not ready, we can use task <code>current</code> to get a task handle. We can use task <code>notify</code> to wake up the task when it is ready, and the <code>executor</code> should poll the future again.</p>
<p>That's all about the Rust futures for today.</p>
<h2 id="grpc">gRPC</h2>
<p>Now let's talk about gRPC.</p>
<p>If you want to develop a service, the first thing you need to decide is how the client communicates with your service. You may implement your own protocol and RPC. Although it is efficient, it is not common. You may also use RESTful API based on HTTP protocol directly, but if you care about high performance and need to provide many APIs, it is not convenient.</p>
<h3 id="why-grpc">Why gRPC?</h3>
<p>Now, many users choose gRPC, a widely used RPC framework developed by Google. The gRPC is supported by many languages. Users can communicate with your service with their favorite languages easily. The gRPC uses protocol buffer for serializing and de-serializing the binary data efficiently. The gRPC has rich interfaces, and you can use unary, client streaming, server streaming and duplex streaming for your own case. The gRPC is based on HTTP/2, so you can get many benefits. For example, you can use SSL of HTTP/2 for data encryption.</p>
<h3 id="http2">HTTP/2</h3>
<p>The gRPC is based on HTTP/2. Unlike HTTP/1, which uses a text protocol, HTTP/2 is a binary protocol for performance, but it is hard for us to read directly. Luckily, many tools like wireshark have already supported parsing the protocol.</p>
<p>In HTTP/1, if we send a request, we must wait for the response and then send the next request again on the same connection. This is not efficient. But HTTP/2 uses stream to support multiplexing in one connection.</p>
<p>HTTP/2 also supports priority, so we can serve the important request first. HTTP/2 supports control flow. We can control how and when to send data if possible. HTTP/2 uses HPACK to compress the HTTP header, to reduce the network transferred size.</p>
<h3 id="grpc-based-on-http2">gRPC based on HTTP/2</h3>
<p>The gRPC uses HTTP/2 headers to pass the own headers of gRPC. It uses the HTTP/2 data frame to transfer data and maps the service name and method in the HTTP/2 path. Of course, the HTTP/2 content length is application gRPC plus proto.</p>
<p>That's a brief introduction of gRPC. Let's go on.</p>
<h2 id="combine-futures-and-grpc">Combine Futures and gRPC</h2>
<p>There are many gRPC implementations in different languages. Unfortunately, no one is available for Rust in production. But we really want to use gRPC in TiKV, so we decide to implement it by ourselves.</p>
<h3 id="c-grpc-keywords">C gRPC Keywords</h3>
<p>The Google gRCP has a core library written in the C language, and other supported languages like C plus plus, php, C sharp all use the C core API, so we decide to use it in Rust directly.</p>
<p>When we start, we should know some keywords of the C core.</p>
<ul>
<li>Call. Call means a gRPC call, like unary, client streaming, server streaming and duplex streaming.</li>
<li>Channel. Channel means a connection.</li>
<li>Server. We can register the service in the server.</li>
<li>Completion queue. It's the most important one. We drive the completion queue with the Next function infinitely.</li>
</ul>
<h3 id="pseudo-flow">Pseudo Flow</h3>
<p>Here is a pseudo flow for client unary when we use C API.</p>
<ul>
<li>Create completion queue</li>
<li>Create client channel</li>
<li>Create a call from the channel</li>
<li>Start operations in batch of the call with a <strong>tag</strong></li>
<li><strong>Poll</strong> completion queue to perform the call and return the event contains a <strong>tag</strong></li>
<li>Use tag to do somethingâ¦</li>
</ul>
<p>First, we create the completion queue, then create a channel with the client and server. Then we create a call from the channel, and start a batch of operations of the call with an associated tag. We poll the completion queue and get the event if the call is finished. Then we get the associated tag from the event and do something.</p>
<p>As you can see, the flow is asynchronous, so we can use future to wrap gRPC C API and support an ergonomic API for outside use.</p>
<h3 id="unary">Unary</h3>
<p>For unary, client sends a request, and waits for a response.</p>
<p><img alt="Unary" class="lazy" data-original="https://download.pingcap.com/images/blog/unary.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>Client:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">let</span> future <span style="color:#f92672">=</span> unary(service, method, request);
<span style="color:#66d9ef">let</span> response <span style="color:#f92672">=</span> future.wait();
</code></pre></div><p>So in the client side, the API definition is simple. We can return a future directly to get the response later.</p>
<p>Server Handler:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">on_unary</span>(context, request, response_sink) {
 context.spawn(<span style="color:#f92672">|</span><span style="color:#f92672">|</span> {
  <span style="color:#75715e">// do something with request
</span><span style="color:#75715e"></span>  response_sink.send(response)
 });
}
</code></pre></div><p>In the server side, the associated server handle looks like this, the context can spawn a task, and in the task, we can handle the request and use a sink to send the response back.</p>
<h3 id="client-streaming">Client Streaming</h3>
<p>For client streaming, client sends many requests and receives a single response, then the client streaming is finished.</p>
<p><img alt="Client streaming" class="lazy" data-original="https://download.pingcap.com/images/blog/client-streaming.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>Client:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">let</span> (sink, future) <span style="color:#f92672">=</span> client_streaming(service, method);
sink <span style="color:#f92672">=</span> sink.send(request).wait().unwrap();
sink <span style="color:#f92672">=</span> sink.send(request).wait().unwrap();
<span style="color:#960050;background-color:#1e0010">â¦</span><span style="color:#960050;background-color:#1e0010">â¦</span>
<span style="color:#66d9ef">let</span> response <span style="color:#f92672">=</span> future.wait();
</code></pre></div><p>So for the client side, we return a sink plus a future, and use sink to send a request, and use future to wait for the response.</p>
<p>Server Handler:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">on_client_streaming</span>(context, request_stream, response_sink) {
 context.spawn(<span style="color:#f92672">|</span><span style="color:#f92672">|</span>{
 request_stream.fold(<span style="color:#f92672">|</span>request<span style="color:#f92672">|</span> {
 <span style="color:#75715e">// do something
</span><span style="color:#75715e"></span>}.and_then() {
 response_sink.send();
}})}
</code></pre></div><p>In the server side, we use a stream to receive the client requests and use a sink to send the response back.</p>
<h3 id="server-streaming">Server Streaming</h3>
<p>For server streaming, client first sends a request and then receives many responses one by one.</p>
<p><img alt="Server streaming" class="lazy" data-original="https://download.pingcap.com/images/blog/server-streaming.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>Client :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">let</span> stream <span style="color:#f92672">=</span> server_streaming(service, method, request);
stream.for_each(<span style="color:#f92672">|</span>response<span style="color:#f92672">|</span> {
 <span style="color:#75715e">// do something
</span><span style="color:#75715e"></span>});
</code></pre></div><p>Server Handler:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">Server Handler:
<span style="color:#a6e22e">fn</span> on_server_streaming(context, request, response_sink) {
 context.spawn(<span style="color:#f92672">|</span><span style="color:#f92672">|</span>{
  response_sink.send();
 });
}
</code></pre></div><p>So for the client side, we return a stream to recv the response. And for the server side, we use a sink to send the response back.</p>
<h3 id="duplex-streaming">Duplex Streaming</h3>
<p>For duplex streaming, both the client and server can send many requests and responses.</p>
<p><img alt="Duplex streaming" class="lazy" data-original="https://download.pingcap.com/images/blog/duplex-streaming.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>Client:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">let</span> (sink, stream) <span style="color:#f92672">=</span> duplex_streaming(service, method);
sink.send_all();
stream.for_each();
</code></pre></div><p>Server Handler:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">on_duplex_streaming</span>(context, request_stream, response_sink) {
 context.spawn(<span style="color:#f92672">|</span><span style="color:#f92672">|</span>{
 <span style="color:#66d9ef">let</span> resps <span style="color:#f92672">=</span> request_stream.map().collect().flatten();
  response_sink.send_all(resps);
}
}
</code></pre></div><p>So for the client side, we return a sink plus stream. And for the server side, we also use a stream and a sink.</p>
<h2 id="unary-future-implementation">Unary Future Implementation</h2>
<p>Using future, sink and stream can wrap the C gRPC core API easily. Let's dive in deep. I will use the client unary as an example, to see how we combine the future and gRPC.</p>
<h3 id="client-unary">Client Unary</h3>
<p>First, we create a Call from the channel, and create a future and a tag. Because we must pass the tag to C API, here we use <code>Box::into_raw</code> to release its lifetime. Then we call the C start batch API.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">let</span> call <span style="color:#f92672">=</span> channel.create_call();
<span style="color:#66d9ef">let</span> (future, tag) <span style="color:#f92672">=</span> CallTag::batch_pair();
<span style="color:#75715e">// create a tag and let gRPC manages its lifetime
</span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> tag_box <span style="color:#f92672">=</span> Box:<span style="color:#a6e22e">new</span>(tag);
<span style="color:#66d9ef">let</span> tag_ptr <span style="color:#f92672">=</span> Box::into_raw(tag_box) <span style="color:#66d9ef">as</span> _;
call_start_batch(<span style="color:#960050;background-color:#1e0010">â¦</span>, tag_ptr);
</code></pre></div><h3 id="unary-future">Unary Future</h3>
<p>The future implementation is easy. In the poll function, we first check whether we have a result. If yes, we will return <code>Ready</code>; if not, we will check whether we have a task. If we have no task, or the task <code>will_notify_current</code> is false, we will use the task current to save the handle.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">poll</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; <span style="color:#a6e22e">Poll</span><span style="color:#f92672">&lt;</span>T, Error<span style="color:#f92672">&gt;</span> {
 <span style="color:#66d9ef">let</span> guard <span style="color:#f92672">=</span> self.inner.lock();
 <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some(res) <span style="color:#f92672">=</span> guard.result.take() {
  <span style="color:#66d9ef">let</span> r <span style="color:#f92672">=</span> try<span style="color:#f92672">!</span>(res);
  <span style="color:#66d9ef">return</span> Ok(Async::Ready(r));
}
<span style="color:#75715e">// Has not been finished yet, Add notification hook
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> guard.task.is_none() <span style="color:#f92672">|</span><span style="color:#f92672">|</span> <span style="color:#f92672">!</span>guard.task.as_ref().unwrap().will_notify_current() {
 guard.task <span style="color:#f92672">=</span> task::current();
}
Ok(Async::NotReady)
}
</code></pre></div><h3 id="resolve-future">Resolve Future</h3>
<p>In the completion queue, we use <code>next</code> to get the next finished event, and use <code>Box</code> from raw to acquire the tag again. Then we resolve the tag, and set the result for the call. If there is a task handle, we will notify it.</p>
<p>In Completion Queue:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">let</span> e <span style="color:#f92672">=</span> cq.next();
<span style="color:#75715e">// Get the tag from gRPC again
</span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> tag: Box<span style="color:#f92672">&lt;</span>CallTag<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { Box::from_raw(e.tag <span style="color:#66d9ef">as</span> _) } ;
tag.resolve(<span style="color:#f92672">&amp;</span>cq, e.success <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>);
</code></pre></div><p>In Resolve:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">let</span> task <span style="color:#f92672">=</span> {
<span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> guard <span style="color:#f92672">=</span> self.inner.lock();
guard.set_result(res)
gurad.task.take();
};
task.map(<span style="color:#f92672">|</span>t<span style="color:#f92672">|</span> t.notify());
</code></pre></div><p>The flow is very easy, and client streaming, server streaming and duplex streaming also have the similar way, so I will not cover them now.</p>
<h2 id="benchmark">Benchmark</h2>
<p><img alt="Performance benchmark" class="lazy" data-original="https://download.pingcap.com/images/blog/benchmark.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>Using future to support gRPC is very efficient. We have done many benchmarks. You can see that the performance is great.</p>
<h2 id="misc">Misc</h2>
<p>Now we have already used gRPC in TiKV in production for a long time. It works well. If you want to try it, please check github.com/pingcap/grpc-rs. You can also use cargo to install grpcio.</p>
<p>That's all. Thank you very much.</p>
</div>
</div>
<div class="article-toc"></div><div class="ssba-wrap">
<div class="ssba">
<a class="ssba_twitter_share" data-site="" href="http://twitter.com/share?url=https%3a%2f%2fpingcap.com%2fblog%2f2017-09-12-futuresandgrpc%2f" target="_blank">
<img alt="Twitter icon" src="/images/svgs/twitter-icon.svg"/>
</a>
<a class="ssba_reddit_share" data-site="reddit" href="http://reddit.com/submit?url=https%3a%2f%2fpingcap.com%2fblog%2f2017-09-12-futuresandgrpc%2f&amp;title=Futures%20and%20gRPC%20in%20Rust" target="_blank">
<img alt="Reddit icon" src="/images/svgs/reddit-icon.svg"/>
</a>
<a class="ssba_facebook_share" data-site="" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpingcap.com%2fblog%2f2017-09-12-futuresandgrpc%2f" target="_blank">
<img alt="Fackbook icon" src="/images/svgs/facebook-icon.svg"/>
</a>
<a class="ssba_linkedin_share" data-site="linkedin" href="http://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fpingcap.com%2fblog%2f2017-09-12-futuresandgrpc%2f" target="_blank">
<img alt="Linkedin icon" src="/images/svgs/linkedin-icon.svg"/>
</a>
<a class="ssba_hackernews_share" data-site="hackernews" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpingcap.com%2fblog%2f2017-09-12-futuresandgrpc%2f&amp;t=Futures%20and%20gRPC%20in%20Rust" target="_blank">
<img alt="Hacker News icon" src="/images/svgs/hacker-news-icon.svg"/>
</a>
</div>
</div>
<div class="trackable-btns">
<a href="/download" onclick="trackViews('Futures and gRPC in Rust', 'download-tidb-btn-bottom')"><button>Download
                        TiDB</button></a>
<a href="https://share.hsforms.com/1e2W03wLJQQKPd1d9rCbj_Q2npzm" onclick="trackViews('Futures and gRPC in Rust', 'subscribe-blog-btn-bottom')"><button>Subscribe to
                        Blog</button></a>
</div>
</div>
<div class="sidebar-page">
<div class="sticky-sidebar">
<p class="toc-title">Whatâs on this page</p>
<div id="smart_toc_wrapper"></div>
</div>
</div>
</div>
</div>
<footer>
<div class="container">
<div class="flex-list-wrap">
<div class="flex-list">
<h4 class="list-title"><strong>Product</strong></h4>
<ul>
<li><a href="/docs/v3.0/">TiDB</a></li>
<li><a href="/docs/v3.0/reference/tispark/">TiSpark</a></li>
<li><a href="/docs/v3.0/roadmap/">Roadmap</a></li>
</ul>
</div>
<div class="flex-list">
<h4 class="list-title"><strong>Docs</strong></h4>
<ul>
<li><a href="/docs/stable/quick-start-with-tidb/">Quick Start</a></li>
<li><a href="/blog/2017-07-24-tidbbestpractice/">Best Practices</a></li>
<li><a href="/docs/stable/faq/tidb/">FAQ</a></li>
<li><a href="/docs/stable/reference/tools/user-guide/">TiDB Tools</a></li>
<li><a href="/docs/dev/releases/rn/">Release Notes</a></li>
</ul>
</div>
<div class="flex-list">
<h4 class="list-title"><strong>Resources</strong></h4>
<ul>
<li><a href="/blog/">Blog</a></li>
<li><a href="/weekly/">Monthly</a></li>
<li><a href="https://github.com/pingcap" target="_blank">GitHub</a></li>
<li><a href="/community">TiDB Community</a></li>
</ul>
</div>
<div class="flex-list">
<h4 class="list-title"><strong>Company</strong></h4>
<ul>
<li><a href="/about/">About</a></li>
<li><a href="https://angel.co/pingcap-1/jobs" target="_blank">Careers</a></li>
<li><a href="/news/">News</a></li>
<li><a href="/contact-us/">Contact Us</a></li>
<li><a href="/privacy-policy/">Privacy Policy</a></li>
<li><a href="/terms-of-service/">Terms of Service</a></li>
</ul>
</div>
</div>
<div class="contact-list-wrap">
<div class="flex-list">
<h4 class="list-title"><strong>Connect</strong></h4>
<ul>
<li><a class="twitter" href="https://twitter.com/PingCAP" target="_blank"><svg height="19" viewbox="0 0 612 612" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"></path></svg> Twitter</a></li>
<li><a class="linkedin" href="https://www.linkedin.com/company/pingcap/" target="_blank"><svg height="16" viewbox="0 0 438.536 438.535" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"></path></svg> LinkedIn</a></li>
<li><a class="reddit" href="https://www.reddit.com/r/TiDB/" target="_blank"><svg height="18" viewbox="0 0 279.748 279.748" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"></path></svg>Reddit</a></li>
<li><a class="google-plus" href="https://groups.google.com/forum/#!forum/tidb-user" target="_blank"><svg height="20" viewbox="0 0 491.858 491.858" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"></path></svg>Google Group</a></li>
<li><a class="stack-overflow" href="https://stackoverflow.com/questions/tagged/tidb" target="_blank"><svg height="17" viewbox="0 0 547.597 547.597" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"></path><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"></path><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"></path></svg>Stack Overflow</a></li>
</ul>
</div>
<div class="subscribe">
<a href="https://share.hsforms.com/1e2W03wLJQQKPd1d9rCbj_Q2npzm"><button class="btn btn-subscribe f-tc">Subscribe to Blog</button></a>
</div>
</div>
</div>
<div class="container copyright-container">
<p class="copyright">Â© 2020 PingCAP. All Rights Reserved.</p>
<a class="copyright-btn-lang" href="/blog-cn" id="lang">ä¸­æ</a>
</div>
</footer>
<button class="back-to-top" type="button"><svg height="512" viewbox="0 0 284.929 284.929" width="512" xmlns="http://www.w3.org/2000/svg"><path d="M282.082 195.285L149.028 62.24c-1.901-1.903-4.088-2.856-6.562-2.856s-4.665.953-6.567 2.856L2.856 195.285C.95 197.191 0 199.378 0 201.853c0 2.474.953 4.664 2.856 6.566l14.272 14.271c1.903 1.903 4.093 2.854 6.567 2.854s4.664-.951 6.567-2.854l112.204-112.202 112.208 112.209c1.902 1.903 4.093 2.848 6.563 2.848 2.478 0 4.668-.951 6.57-2.848l14.274-14.277c1.902-1.902 2.847-4.093 2.847-6.566.001-2.476-.944-4.666-2.846-6.569z" fill="#FFF"></path></svg>
</button>
</div><div class="overlay"></div><script src="https://download.pingcap.com/js/jquery.min.js"></script><script src="/js/vendor/lazyload.min.js" type="text/javascript"></script>
<script src="/js/doc.js" type="text/javascript"></script>
<script src="/js/anchor.js" type="text/javascript"></script><script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script crossorigin="anonymous" integrity="sha384-jbFinqIbKkHNg+QL+yxB4VrBC0EAPTuaLGeRT0T+NfEV89YC6u1bKxHLwoo+/xxY" src="https://browser.sentry-cdn.com/5.11.0/bundle.min.js"></script><script>Sentry.init({ 
            dsn: 'https://3f28ed393c5545daa74496b3cdb2e9ba@sentry.io/1887163' 
        });</script></body></html>