<!DOCTYPE html>
<html lang="en"><head>
<meta name="robots" content="noindex"><meta charset="utf-8"/><meta content="IE=edge" http-equiv="X-UA-Compatible"/><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" name="viewport"/>
<script>
window.ga =
    window.ga ||
    function() {
        ;(ga.q = ga.q || []).push(arguments)
    }
ga.l = +new Date()
ga('create', 'UA-99991864-4', 'auto')
ga('send', 'pageview')
</script>
<script async="" src="https://download.pingcap.com/js/ga-analytics.js"></script>
<link href="https://download.pingcap.com/style/github-markdown.css" rel="stylesheet"/>
<link href="/css/doc.css" rel="stylesheet"/>
<title>TiDB 最佳实践系列（五）Java 数据库应用开发指南 | PingCAP</title><link href="/images/favicon.ico" rel="icon" type="image/x-icon"/>
<link href="/images/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
<link href="/images/apple-touch-icon.png" rel="apple-touch-icon"/>
<meta content="本文将从 Java 数据库交互组件开发的角度出发，介绍各组件的推荐配置和推荐使用方式，希望能帮助 Java 开发者在使用 TiDB 时能更好的发挥数据库性能。" name="description"/>
<meta content="noodp" name="robots"/>
<meta content="TiDB, MySQL, HTAP, Open Source, Cloud-Native, NewSQL, Aurora Alternative" name="keywords"/>
<meta content="en_US" property="og:locale"/>
<meta content="website" property="og:type"/>
<meta content="TiDB 最佳实践系列（五）Java 数据库应用开发指南 | PingCAP" property="og:title"/>
<meta content="本文将从 Java 数据库交互组件开发的角度出发，介绍各组件的推荐配置和推荐使用方式，希望能帮助 Java 开发者在使用 TiDB 时能更好的发挥数据库性能。" property="og:description"/>
<meta content="https://pingcap.com/blog-cn/best-practice-java/" property="og:url"/>
<meta content="MySQL at Scale. No more manual sharding" property="og:site_name"/>
<meta content="/images/pingcap-opengraph.jpg" property="og:image"/>
<meta content="/images/pingcap-opengraph.jpg" property="og:image:secure_url"/><meta content="summary" name="twitter:card"/><meta content="本文将从 Java 数据库交互组件开发的角度出发，介绍各组件的推荐配置和推荐使用方式，希望能帮助 Java 开发者在使用 TiDB 时能更好的发挥数据库性能。" name="twitter:description"/>
<meta content="TiDB 最佳实践系列（五）Java 数据库应用开发指南 | PingCAP" name="twitter:title"/>
<meta content="@pingcap" name="twitter:site"/>
<meta content="https://download.pingcap.com/images/pingcap-opengraph.jpg" name="twitter:image"/><meta content="@pingcap" name="twitter:creator"/>
<script type="application/ld+json">
{
    "@context": "http:\/\/schema.org",
    "@type": "WebSite",
    "url": "https:\/\/pingcap.com\/",
    "name": "PingCAP",
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https:\/\/pingcap.com\/?s={search_term_string}",
        "query-input": "required name=search_term_string"
    }
}
</script>
<script>
    (function(){
        var bp = document.createElement('script');
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
<script async="" src="https://accounts.pingcap.com/static/pingcap_sso/js/track.beta.js" type="text/javascript"></script>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.woff" rel="preload" type="font/woff"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.ttf" rel="preload" type="font/ttf"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff" rel="preload" type="font/woff"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.ttf" rel="preload" type="font/ttf"/>
<link as="script" href="https://download.pingcap.com/js/jquery.min.js" rel="preload"/>
<link href="/css/main.css" rel="stylesheet"/>
<link href="https://download.pingcap.com/style/docsearch.min.css" rel="stylesheet"/>
<script type="text/javascript">
var trackOutboundLink = function(url) {
  var redirectTriggered = false
  ga('send', 'event', 'outbound', 'click', url, {
    hitCallback: function() {
      redirectTriggered = true
      document.location = url
    }
  })
  setTimeout(function() {
    if (!redirectTriggered) {
      document.location = url
    }
  }, 1500)
}

var trackViews = function(btn_type, event_category) {
  var event_label = btn_type
  var eventCategory = event_category
  ga('send', 'event', {
    'eventCategory': eventCategory,
    'eventAction': 'click',
    'eventLabel': event_label,
    'transport': 'beacon'
  });
}
</script>
<script>if (location.pathname === '/') {
        if (location.hostname === 'pingcap.github.io') {
            location.href = '/en/'
        }
    }</script></head> <body data-lang="cn"><div id="page-content">
<header class="fixed-top" role="navigation">
<div class="container">
<a class="nav-brand" href="/zh"><img alt="PingCAP" src="/images/pingcap-logo.png"/></a>
<div class="nav-wrapper">
<div class="navigation">
<ul>
<li><a class="nav-blinking" href="https://university.pingcap.com/" onclick="trackViews('navbar-university', 'pingcap-university_view')" target="_blank">PingCAP
                            University</a></li>
<li class="docs-type-selector " id="docsTypeSelector">
<a class="header-doc-nav" href="https://docs.pingcap.com/zh" target="_blank">文档</a>
</li>
<li><a href="/cases-cn">案例</a></li>
<li><a href="/community-cn">社区</a></li>
<li class="sel"><a href="/blog-cn">博客</a></li>
<li><a href="/about-cn">关于</a></li>
<li><a href="https://asktug.com" onclick="trackViews('navbar-asktug', 'asktug_view')" target="_blank">问答</a></li>
<li><a href="/download-cn">下载试用</a></li>
<li><a class="link-download" href="mailto:info@pingcap.com" onclick="trackViews('navbar-contact-us', 'mail_to_info_view')" target="_blank">联系我们</a></li>
</ul>
</div>
<div class="global-search">
<div class="search-wrapper">
<span class="icon-search"><svg fill="#fff" height="18" viewbox="0 0 67.125 67.125" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M23.902 0C11.01 0 .523 10.488.523 23.38c0 12.891 10.487 23.379 23.379 23.379a23.258 23.258 0 0 0 14.471-5.037l24.816 24.817c.391.391.902.586 1.414.586s1.023-.195 1.414-.586a2 2 0 0 0 0-2.828L41.293 38.985c3.721-4.142 5.989-9.613 5.989-15.605C47.282 10.488 36.794 0 23.902 0zM4.523 23.38C4.523 12.694 13.216 4 23.902 4c10.687 0 19.38 8.694 19.38 19.38 0 5.396-2.221 10.279-5.791 13.795a1.959 1.959 0 0 0-.488.349 2.003 2.003 0 0 0-.271.343C33.31 40.9 28.825 42.76 23.903 42.76c-10.686-.001-19.38-8.695-19.38-19.38z"></path><path d="M24.075 8.591c-8.25 0-14.962 6.712-14.962 14.962a2 2 0 0 0 4 0c0-6.044 4.918-10.962 10.962-10.962a2 2 0 0 0 0-4z"></path></svg></span>
<input data-lang="cn" data-type="" id="search-input" name="q" placeholder="搜索 TiDB 文档" type="search"/>
</div>
<script>
    const inputNode = document.getElementById("search-input")

    inputNode.addEventListener('keyup', ({key}) => {
        if (key === "Enter") {
            if ($('#search-input').data('lang') == 'cn') {
                lang = 'zh'
            }

            const query = $('#search-input').val()
            if (query) {
                url = "https://docs.pingcap.com/" + (lang == 'zh' ? 'zh/' : '') + "search/?lang=" + lang + "&type=tidb&version=v4.0&q=" + query
                window.location.href = url
            }
        }
    })
</script>
</div>
</div>
<div class="nav-btn nav-slider">
<i class="material-icons"><svg height="16" viewbox="0 0 459 459" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M0 382.5h459v-51H0v51zM0 255h459v-51H0v51zM0 76.5v51h459v-51H0z" fill="#FFF"></path></svg></i>
</div>
</div>
</header>
<nav class="mobile-sidebar">
<div class="nav-header">
<div class="logo-wrap">
<a class="nav-brand" href="/en"><img alt="PingCAP" src="/images/pingcap-logo.png"/></a>
</div>
</div>
<ul class="ul-base">
<li><a href="https://docs.pingcap.com/zh/tidb/v4.0/">文档</a></li>
<li><a href="/cases-cn">案例</a></li>
<li><a href="/community-cn">社区</a></li>
<li class="sel"><a href="/blog-cn">博客</a></li>
<li><a href="/about-cn">关于</a></li>
<li><a href="https://asktug.com" onclick="trackViews('navbar-asktug', 'asktug_view')" target="_blank">问答</a></li>
<li><a href="/download-cn">下载试用</a></li>
<li><a class="link-download" href="mailto:info@pingcap.com" onclick="trackViews('navbar-contact-us', 'mail_to_info_view')" target="_blank">联系我们</a></li>
<li><a class="nav-blinking" href="https://university.pingcap.com/" onclick="trackViews('navbar-university', 'pingcap-university_view')" target="_blank">PingCAP University</a></li>
</ul>
<div class="nav-footer">
<div class="contact-list-wrap">
<div class="flex-list">
<h4 class="list-title"><strong>Contact</strong></h4>
<ul class="social social-cn ul-base">
<li><a class="twitter" href="https://twitter.com/PingCAP" target="_blank"><svg height="18" viewbox="0 0 612 612" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"></path></svg></a></li>
<li><a class="linkedin" href="https://www.linkedin.com/company/pingcap/" target="_blank"><svg height="18" viewbox="0 0 438.536 438.535" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"></path></svg></a></li>
<li><a class="reddit" href="https://www.reddit.com/r/TiDB/" target="_blank"><svg height="18" viewbox="0 0 279.748 279.748" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"></path></svg></a></li>
<li><a class="google-plus" href="https://groups.google.com/forum/#!forum/tidb-user" target="_blank"><svg height="18" viewbox="0 0 491.858 491.858" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"></path></svg></a></li>
<li><a class="stack-overflow" href="https://stackoverflow.com/questions/tagged/tidb" target="_blank"><svg height="18" viewbox="0 0 547.597 547.597" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"></path><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"></path><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"></path></svg></a></li>
<li id="wechat-mobile"><a class="wechat" href="javascript:void(0)"><svg height="18" viewbox="0 0 31.403 31.404" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"></path><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"></path></svg></a><div class="qr_code_outer f-hide f-tc">
<div class="qr_code">
<i id="close_qrcode"><svg viewbox="0 0 224.512 224.512" xmlns="http://www.w3.org/2000/svg"><path d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z" fill="#010002"></path></svg></i>
<img alt="Wechat qrCode" class="qr_code_img" id="js_qr_code_img" src="/images/wechat-qrcode.jpg"/>
<p>微信扫一扫<br/> 微信ID：pingcap2015</p>
</div>
</div>
</li>
</ul>
</div>
<div class="subscribe" id="subscribe-mobile"></div>
</div>
<div class="container">
<a class="btn-lang" href="/blog" id="lang">English</a>
</div>
</div>
</nav>
<div class="blog">
<div class="container">
<div class="sidebar nav-tags" data-type="single"><div class="title">热门标签<a class="rss" href="/blog-cn/index.xml" title="RSS Feed"><svg height="17" viewbox="0 0 402.041 402.04" width="13" xmlns="http://www.w3.org/2000/svg"><g fill="#3A59F0"><path d="M54.816 292.382c-15.229 0-28.169 5.331-38.831 15.988C5.33 319.026 0 331.969 0 347.197c0 15.232 5.325 28.172 15.985 38.828 10.662 10.657 23.606 15.988 38.831 15.988 15.227 0 28.168-5.331 38.828-15.988 10.656-10.656 15.986-23.596 15.986-38.828 0-15.229-5.33-28.171-15.986-38.827-10.657-10.657-23.598-15.988-38.828-15.988zM181.01 221.002c-21.51-21.698-46.158-38.97-73.948-51.816-27.79-12.85-56.914-20.511-87.366-22.985h-1.425c-4.949 0-9.042 1.619-12.275 4.854C1.997 154.477 0 158.953 0 164.472v38.543c0 4.757 1.569 8.85 4.708 12.279 3.14 3.429 7.089 5.332 11.848 5.708 43.586 4.189 80.845 21.752 111.773 52.678 30.93 30.926 48.49 68.187 52.677 111.771.382 4.764 2.284 8.712 5.712 11.847 3.427 3.148 7.517 4.72 12.275 4.72h38.545c5.517 0 9.989-1.995 13.415-5.996 3.621-3.812 5.236-8.381 4.863-13.709-2.478-30.447-10.14-59.573-22.987-87.361-12.846-27.792-30.121-52.438-51.819-73.95z"></path><path d="M367.728 239.701c-20.365-45.585-48.345-86.078-83.936-121.482-35.405-35.594-75.896-63.572-121.485-83.939C116.723 13.917 68.996 2.494 19.126.02h-.855c-4.949 0-9.136 1.713-12.563 5.14C1.903 8.583 0 12.964 0 18.294v40.825c0 4.76 1.667 8.897 4.996 12.419 3.33 3.523 7.373 5.376 12.132 5.57 40.924 2.478 79.799 12.188 116.63 29.127 36.83 16.94 68.806 38.972 95.93 66.09 27.118 27.123 49.149 59.101 66.089 95.931 16.94 36.836 26.557 75.705 28.839 116.627.195 4.764 2.046 8.809 5.564 12.139 3.524 3.329 7.762 4.999 12.71 4.999h40.823c5.331 0 9.701-1.902 13.134-5.715 3.809-3.806 5.517-8.274 5.144-13.415-2.471-49.874-13.898-97.6-34.263-143.19z"></path></g></svg></a></div><a class="tag all" href="#">ALL (254)</a>
<div class="tag-list"><a class="tag " data-tag="Chaos-Mesh" href="#Chaos-Mesh">Chaos Mesh (7)
                </a><a class="tag " data-tag="Committer" href="#Committer">Committer (3)
                </a><a class="tag " data-tag="Contributor" href="#Contributor">Contributor (9)
                </a><a class="tag " data-tag="DM" href="#DM">DM (2)
                </a><a class="tag " data-tag="DM-源码阅读" href="#DM-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb">DM 源码阅读 (10)
                </a><a class="tag " data-tag="Go" href="#Go">Go (3)
                </a><a class="tag " data-tag="HTAP" href="#HTAP">HTAP (3)
                </a><a class="tag " data-tag="Hackathon" href="#Hackathon">Hackathon (4)
                </a><a class="tag " data-tag="K8s" href="#K8s">K8s (2)
                </a><a class="tag " data-tag="Key-Visualizer" href="#Key-Visualizer">Key Visualizer (2)
                </a><a class="tag " data-tag="Kubernetes" href="#Kubernetes">Kubernetes (3)
                </a><a class="tag " data-tag="Linux" href="#Linux">Linux (4)
                </a><a class="tag " data-tag="MVCC" href="#MVCC">MVCC (2)
                </a><a class="tag " data-tag="MySQL" href="#MySQL">MySQL (2)
                </a><a class="tag " data-tag="PD" href="#PD">PD (5)
                </a><a class="tag " data-tag="Percolator" href="#Percolator">Percolator (2)
                </a><a class="tag " data-tag="PingCAP" href="#PingCAP">PingCAP (2)
                </a><a class="tag " data-tag="Prometheus" href="#Prometheus">Prometheus (3)
                </a><a class="tag " data-tag="Raft" href="#Raft">Raft (11)
                </a><a class="tag " data-tag="RocksDB" href="#RocksDB">RocksDB (3)
                </a><a class="tag " data-tag="Rust" href="#Rust">Rust (5)
                </a><a class="tag " data-tag="SQL" href="#SQL">SQL (6)
                </a><a class="tag " data-tag="Spanner" href="#Spanner">Spanner (2)
                </a><a class="tag sel" data-tag="TiDB" href="#TiDB">TiDB (79)
                </a><a class="tag " data-tag="TiDB-4.0-新特性" href="#TiDB-4.0-%e6%96%b0%e7%89%b9%e6%80%a7">TiDB 4.0 新特性 (11)
                </a><a class="tag " data-tag="TiDB-Binlog" href="#TiDB-Binlog">TiDB Binlog (5)
                </a><a class="tag " data-tag="TiDB-Binlog-源码阅读" href="#TiDB-Binlog-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb">TiDB Binlog 源码阅读 (9)
                </a><a class="tag " data-tag="TiDB-Ecosystem-Tools" href="#TiDB-Ecosystem-Tools">TiDB Ecosystem Tools (3)
                </a><a class="tag " data-tag="TiDB-Operator" href="#TiDB-Operator">TiDB Operator (5)
                </a><a class="tag " data-tag="TiDB-性能挑战赛" href="#TiDB-%e6%80%a7%e8%83%bd%e6%8c%91%e6%88%98%e8%b5%9b">TiDB 性能挑战赛 (2)
                </a><a class="tag " data-tag="TiDB-易用性挑战赛" href="#TiDB-%e6%98%93%e7%94%a8%e6%80%a7%e6%8c%91%e6%88%98%e8%b5%9b">TiDB 易用性挑战赛 (4)
                </a><a class="tag " data-tag="TiDB-源码阅读" href="#TiDB-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb">TiDB 源码阅读 (24)
                </a><a class="tag " data-tag="TiFlash" href="#TiFlash">TiFlash (7)
                </a><a class="tag " data-tag="TiKV" href="#TiKV">TiKV (28)
                </a><a class="tag " data-tag="TiKV-源码解析" href="#TiKV-%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90">TiKV 源码解析 (20)
                </a><a class="tag " data-tag="TiSpark" href="#TiSpark">TiSpark (4)
                </a><a class="tag " data-tag="WebAssembly" href="#WebAssembly">WebAssembly (2)
                </a><a class="tag " data-tag="gRPC" href="#gRPC">gRPC (2)
                </a><a class="tag " data-tag="事务" href="#%e4%ba%8b%e5%8a%a1">事务 (4)
                </a><a class="tag " data-tag="优化器" href="#%e4%bc%98%e5%8c%96%e5%99%a8">优化器 (2)
                </a><a class="tag " data-tag="分布式系统前沿技术" href="#%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e5%89%8d%e6%b2%bf%e6%8a%80%e6%9c%af">分布式系统前沿技术 (4)
                </a><a class="tag " data-tag="分布式系统测试" href="#%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e6%b5%8b%e8%af%95">分布式系统测试 (3)
                </a><a class="tag " data-tag="备份恢复" href="#%e5%a4%87%e4%bb%bd%e6%81%a2%e5%a4%8d">备份恢复 (2)
                </a><a class="tag " data-tag="工具" href="#%e5%b7%a5%e5%85%b7">工具 (4)
                </a><a class="tag " data-tag="性能" href="#%e6%80%a7%e8%83%bd">性能 (4)
                </a><a class="tag " data-tag="数据同步" href="#%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5">数据同步 (2)
                </a><a class="tag sel" data-tag="最佳实践" href="#%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5">最佳实践 (6)
                </a><a class="tag " data-tag="架构" href="#%e6%9e%b6%e6%9e%84">架构 (6)
                </a><a class="tag " data-tag="版本" href="#%e7%89%88%e6%9c%ac">版本 (2)
                </a><a class="tag " data-tag="社区" href="#%e7%a4%be%e5%8c%ba">社区 (102)
                </a><a class="tag " data-tag="社区动态" href="#%e7%a4%be%e5%8c%ba%e5%8a%a8%e6%80%81">社区动态 (29)
                </a><a class="tag " data-tag="集群调度" href="#%e9%9b%86%e7%be%a4%e8%b0%83%e5%ba%a6">集群调度 (2)
                </a>
</div>
</div>
<div class="archive">
<div class="content markdown-body">
<h1 class="title">TiDB 最佳实践系列（五）Java 数据库应用开发指南</h1>
<ul class="blog-post-meta">
<li class="meta-item">
<img alt="Date icon" src="/images/svgs/icon-date.svg"/>Wed, Nov 6, 2019</li>
<li class="meta-item">
<img alt="Pen icon" src="/images/svgs/icon-writer.svg"/>Su Li, Zhang Ming</li>
</ul>
<div class="blog-text"><p>Java 是当前非常流行的开发语言，很多 TiDB 用户的业务层都是使用 Java 开发的，本文将从 Java 数据库交互组件开发的角度出发，介绍各组件的推荐配置和推荐使用方式，希望能帮助 Java 开发者在使用 TiDB 时能更好的发挥数据库性能。</p>
<h2 id="java-">Java 应用中的数据库相关组件</h2>
<p>通常 Java 应用中和数据库相关的常用组件有：</p>
<ul>
<li>
<p>网络协议：客户端通过标准 <a href="https://dev.mysql.com/doc/internals/en/client-server-protocol.html">MySQL 协议</a> 和 TiDB 进行网络交互。</p>
</li>
<li>
<p>JDBC API 及实现：Java 应用通常使用 <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/jdbc/">JDBC (Java Database Connectivity)</a> 来访问数据库。JDBC 定义了访问数据库 API，而 JDBC 实现完成标准 API 到 MySQL 协议的转换，常见的 JDBC 实现是 <a href="https://github.com/mysql/mysql-connector-j">MySQL Connector/J</a>，此外有些用户可能使用 <a href="https://mariadb.com/kb/en/library/about-mariadb-connector-j/#about-mariadb-connectorj">MariaDB Connector/J</a>。</p>
</li>
<li>
<p>数据库连接池：为了避免每次创建连接，通常应用会选择使用数据库连接池来复用连接，JDBC <a href="https://docs.oracle.com/javase/8/docs/api/javax/sql/DataSource.html">DataSource</a> 定义了连接池 API，开发者可根据实际需求选择使用某种开源连接池实现。</p>
</li>
<li>
<p>数据访问框架：应用通常选择通过数据访问框架（<a href="http://www.mybatis.org/mybatis-3/zh/index.html">MyBatis</a>、<a href="https://hibernate.org/">Hibernate</a>）的封装来进一步简化和管理数据库访问操作。</p>
</li>
<li>
<p>业务实现：业务逻辑控制着何时发送和发送什么指令到数据库，其中有些业务会使用 <a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/transaction.html">Spring Transaction</a> 切面来控制管理事务的开始和提交逻辑。</p>
</li>
</ul>
<p><img alt="" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/best-practice-java/java-practice-1.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>如上图所示，应用可能使用 Spring Transaction 来管理控制事务非手工启停，通过类似 MyBatis 的数据访问框架管理生成和执行 SQL，通过连接池获取已池化的长连接，最后通过 JDBC 接口调用实现通过 MySQL 协议和 TiDB 完成交互。</p>
<p>接下来将分别介绍使用各个组件时可能需要关注的问题。</p>
<h2 id="jdbc">JDBC</h2>
<p>Java 应用尽管可以选择在不同的框架中封装，但在最底层一般会通过调用 JDBC 来与数据库服务器进行交互。对于 JDBC，需要关注的主要有：API 的选择和 API Implementer 的参数配置。</p>
<h3 id="1-jdbc-api">1. JDBC API</h3>
<p>对于基本的 JDBC API 使用可以参考 <a href="https://docs.oracle.com/javase/tutorial/jdbc/">JDBC 官方教程</a>，本文主要强调几个比较重要的 API 选择。</p>
<h4 id="11--prepare-api">1.1 使用 Prepare API</h4>
<p>对于 OLTP 场景，程序发送给数据库的 SQL 语句在去除参数变化后都是可穷举的某几类，因此建议使用 <a href="https://docs.oracle.com/javase/tutorial/jdbc/basics/prepared.html">预处理语句 (Prepared Statements)</a> 代替普通的 <a href="https://docs.oracle.com/javase/tutorial/jdbc/basics/processingsqlstatements.html#executing_queries">文本执行</a>，并复用 Prepared Statements 来直接执行，从而避免 TiDB 重复解析的开销。</p>
<p>目前多数上层框架都会调用 Prepare API 进行 SQL 执行，如果直接使用 JDBC API 进行开发，注意选择使用 Prepare API。</p>
<p>另外需要注意 MySQL Connector/J 实现中默认只会做客户端的语句预处理，会将 <code>?</code> 在客户端替换后以文本形式发送到客户端，所以除了要使用 Prepare API，还需要在 JDBC 连接参数中配置 <code>useServerPrepStmts = true</code>，才能在 TiDB 服务器端进行语句预处理（下面参数配置章节有详细介绍）。</p>
<h4 id="12--batch-">1.2 使用 Batch 批量插入更新</h4>
<p>对于批量插入更新，如果插入记录较多，可以选择使用 <a href="https://www.tutorialspoint.com/jdbc/jdbc-batch-processing">addBatch/executeBatch API</a>。通过 <code>addBatch</code> 的方式将多条 SQL 的插入更新记录先缓存在客户端，然后在 <code>executeBatch</code> 时一起发送到数据库服务器。</p>
<blockquote>
<p>注意：</p>
<p>对于 MySQL Connector/J 实现，默认 Batch 只是将多次 <code>addBatch</code> 的 SQL 发送时机延迟到调用 <code>executeBatch</code> 的时候，但实际网络发送还是会一条条的发送，通常不会降低与数据库服务器的网络交互次数。</p>
<p>如果希望 Batch 网络发送批量插入，需要在 JDBC 连接参数中配置 <code>rewriteBatchedStatements=true</code>（下面参数配置章节有详细介绍）。</p>
</blockquote>
<h4 id="13--streamingresult-">1.3 使用 StreamingResult 流式获取执行结果</h4>
<p>一般情况下，为提升执行效率，JDBC 会默认提前获取查询结果并将其保存在客户端内存中。但在查询返回超大结果集的场景中，客户端会希望数据库服务器减少向客户端一次返回的记录数，等客户端在有限内存处理完一部分后再去向服务器要下一批。</p>
<p>在 JDBC 中通常有以下两种处理方式：</p>
<ul>
<li>
<p>设置 <a href="https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-reference-implementation-notes.html#ResultSet"><code>FetchSize</code> 为 <code>Integer.MIN_VALUE</code></a> 让客户端不缓存，客户端通过 <code>StreamingResult</code> 的方式从网络连接上流式读取执行结果。</p>
</li>
<li>
<p>使用 Cursor Fetch 首先需 <a href="http://makejavafaster.blogspot.com/2015/06/jdbc-fetch-size-performance.html">设置 <code>FetchSize</code></a> 为正整数且在 JDBC URL 中配置 <code>useCursorFetch=true</code>。</p>
</li>
</ul>
<p>TiDB 中同时支持两种方式，但更推荐使用第一种将 <code>FetchSize</code> 设置为 <code>Integer.MIN_VALUE</code> 的方式，比第二种功能实现更简单且执行效率更高。</p>
<h3 id="2-mysql-jdbc-">2. MySQL JDBC 参数</h3>
<p>JDBC 实现通常通过 JDBC URL 参数的形式来提供实现相关的配置。这里以 MySQL 官方的 Connector/J 来介绍 <a href="https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-reference-configuration-properties.html">参数配置</a>（如果使用的是 MariaDB，可以参考 <a href="https://mariadb.com/kb/en/library/about-mariadb-connector-j/#optional-url-parameters">MariaDB 的类似配置</a>）。因为配置项较多，这里主要关注几个可能影响到性能的参数。</p>
<h4 id="21-prepare-">2.1 Prepare 相关参数</h4>
<h5 id="useserverprepstmts">useServerPrepStmts</h5>
<p>默认情况下，<code>useServerPrepStmts</code> 为 false，即尽管使用了 Prepare API，也只会在客户端做 “prepare”。因此为了避免服务器重复解析的开销，如果同一条 SQL 语句需要多次使用 Prepare API，则建议设置该选项为 true。</p>
<p>在 TiDB 监控中可以通过 <code>Query Summary &gt; QPS By Instance</code> 查看请求命令类型，如果请求中 <code>COM_QUERY</code> 被 <code>COM_STMT_EXECUTE</code> 或 <code>COM_STMT_PREPARE</code> 代替即生效。</p>
<h5 id="cacheprepstmts">cachePrepStmts</h5>
<p>虽然 <code>useServerPrepStmts=true</code> 能让服务端执行 prepare 语句，但默认情况下客户端每次执行完后会 close prepared 的语句，并不会复用，这样 prepare 效率甚至不如文本执行。所以建议开启 <code>useServerPrepStmts=true</code> 后同时配置 <code>cachePrepStmts=true</code>，这会让客户端缓存 prepare 语句。</p>
<p>在 TiDB 监控中可以通过 <code>Query Summary &gt; QPS By Instance</code> 查看请求命令类型，如果类似下图，请求中 <code>COM_STMT_EXECUTE</code> 数目远远多于 <code>COM_STMT_PREPARE</code> 即生效。</p>
<p><img alt="" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/best-practice-java/java-practice-2.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>另外，通过 <code>useConfigs=maxPerformance</code> 配置会同时配置多个参数，其中也包括 <code>cachePrepStmts=true</code>。</p>
<h5 id="prepstmtcachesqllimit">prepStmtCacheSqlLimit</h5>
<p>在配置 <code>cachePrepStmts</code> 后还需要注意 <code>prepStmtCacheSqlLimit</code> 配置（默认为 256），该配置控制客户端缓存 prepare 语句的最大长度，超过该长度将不会被缓存。</p>
<p>在一些场景 SQL 的长度可能超过该配置，导致 prepared SQL 不能复用，建议根据应用 SQL 长度情况决定是否需要调大该值。</p>
<p>在 TiDB 监控中通过 <code>Query Summary &gt; QPS by Instance</code> 查看请求命令类型，如果已经配置了 <code>cachePrepStmts=true</code>，但 <code>COM_STMT_PREPARE</code> 还是和 <code>COM_STMT_EXECUTE</code> 基本相等且有 <code>COM_STMT_CLOSE</code>，需要检查这个配置项是否设置得太小。</p>
<h5 id="prepstmtcachesize">prepStmtCacheSize</h5>
<p><code>prepStmtCacheSize</code> 控制缓存的 prepare 语句数目（默认为 25），如果应用需要 prepare 的 SQL 种类很多且希望复用 prepare 语句，可以调大该值。</p>
<p>和上一条类似，在监控中通过 <code>Query Summary &gt; QPS by Instance</code> 查看请求中 <code>COM_STMT_EXECUTE</code> 数目是否远远多于 <code>COM_STMT_PREPARE</code> 来确认是否正常。</p>
<h4 id="22-batch-">2.2 Batch 相关参数</h4>
<p>在进行 batch 写入处理时推荐配置 <code>rewriteBatchedStatements=true</code>，在已经使用 <code>addBatch</code> 或 <code>executeBatch</code> 后默认 JDBC 还是会一条条 SQL 发送，例如：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">pstmt <span style="color:#f92672">=</span> prepare<span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">“</span>insert into <span style="color:#a6e22e">t</span> <span style="color:#f92672">(</span>a<span style="color:#f92672">)</span> values<span style="color:#f92672">(</span><span style="color:#f92672">?</span><span style="color:#f92672">)</span><span style="color:#960050;background-color:#1e0010">”</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
pstmt<span style="color:#f92672">.</span><span style="color:#a6e22e">setInt</span><span style="color:#f92672">(</span>1<span style="color:#f92672">,</span> 10<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
pstmt<span style="color:#f92672">.</span><span style="color:#a6e22e">addBatch</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
pstmt<span style="color:#f92672">.</span><span style="color:#a6e22e">setInt</span><span style="color:#f92672">(</span>1<span style="color:#f92672">,</span> 11<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
pstmt<span style="color:#f92672">.</span><span style="color:#a6e22e">addBatch</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
pstmt<span style="color:#f92672">.</span><span style="color:#a6e22e">setInt</span><span style="color:#f92672">(</span>1<span style="color:#f92672">,</span> 12<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
pstmt<span style="color:#f92672">.</span><span style="color:#a6e22e">executeBatch</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><p>虽然使用了 batch 但发送到 TiDB 语句还是单独的多条 insert：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">insert into t(a) values(10);
insert into t(a) values(11);
insert into t(a) values(12);
</code></pre></div><p>如果设置 <code>rewriteBatchedStatements=true</code>，发送到 TiDB 的 SQL 将是：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">insert into t(a) values(10),(11),(12);
</code></pre></div><p>需要注意的是，insert 语句的改写，只能将多个 values 后的值拼接成一整条 SQL，insert 语句如果有其他差异将无法被改写。 例如：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">insert into t (a) values (10) on duplicate key update a = 10;
insert into t (a) values (11) on duplicate key update a = 11;
insert into t (a) values (12) on duplicate key update a = 12;
</code></pre></div><p>将无法被改写成一条语句。该例子中，如果将 SQL 改写成如下形式：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">insert into t (a) values (10) on duplicate key update a = values(a);
insert into t (a) values (11) on duplicate key update a = values(a);
insert into t (a) values (12) on duplicate key update a = values(a);
</code></pre></div><p>即可满足改写条件，最终被改写成：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">insert into t (a) values (10), (11), (12) on duplicate key update a = values(a);
</code></pre></div><p>批量更新时如果有 3 处或 3 处以上更新，则 SQL 语句会改写为 multiple-queries 的形式并发送，这样可以有效减少客户端到服务器的请求开销，但副作用是会产生较大的 SQL 语句，例如这样：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">update t set a = 10 where id = 1; update t set a = 11 where id = 2; update t set a = 12 where id = 3;
</code></pre></div><p>另外因为一个 <a href="https://bugs.mysql.com/bug.php?id=96623">客户端 bug</a>，不建议在批量 insert 以外的场景设置 <code>rewriteBatchedStatements=true</code>。</p>
<h4 id="23-">2.3 执行前检查参数</h4>
<p>通过监控可能会发现，虽然业务只向集群进行 insert 操作，却看到有很多多余的 select 语句。通常这是因为 JDBC 发送了一些查询设置类的 SQL 语句（例如 s<code>elect @@session.transaction_read_only</code>）。这些 SQL 对 TiDB 无用，推荐配置 <code>useConfigs=maxPerformance</code> 来避免额外开销。</p>
<p><code>useConfigs=maxPerformance</code> 会包含一组配置：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">cacheServerConfiguration=true
useLocalSessionState=true
elideSetAutoCommits=true
alwaysSendSetIsolation=false
enableQueryTimeouts=false
</code></pre></div><p>配置后查看监控可以看到多余语句减少。</p>
<h2 id="heading">连接池</h2>
<p>TiDB (MySQL) 连接建立是比较昂贵的操作（至少对于 OLTP），除了建立 TCP 连接外还需要进行连接鉴权操作，所以客户端通常会把 TiDB (MySQL) 连接保存到连接池中进行复用。</p>
<p>Java 的连接池实现很多（比如，<a href="https://github.com/brettwooldridge/HikariCP">HikariCP</a>, <a href="https://tomcat.apache.org/tomcat-7.0-doc/jdbc-pool.html">tomcat-jdbc</a>, <a href="https://github.com/alibaba/druid">durid</a>, <a href="https://www.mchange.com/projects/c3p0/">c3p0</a>, <a href="https://commons.apache.org/proper/commons-dbcp/">dbcp</a>），TiDB 不会限定使用的连接池，应用可以根据业务特点自行选择连接池实现。</p>
<h3 id="1-">1. 连接数配置</h3>
<p>比较常见的是应用需要根据自身情况配置合适的连接池大小，以 HikariCP 为例：</p>
<ul>
<li>
<p><code>maximumPoolSize</code>：连接池最大连接数，配置过大会导致 TiDB 消耗资源维护无用连接，配置过小则会导致应用获取连接变慢，所以需根据应用自身特点配置合适的值，可参考 <a href="https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing">这篇文章</a>。</p>
</li>
<li>
<p><code>minimumIdle</code>：连接池最小空闲连接数，主要用于在应用空闲时存留一些连接以应对突发请求，同样是需要根据业务情况进行配置。</p>
</li>
</ul>
<p>应用在使用连接池时需要注意连接使用完成后归还连接，推荐应用使用对应的连接池相关监控（如 <code>metricRegistry</code>），通过监控能及时定位连接池问题。</p>
<h3 id="2-">2. 探活配置</h3>
<p>连接池维护到 TiDB 的长连接，TiDB 默认不会主动关闭客户端连接（除非报错），但一般客户端到 TiDB 之间还会有 LVS 或 HAProxy 之类的网络代理，它们通常会在连接空闲一定时间后主动清理连接。除了注意代理的 idle 配置外，连接池还需要进行保活或探测连接。</p>
<p>如果常在 Java 应用中看到以下错误：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">The last packet sent successfully to the server was 3600000 milliseconds ago. The driver has not received any packets from the server. com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: Communications link failure
</code></pre></div><p>如果 <code>n milliseconds ago</code> 中的 <code>n</code> 是 <code>0</code> 或很小的值，则通常是执行的 SQL 导致 TiDB 异常退出引起的报错，推荐查看 TiDB stderr 日志；如果 <code>n</code> 是一个非常大的值（比如这里的 3600000），很可能是因为这个连接空闲太久然后被中间 proxy 关闭了，通常解决方式除了调大 proxy 的 idle 配置，还可以让连接池：</p>
<ul>
<li>
<p>每次使用连接前检查连接是否可用。</p>
</li>
<li>
<p>使用单独线程定期检查连接是否可用。</p>
</li>
<li>
<p>定期发送 test query 保活连接。</p>
</li>
</ul>
<p>不同的连接池实现可能会支持其中一种或多种方式，可以查看所使用的连接池文档来寻找对应配置。</p>
<h2 id="heading-1">数据访问框架</h2>
<p>业务应用通常会使用某种数据访问框架来简化数据库的访问。</p>
<h3 id="1-mybatis">1. MyBatis</h3>
<p><a href="http://www.mybatis.org/mybatis-3/">MyBatis</a> 是目前比较流行的 Java 数据访问框架，主要用于管理 SQL 并完成结果集和 Java 对象的来回映射工作。MyBatis 和 TiDB 兼容性很好，从历史 issue 可以看出 MyBatis 很少出现问题。这里主要关注如下几个配置。</p>
<h4 id="11-mapper-">1.1 Mapper 参数</h4>
<p>MyBatis 的 Mapper 中支持两种参数：</p>
<ul>
<li>
<p><code>select 1 from t where id = #{param1}</code> 会作为 prepare 语句转换为 <code>select 1 from t where id = ?</code> 进行 prepare， 并使用实际参数来复用执行，通过配合前面的 Prepare 连接参数能获得最佳性能。</p>
</li>
<li>
<p><code>select 1 from t where id = ${param2}</code> 会做文本替换为 <code>select 1 from t where id = 1</code> 执行，如果这条语句被 prepare 成了不同参数，可能会导致 TiDB 缓存大量的 prepare 语句，并且这种方式执行 SQL 有注入安全风险。</p>
</li>
</ul>
<h4 id="12--sql-batch">1.2 动态 SQL Batch</h4>
<p>要支持将多条 insert 语句自动重写为 <code>insert ... values(...), (...), ...</code> 的形式，除了前面所说的在 JDBC 配置 <code>rewriteBatchedStatements=true</code> 外，MyBatis 还可以使用动态 SQL 的 <a href="http://www.mybatis.org/mybatis-3/dynamic-sql.html#foreach">foreach 语法</a> 来半自动生成 batch insert。比如下面的 mapper:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;insert</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">"insertTestBatch"</span> <span style="color:#a6e22e">parameterType=</span><span style="color:#e6db74">"java.util.List"</span> <span style="color:#a6e22e">fetchSize=</span><span style="color:#e6db74">"1"</span><span style="color:#f92672">&gt;</span>
  insert into test
   (id, v1, v2)
  values
  <span style="color:#f92672">&lt;foreach</span> <span style="color:#a6e22e">item=</span><span style="color:#e6db74">"item"</span> <span style="color:#a6e22e">index=</span><span style="color:#e6db74">"index"</span> <span style="color:#a6e22e">collection=</span><span style="color:#e6db74">"list"</span> <span style="color:#a6e22e">separator=</span><span style="color:#e6db74">","</span><span style="color:#f92672">&gt;</span>
  (
   #{item.id}, #{item.v1}, #{item.v2}
  )
  <span style="color:#f92672">&lt;/foreach&gt;</span>
  on duplicate key update v2 = v1 + values(v1)
<span style="color:#f92672">&lt;/insert&gt;</span>
</code></pre></div><p>会生成一个 <code>insert on duplicate key update</code> 语句，values 后面的 <code>(?, ?, ?)</code> 数目是根据传入的 list 个数决定，最终效果和使用 <code>rewriteBatchStatements=true</code> 类似，可以有效减少客户端和 TiDB 的网络交互次数，同样需要注意 prepare 后超过 <code>prepStmtCacheSqlLimit</code> 限制导致不缓存 prepare 语句的问题。</p>
<h4 id="13-streaming-">1.3 Streaming 结果</h4>
<p>前面介绍了在 JDBC 中如何使用流式读取结果，除了 JDBC 相应的配置外，在 MyBatis 中如果希望读取超大结果集合也需要注意：</p>
<ul>
<li>
<p>可以通过在 mapper 配置中对单独一条 SQL 设置 <code>fetchSize</code>（见上一段代码段），效果等同于调用 JDBC <code>setFetchSize</code>。</p>
</li>
<li>
<p>可以使用带 <code>ResultHandler</code> 的查询接口来避免一次获取整个结果集。</p>
</li>
<li>
<p>可以使用 <code>Cursor</code> 类来进行流式读取。</p>
</li>
</ul>
<p>对于使用 xml 配置映射，可以通过在映射 <code>&lt;select&gt;</code> 部分配置 <code>fetchSize="-2147483648"</code>(<code>Integer.MIN_VALUE</code>) 来流式读取结果。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;select</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">"getAll"</span> <span style="color:#a6e22e">resultMap=</span><span style="color:#e6db74">"postResultMap"</span> <span style="color:#a6e22e">fetchSize=</span><span style="color:#e6db74">"-2147483648"</span><span style="color:#f92672">&gt;</span>
  select * from post;
<span style="color:#f92672">&lt;/select&gt;</span>
</code></pre></div><p>而使用代码配置映射，则可以使用 <code>@Options(fetchSize = Integer.MIN_VALUE)</code> 并返回 <code>Cursor</code> 从而让 SQL 结果能被流式读取。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Select</span><span style="color:#f92672">(</span><span style="color:#e6db74">"select * from post"</span><span style="color:#f92672">)</span>
<span style="color:#a6e22e">@Options</span><span style="color:#f92672">(</span>fetchSize <span style="color:#f92672">=</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">MIN_VALUE</span><span style="color:#f92672">)</span>
Cursor<span style="color:#f92672">&lt;</span>Post<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">queryAllPost</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><h3 id="2-executortype">2. ExecutorType</h3>
<p>在 <code>openSession</code> 的时候可以选择 <code>ExecutorType</code>，MyBatis 支持三种 <code>executor</code>：</p>
<ul>
<li>
<p><code>Simple</code>：每次执行都会向 JDBC 进行 prepare 语句的调用（如果 JDBC 配置有开启 <code>cachePrepStmts</code>，重复的 prepare 语句会复用）。</p>
</li>
<li>
<p><code>Reuse</code>：在 <code>executor</code> 中缓存 prepare 语句，这样不用 JDBC 的 <code>cachePrepStmts</code> 也能减少重复 prepare 语句的调用。</p>
</li>
<li>
<p><code>Batch</code>：每次更新只有在 <code>addBatch</code> 到 query 或 commit 时才会调用 <code>executeBatch</code> 执行，如果 JDBC 层开启了 <code>rewriteBatchStatements</code>，则会尝试改写，没有开启则会一条条发送。</p>
</li>
</ul>
<p>通常默认值是 <code>Simple</code>，需要在调用 <code>openSession</code> 时改变 <code>ExecutorType</code>。如果是 Batch 执行，会遇到事务中前面的 update 或 insert 都非常快，而在读数据或 commit 事务时比较慢的情况，这实际上是正常的，在排查慢 SQL 时需要注意。</p>
<h2 id="spring-transaction">Spring Transaction</h2>
<p>在应用代码中业务可能会通过使用 <a href="https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/transaction.html">Spring Transaction</a> 和 AOP 切面的方式来启停事务。</p>
<p>通过在方法定义上添加 <code>@Transactional</code> 注解标记方法，AOP 将会在方法前开启事务，方法返回结果前 commit 事务。如果遇到类似业务，可以通过查找代码 <code>@Transactional</code> 来确定事务的开启和关闭时机。需要特别注意有内嵌的情况，如果发生内嵌，Spring 会根据 <a href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/annotation/Propagation.html">Propagation</a> 配置使用不同的行为，因为 TiDB 未支持 savepoint，所以不支持嵌套事务。</p>
<h2 id="heading-2">排查工具</h2>
<p>在 Java 应用发生问题并且不知道业务逻辑情况下，使用 JVM 强大的排查工具会比较有用。这里简单介绍几个常用工具：</p>
<h3 id="1-jstack">1. jstack</h3>
<p><a href="https://docs.oracle.com/javase/7/docs/technotes/tools/share/jstack.html">jstack</a> 对应于 Go 中的 <code>pprof/goroutine</code>，可以比较方便地排查进程卡死的问题。</p>
<p>通过执行 jstack pid，即可输出目标进程中所有线程的线程 id 和堆栈信息。输出中默认只有 Java 堆栈，如果希望同时输出 JVM 中的 C++ 堆栈，需要加 <code>-m</code> 选项。</p>
<p>通过多次 jstack 可以方便地发现卡死问题（比如：都通过 <code>Mybatis BatchExecutor flush</code> 调用 update）或死锁问题（比如：测试程序都在抢占应用中某把锁导致没发送 SQL）</p>
<p>另外，<code>top -p $PID -H</code> 或者 Java swiss knife 都是常用的查看线程 ID 的方法。通过 <code>printf "%x\n" pid</code> 把线程 ID 转换成 16 进制，然后去 jstack 输出结果中找对应线程的栈信息，可以定位“某个线程占用 CPU 比较高，不知道它在执行什么”的问题。</p>
<h3 id="2-jmap--mat">2. jmap &amp; mat</h3>
<p>和 Go 中的 <code>pprof/heap</code> 不同，<a href="https://docs.oracle.com/javase/7/docs/technotes/tools/share/jmap.html">jmap</a> 会将整个进程的内存快照 dump 下来（go 是分配器的采样），然后可以通过另一个工具 <a href="https://www.eclipse.org/mat/">mat</a> 做分析。</p>
<p>通过 mat 可以看到进程中所有对象的关联信息和属性，还可以观察线程运行的状态。比如：我们可以通过 mat 找到当前应用中有多少 MySQL 连接对象，每个连接对象的地址和状态信息是什么。</p>
<p>需要注意 mat 默认只会处理 reachable objects，如果要排查 young gc 问题可以在 mat 配置中设置查看 unreachable objects。另外对于调查 young gc 问题（或者大量生命周期较短的对象）的内存分配，用 Java Flight Recorder 比较方便。</p>
<h3 id="3-trace">3. trace</h3>
<p>线上应用通常无法修改代码，又希望在 Java 中做动态插桩来定位问题，推荐使用 btrace 或 arthas trace。它们可以在不重启进程的情况下动态插入 trace 代码。</p>
<h3 id="4-">4. 火焰图</h3>
<p>Java 应用中获取火焰图较繁琐，可参阅 <a href="http://psy-lob-saw.blogspot.com/2017/02/flamegraphs-intro-fire-for-everyone.html">Java Flame Graphs Introduction: Fire For Everyone!</a> 来手动获取。</p>
<h2 id="heading-3">总结</h2>
<p>本文从常用 Java 数据库交互组件的角度，阐述了开发 Java 应用程序使用 TiDB 的常见问题与解决办法。TiDB 是高度兼容 MySQL 协议的数据库，基于 MySQL 开发的 Java 应用的最佳实践也多适用于 TiDB。如果大家在使用上遇到了任何问题，可以在 <a href="https://asktug.com/">asktug.com</a> 提问，也欢迎更多小伙伴和我们一起分享讨论 Java 应用使用 TiDB 的实践技巧。</p>
</div>
</div><div class="ssba-wrap">
<div class="ssba">
<a class="ssba_mail_share" href="mailto:info@pingcap.com" onclick="trackViews('blog-contact-us', 'mail_to_info_view')" target="_blank">
<svg height="18" viewbox="0 0 14 14" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M7 9L5.268 7.484.316 11.729c.18.167.423.271.691.271h11.986c.267 0 .509-.104.688-.271L8.732 7.484 7 9z"></path><path d="M13.684 2.271A1.007 1.007 0 0 0 12.993 2H1.007c-.267 0-.509.104-.689.273L7 8l6.684-5.729zM0 2.878v8.308l4.833-4.107zM9.167 7.079L14 11.186V2.875z"></path></svg>
</a>
<a class="ssba_wechat_share" data-site="wechat" data-url="https://pingcap.com/blog-cn/best-practice-java/" href="javascript:void(0)" id="wechat_share_btn" onclick="toggleBlogQRCode()">
<svg height="18" viewbox="0 0 31.403 31.404" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"></path><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"></path></svg>
</a>
</div>
</div>
<style type="text/css">
    .fixed-qrcode {
        position: fixed;
        top: 120px;
        right: 105px;
        padding: 10px 15px;
        width: 200px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.9);
        text-align: center;
    }

    .fixed-qrcode p {
        font-size: 14px;
        font-weight: 300;
        line-height: 1.6;
        margin: 8px 0;
        color: #333;
    }

    .fixed-qrcode #close_share_qrcode {
        position: absolute;
        top: 0;
        right: 0;
        width: 30px;
        height: 30px;
        padding: 10px;
    }

    .fixed-qrcode #close_share_qrcode svg {
        display: block;
    }

    .f-hide #share_qrcode {
        visibility: hidden;
        opacity: 0;
    }

    .fixed-qrcode #share_qrcode {
        visibility: visible;
        opacity: 1;
        height: 128px;
        transition: visibility 0s linear 0s, opacity .3s 0s;
        -webkit-transition: visibility 0s linear 0s, opacity .3s 0s;
    }

    #share_qrcode img {
        margin: 0 auto;
    }
</style>
<div class="f-hide" id="share_qrcode_outer">
<i id="close_share_qrcode"><svg viewbox="0 0 224.512 224.512" xmlns="http://www.w3.org/2000/svg"><path d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z" fill="#010002"></path></svg></i>
<p>分享到微信</p>
<div id="share_qrcode"></div>
<p>打开微信，使用 “扫一扫” 即可将网页分享至朋友圈。</p>
</div>
<script src="/js/vendor/qrcode.min.js" type="text/javascript"></script>
<script type="text/javascript">
    window.onload = function() {
        var close_share_qrcode_btn = document.getElementById('close_share_qrcode')
        var wechat_share_btn = document.getElementById('wechat_share_btn')
        var blog_url = wechat_share_btn.getAttribute('data-url')

        window.pingcap_blog_qrcode = new QRCode(
            document.getElementById('share_qrcode'),
            {
            text: blog_url,
            width: 128,
            height: 128,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
            }
        )

        close_share_qrcode_btn.addEventListener('click', function(event) {
            document
            .getElementById('share_qrcode_outer')
            .setAttribute('class', 'f-hide')
        })
    }

    function toggleBlogQRCode() {
        var qrcode_wrapper = document.getElementById('share_qrcode_outer')

        if (qrcode_wrapper.getAttribute('class') == 'f-hide') {
            qrcode_wrapper.setAttribute('class', 'fixed-qrcode')
        } else {
            qrcode_wrapper.setAttribute('class', 'f-hide')
        }
    }
</script>
</div>
</div>
</div>
<footer>
<div class="container">
<div class="flex-list-wrap">
<div class="flex-list">
<h4 class="list-title"><strong>产品</strong></h4>
<ul>
<li><a href="/docs-cn/v3.0/" onclick="trackViews('footer-product-tidb', 'docs-cn_view')">TiDB</a></li>
<li><a href="/docs-cn/v3.0/reference/tispark/">TiSpark</a></li>
<li><a href="/docs-cn/v3.0/roadmap/">TiDB 路线图</a></li>
</ul>
</div>
<div class="flex-list">
<h4 class="list-title"><strong>文档</strong></h4>
<ul>
<li><a href="https://docs.pingcap.com/zh/tidb/v4.0/quick-start-with-tidb">快速入门</a></li>
<li><a href="/blog-cn/tidb-best-practice/">最佳实践</a></li>
<li><a href="/docs-cn/stable/faq/tidb/">常见问题解答</a></li>
<li><a href="/docs-cn/stable/reference/tools/user-guide/">TiDB 周边工具</a></li>
<li><a href="https://docs.pingcap.com/zh/tidb/dev/release-notes">版本发布说明</a></li>
</ul>
</div>
<div class="flex-list">
<h4 class="list-title"><strong>资源</strong></h4>
<ul>
<li><a href="/blog-cn/">博客</a></li>
<li><a href="https://github.com/pingcap" target="_blank">GitHub</a></li>
<li><a href="https://book.tidb.io" target="_blank">TiDB in Action</a></li>
<li><a href="https://university.pingcap.com/" onclick="trackViews('footer-source-university', 'pingcap-university_view')" target="_blank">PingCAP
                    University</a></li>
<li><a href="/solutions/intel/" onclick="trackViews('footer-resource-solutions', 'solutions_view')">联合解决方案</a></li>
<li><a href="https://asktug.com/" onclick="trackViews('footer-resource-asktug', 'asktug_view')" target="_blank">Ask TUG</a></li>
</ul>
</div>
<div class="flex-list">
<h4 class="list-title"><strong>公司</strong></h4>
<ul>
<li><a href="/about-cn/">关于我们</a></li>
<li><a href="https://job.pingcap.com/" onclick="trackViews('footer-recruit-join', 'recruit-join_view')" target="_blank">招贤纳士</a>
</li>
<li><a href="/about-cn/news/">新闻报道</a></li>
<li><a href="/zh/privacy-policy/">隐私申明</a></li>
</ul>
</div>
</div>
<div class="contact-list-wrap">
<div class="flex-list">
<h4 class="list-title"><strong>联系我们</strong></h4>
<ul>
<li><a class="twitter" href="https://twitter.com/PingCAP" target="_blank"><svg height="19" viewbox="0 0 612 612" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"></path></svg> Twitter</a></li>
<li><a class="linkedin" href="https://www.linkedin.com/company/pingcap/" target="_blank"><svg height="16" viewbox="0 0 438.536 438.535" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"></path></svg> LinkedIn</a></li>
<li><a class="reddit" href="https://www.reddit.com/r/TiDB/" target="_blank"><svg height="18" viewbox="0 0 279.748 279.748" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"></path></svg> Reddit</a></li>
<li><a class="google-plus" href="https://groups.google.com/forum/#!forum/tidb-user" target="_blank"><svg height="20" viewbox="0 0 491.858 491.858" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"></path></svg> Google Group</a></li>
<li><a class="stack-overflow" href="https://stackoverflow.com/questions/tagged/tidb" target="_blank"><svg height="17" viewbox="0 0 547.597 547.597" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"></path><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"></path><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"></path></svg> Stack Overflow</a></li>
<li id="wechat"><a class="wechat" href="javascript:void(0)"><svg height="17" viewbox="0 0 31.403 31.404" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"></path><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"></path></svg> 微信公众号</a> <div class="qr_code_outer f-hide f-tc">
<div class="qr_code">
<i id="close_qrcode"><svg viewbox="0 0 224.512 224.512" xmlns="http://www.w3.org/2000/svg"><path d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z" fill="#010002"></path></svg></i>
<img alt="Wechat qrCode" class="qr_code_img" id="js_qr_code_img" src="/images/wechat-qrcode.jpg"/>
<p>微信扫一扫<br/> 微信ID：pingcap2015</p>
</div>
</div>
</li>
</ul>
</div>
<div class="subscribe" id="subscribe-pc"></div>
</div>
</div>
<div class="container copyright-container">
<p class="copyright">© 2020 北京平凯星辰科技发展有限公司</p>
<a class="copyright-btn-lang copyright-btn-en" href="/blog" id="lang">English</a>
<a class="prepared-num" href="http://www.beian.miit.gov.cn/">京 ICP 备 16046278 号 - 2</a>
</div>
</footer>
<button class="back-to-top" type="button"><svg height="512" viewbox="0 0 284.929 284.929" width="512" xmlns="http://www.w3.org/2000/svg"><path d="M282.082 195.285L149.028 62.24c-1.901-1.903-4.088-2.856-6.562-2.856s-4.665.953-6.567 2.856L2.856 195.285C.95 197.191 0 199.378 0 201.853c0 2.474.953 4.664 2.856 6.566l14.272 14.271c1.903 1.903 4.093 2.854 6.567 2.854s4.664-.951 6.567-2.854l112.204-112.202 112.208 112.209c1.902 1.903 4.093 2.848 6.563 2.848 2.478 0 4.668-.951 6.57-2.848l14.274-14.277c1.902-1.902 2.847-4.093 2.847-6.566.001-2.476-.944-4.666-2.846-6.569z" fill="#FFF"></path></svg>
</button>
</div><div class="overlay"></div><script src="https://download.pingcap.com/js/jquery.min.js"></script><script src="/js/vendor/lazyload.min.js" type="text/javascript"></script>
<script src="/js/doc.js" type="text/javascript"></script>
<script src="/js/anchor.js" type="text/javascript"></script><script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script crossorigin="anonymous" integrity="sha384-jbFinqIbKkHNg+QL+yxB4VrBC0EAPTuaLGeRT0T+NfEV89YC6u1bKxHLwoo+/xxY" src="https://browser.sentry-cdn.com/5.11.0/bundle.min.js"></script><script>Sentry.init({ 
            dsn: 'https://3f28ed393c5545daa74496b3cdb2e9ba@sentry.io/1887163' 
        });</script></body></html>