<!DOCTYPE html>
<html lang="en"><head>
<meta name="robots" content="noindex"><meta charset="utf-8"/><meta content="IE=edge" http-equiv="X-UA-Compatible"/><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" name="viewport"/>
<script>
window.ga =
    window.ga ||
    function() {
        ;(ga.q = ga.q || []).push(arguments)
    }
ga.l = +new Date()
ga('create', 'UA-99991864-4', 'auto')
ga('send', 'pageview')
</script>
<script async="" src="https://download.pingcap.com/js/ga-analytics.js"></script>
<link href="https://download.pingcap.com/style/github-markdown.css" rel="stylesheet"/>
<link href="/css/doc.css" rel="stylesheet"/>
<title>TiKV 源码解析系列文章（十三）MVCC 数据读取 | PingCAP</title><link href="/images/favicon.ico" rel="icon" type="image/x-icon"/>
<link href="/images/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
<link href="/images/apple-touch-icon.png" rel="apple-touch-icon"/>
<meta content="本文将介绍数据读取的流程。" name="description"/>
<meta content="noodp" name="robots"/>
<meta content="TiDB, MySQL, HTAP, Open Source, Cloud-Native, NewSQL, Aurora Alternative" name="keywords"/>
<meta content="en_US" property="og:locale"/>
<meta content="website" property="og:type"/>
<meta content="TiKV 源码解析系列文章（十三）MVCC 数据读取 | PingCAP" property="og:title"/>
<meta content="本文将介绍数据读取的流程。" property="og:description"/>
<meta content="https://pingcap.com/blog-cn/tikv-source-code-reading-13/" property="og:url"/>
<meta content="MySQL at Scale. No more manual sharding" property="og:site_name"/>
<meta content="/images/pingcap-opengraph.jpg" property="og:image"/>
<meta content="/images/pingcap-opengraph.jpg" property="og:image:secure_url"/><meta content="summary" name="twitter:card"/><meta content="本文将介绍数据读取的流程。" name="twitter:description"/>
<meta content="TiKV 源码解析系列文章（十三）MVCC 数据读取 | PingCAP" name="twitter:title"/>
<meta content="@pingcap" name="twitter:site"/>
<meta content="https://download.pingcap.com/images/pingcap-opengraph.jpg" name="twitter:image"/><meta content="@pingcap" name="twitter:creator"/>
<script type="application/ld+json">
{
    "@context": "http:\/\/schema.org",
    "@type": "WebSite",
    "url": "https:\/\/pingcap.com\/",
    "name": "PingCAP",
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https:\/\/pingcap.com\/?s={search_term_string}",
        "query-input": "required name=search_term_string"
    }
}
</script>
<script>
    (function(){
        var bp = document.createElement('script');
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
<script async="" src="https://accounts.pingcap.com/static/pingcap_sso/js/track.beta.js" type="text/javascript"></script>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.woff" rel="preload" type="font/woff"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.ttf" rel="preload" type="font/ttf"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff" rel="preload" type="font/woff"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.ttf" rel="preload" type="font/ttf"/>
<link as="script" href="https://download.pingcap.com/js/jquery.min.js" rel="preload"/>
<link href="/css/main.css" rel="stylesheet"/>
<link href="https://download.pingcap.com/style/docsearch.min.css" rel="stylesheet"/>
<script type="text/javascript">
var trackOutboundLink = function(url) {
  var redirectTriggered = false
  ga('send', 'event', 'outbound', 'click', url, {
    hitCallback: function() {
      redirectTriggered = true
      document.location = url
    }
  })
  setTimeout(function() {
    if (!redirectTriggered) {
      document.location = url
    }
  }, 1500)
}

var trackViews = function(btn_type, event_category) {
  var event_label = btn_type
  var eventCategory = event_category
  ga('send', 'event', {
    'eventCategory': eventCategory,
    'eventAction': 'click',
    'eventLabel': event_label,
    'transport': 'beacon'
  });
}
</script>
<script>if (location.pathname === '/') {
        if (location.hostname === 'pingcap.github.io') {
            location.href = '/en/'
        }
    }</script></head> <body data-lang="cn"><div id="page-content">
<header class="fixed-top" role="navigation">
<div class="container">
<a class="nav-brand" href="/zh"><img alt="PingCAP" src="/images/pingcap-logo.png"/></a>
<div class="nav-wrapper">
<div class="navigation">
<ul>
<li><a class="nav-blinking" href="https://university.pingcap.com/" onclick="trackViews('navbar-university', 'pingcap-university_view')" target="_blank">PingCAP
                            University</a></li>
<li class="docs-type-selector " id="docsTypeSelector">
<a class="header-doc-nav" href="https://docs.pingcap.com/zh" target="_blank">文档</a>
</li>
<li><a href="/cases-cn">案例</a></li>
<li><a href="/community-cn">社区</a></li>
<li class="sel"><a href="/blog-cn">博客</a></li>
<li><a href="/about-cn">关于</a></li>
<li><a href="https://asktug.com" onclick="trackViews('navbar-asktug', 'asktug_view')" target="_blank">问答</a></li>
<li><a href="/download-cn">下载试用</a></li>
<li><a class="link-download" href="mailto:info@pingcap.com" onclick="trackViews('navbar-contact-us', 'mail_to_info_view')" target="_blank">联系我们</a></li>
</ul>
</div>
<div class="global-search">
<div class="search-wrapper">
<span class="icon-search"><svg fill="#fff" height="18" viewbox="0 0 67.125 67.125" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M23.902 0C11.01 0 .523 10.488.523 23.38c0 12.891 10.487 23.379 23.379 23.379a23.258 23.258 0 0 0 14.471-5.037l24.816 24.817c.391.391.902.586 1.414.586s1.023-.195 1.414-.586a2 2 0 0 0 0-2.828L41.293 38.985c3.721-4.142 5.989-9.613 5.989-15.605C47.282 10.488 36.794 0 23.902 0zM4.523 23.38C4.523 12.694 13.216 4 23.902 4c10.687 0 19.38 8.694 19.38 19.38 0 5.396-2.221 10.279-5.791 13.795a1.959 1.959 0 0 0-.488.349 2.003 2.003 0 0 0-.271.343C33.31 40.9 28.825 42.76 23.903 42.76c-10.686-.001-19.38-8.695-19.38-19.38z"></path><path d="M24.075 8.591c-8.25 0-14.962 6.712-14.962 14.962a2 2 0 0 0 4 0c0-6.044 4.918-10.962 10.962-10.962a2 2 0 0 0 0-4z"></path></svg></span>
<input data-lang="cn" data-type="" id="search-input" name="q" placeholder="搜索 TiDB 文档" type="search"/>
</div>
<script>
    const inputNode = document.getElementById("search-input")

    inputNode.addEventListener('keyup', ({key}) => {
        if (key === "Enter") {
            if ($('#search-input').data('lang') == 'cn') {
                lang = 'zh'
            }

            const query = $('#search-input').val()
            if (query) {
                url = "https://docs.pingcap.com/" + (lang == 'zh' ? 'zh/' : '') + "search/?lang=" + lang + "&type=tidb&version=v4.0&q=" + query
                window.location.href = url
            }
        }
    })
</script>
</div>
</div>
<div class="nav-btn nav-slider">
<i class="material-icons"><svg height="16" viewbox="0 0 459 459" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M0 382.5h459v-51H0v51zM0 255h459v-51H0v51zM0 76.5v51h459v-51H0z" fill="#FFF"></path></svg></i>
</div>
</div>
</header>
<nav class="mobile-sidebar">
<div class="nav-header">
<div class="logo-wrap">
<a class="nav-brand" href="/en"><img alt="PingCAP" src="/images/pingcap-logo.png"/></a>
</div>
</div>
<ul class="ul-base">
<li><a href="https://docs.pingcap.com/zh/tidb/v4.0/">文档</a></li>
<li><a href="/cases-cn">案例</a></li>
<li><a href="/community-cn">社区</a></li>
<li class="sel"><a href="/blog-cn">博客</a></li>
<li><a href="/about-cn">关于</a></li>
<li><a href="https://asktug.com" onclick="trackViews('navbar-asktug', 'asktug_view')" target="_blank">问答</a></li>
<li><a href="/download-cn">下载试用</a></li>
<li><a class="link-download" href="mailto:info@pingcap.com" onclick="trackViews('navbar-contact-us', 'mail_to_info_view')" target="_blank">联系我们</a></li>
<li><a class="nav-blinking" href="https://university.pingcap.com/" onclick="trackViews('navbar-university', 'pingcap-university_view')" target="_blank">PingCAP University</a></li>
</ul>
<div class="nav-footer">
<div class="contact-list-wrap">
<div class="flex-list">
<h4 class="list-title"><strong>Contact</strong></h4>
<ul class="social social-cn ul-base">
<li><a class="twitter" href="https://twitter.com/PingCAP" target="_blank"><svg height="18" viewbox="0 0 612 612" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"></path></svg></a></li>
<li><a class="linkedin" href="https://www.linkedin.com/company/pingcap/" target="_blank"><svg height="18" viewbox="0 0 438.536 438.535" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"></path></svg></a></li>
<li><a class="reddit" href="https://www.reddit.com/r/TiDB/" target="_blank"><svg height="18" viewbox="0 0 279.748 279.748" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"></path></svg></a></li>
<li><a class="google-plus" href="https://groups.google.com/forum/#!forum/tidb-user" target="_blank"><svg height="18" viewbox="0 0 491.858 491.858" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"></path></svg></a></li>
<li><a class="stack-overflow" href="https://stackoverflow.com/questions/tagged/tidb" target="_blank"><svg height="18" viewbox="0 0 547.597 547.597" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"></path><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"></path><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"></path></svg></a></li>
<li id="wechat-mobile"><a class="wechat" href="javascript:void(0)"><svg height="18" viewbox="0 0 31.403 31.404" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"></path><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"></path></svg></a><div class="qr_code_outer f-hide f-tc">
<div class="qr_code">
<i id="close_qrcode"><svg viewbox="0 0 224.512 224.512" xmlns="http://www.w3.org/2000/svg"><path d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z" fill="#010002"></path></svg></i>
<img alt="Wechat qrCode" class="qr_code_img" id="js_qr_code_img" src="/images/wechat-qrcode.jpg"/>
<p>微信扫一扫<br/> 微信ID：pingcap2015</p>
</div>
</div>
</li>
</ul>
</div>
<div class="subscribe" id="subscribe-mobile"></div>
</div>
<div class="container">
<a class="btn-lang" href="/blog" id="lang">English</a>
</div>
</div>
</nav>
<div class="blog">
<div class="container">
<div class="sidebar nav-tags" data-type="single"><div class="title">热门标签<a class="rss" href="/blog-cn/index.xml" title="RSS Feed"><svg height="17" viewbox="0 0 402.041 402.04" width="13" xmlns="http://www.w3.org/2000/svg"><g fill="#3A59F0"><path d="M54.816 292.382c-15.229 0-28.169 5.331-38.831 15.988C5.33 319.026 0 331.969 0 347.197c0 15.232 5.325 28.172 15.985 38.828 10.662 10.657 23.606 15.988 38.831 15.988 15.227 0 28.168-5.331 38.828-15.988 10.656-10.656 15.986-23.596 15.986-38.828 0-15.229-5.33-28.171-15.986-38.827-10.657-10.657-23.598-15.988-38.828-15.988zM181.01 221.002c-21.51-21.698-46.158-38.97-73.948-51.816-27.79-12.85-56.914-20.511-87.366-22.985h-1.425c-4.949 0-9.042 1.619-12.275 4.854C1.997 154.477 0 158.953 0 164.472v38.543c0 4.757 1.569 8.85 4.708 12.279 3.14 3.429 7.089 5.332 11.848 5.708 43.586 4.189 80.845 21.752 111.773 52.678 30.93 30.926 48.49 68.187 52.677 111.771.382 4.764 2.284 8.712 5.712 11.847 3.427 3.148 7.517 4.72 12.275 4.72h38.545c5.517 0 9.989-1.995 13.415-5.996 3.621-3.812 5.236-8.381 4.863-13.709-2.478-30.447-10.14-59.573-22.987-87.361-12.846-27.792-30.121-52.438-51.819-73.95z"></path><path d="M367.728 239.701c-20.365-45.585-48.345-86.078-83.936-121.482-35.405-35.594-75.896-63.572-121.485-83.939C116.723 13.917 68.996 2.494 19.126.02h-.855c-4.949 0-9.136 1.713-12.563 5.14C1.903 8.583 0 12.964 0 18.294v40.825c0 4.76 1.667 8.897 4.996 12.419 3.33 3.523 7.373 5.376 12.132 5.57 40.924 2.478 79.799 12.188 116.63 29.127 36.83 16.94 68.806 38.972 95.93 66.09 27.118 27.123 49.149 59.101 66.089 95.931 16.94 36.836 26.557 75.705 28.839 116.627.195 4.764 2.046 8.809 5.564 12.139 3.524 3.329 7.762 4.999 12.71 4.999h40.823c5.331 0 9.701-1.902 13.134-5.715 3.809-3.806 5.517-8.274 5.144-13.415-2.471-49.874-13.898-97.6-34.263-143.19z"></path></g></svg></a></div><a class="tag all" href="#">ALL (254)</a>
<div class="tag-list"><a class="tag " data-tag="Chaos-Mesh" href="#Chaos-Mesh">Chaos Mesh (7)
                </a><a class="tag " data-tag="Committer" href="#Committer">Committer (3)
                </a><a class="tag " data-tag="Contributor" href="#Contributor">Contributor (9)
                </a><a class="tag " data-tag="DM" href="#DM">DM (2)
                </a><a class="tag " data-tag="DM-源码阅读" href="#DM-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb">DM 源码阅读 (10)
                </a><a class="tag " data-tag="Go" href="#Go">Go (3)
                </a><a class="tag " data-tag="HTAP" href="#HTAP">HTAP (3)
                </a><a class="tag " data-tag="Hackathon" href="#Hackathon">Hackathon (4)
                </a><a class="tag " data-tag="K8s" href="#K8s">K8s (2)
                </a><a class="tag " data-tag="Key-Visualizer" href="#Key-Visualizer">Key Visualizer (2)
                </a><a class="tag " data-tag="Kubernetes" href="#Kubernetes">Kubernetes (3)
                </a><a class="tag " data-tag="Linux" href="#Linux">Linux (4)
                </a><a class="tag " data-tag="MVCC" href="#MVCC">MVCC (2)
                </a><a class="tag " data-tag="MySQL" href="#MySQL">MySQL (2)
                </a><a class="tag " data-tag="PD" href="#PD">PD (5)
                </a><a class="tag " data-tag="Percolator" href="#Percolator">Percolator (2)
                </a><a class="tag " data-tag="PingCAP" href="#PingCAP">PingCAP (2)
                </a><a class="tag " data-tag="Prometheus" href="#Prometheus">Prometheus (3)
                </a><a class="tag " data-tag="Raft" href="#Raft">Raft (11)
                </a><a class="tag " data-tag="RocksDB" href="#RocksDB">RocksDB (3)
                </a><a class="tag " data-tag="Rust" href="#Rust">Rust (5)
                </a><a class="tag " data-tag="SQL" href="#SQL">SQL (6)
                </a><a class="tag " data-tag="Spanner" href="#Spanner">Spanner (2)
                </a><a class="tag " data-tag="TiDB" href="#TiDB">TiDB (79)
                </a><a class="tag " data-tag="TiDB-4.0-新特性" href="#TiDB-4.0-%e6%96%b0%e7%89%b9%e6%80%a7">TiDB 4.0 新特性 (11)
                </a><a class="tag " data-tag="TiDB-Binlog" href="#TiDB-Binlog">TiDB Binlog (5)
                </a><a class="tag " data-tag="TiDB-Binlog-源码阅读" href="#TiDB-Binlog-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb">TiDB Binlog 源码阅读 (9)
                </a><a class="tag " data-tag="TiDB-Ecosystem-Tools" href="#TiDB-Ecosystem-Tools">TiDB Ecosystem Tools (3)
                </a><a class="tag " data-tag="TiDB-Operator" href="#TiDB-Operator">TiDB Operator (5)
                </a><a class="tag " data-tag="TiDB-性能挑战赛" href="#TiDB-%e6%80%a7%e8%83%bd%e6%8c%91%e6%88%98%e8%b5%9b">TiDB 性能挑战赛 (2)
                </a><a class="tag " data-tag="TiDB-易用性挑战赛" href="#TiDB-%e6%98%93%e7%94%a8%e6%80%a7%e6%8c%91%e6%88%98%e8%b5%9b">TiDB 易用性挑战赛 (4)
                </a><a class="tag " data-tag="TiDB-源码阅读" href="#TiDB-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb">TiDB 源码阅读 (24)
                </a><a class="tag " data-tag="TiFlash" href="#TiFlash">TiFlash (7)
                </a><a class="tag " data-tag="TiKV" href="#TiKV">TiKV (28)
                </a><a class="tag sel" data-tag="TiKV-源码解析" href="#TiKV-%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90">TiKV 源码解析 (20)
                </a><a class="tag " data-tag="TiSpark" href="#TiSpark">TiSpark (4)
                </a><a class="tag " data-tag="WebAssembly" href="#WebAssembly">WebAssembly (2)
                </a><a class="tag " data-tag="gRPC" href="#gRPC">gRPC (2)
                </a><a class="tag " data-tag="事务" href="#%e4%ba%8b%e5%8a%a1">事务 (4)
                </a><a class="tag " data-tag="优化器" href="#%e4%bc%98%e5%8c%96%e5%99%a8">优化器 (2)
                </a><a class="tag " data-tag="分布式系统前沿技术" href="#%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e5%89%8d%e6%b2%bf%e6%8a%80%e6%9c%af">分布式系统前沿技术 (4)
                </a><a class="tag " data-tag="分布式系统测试" href="#%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e6%b5%8b%e8%af%95">分布式系统测试 (3)
                </a><a class="tag " data-tag="备份恢复" href="#%e5%a4%87%e4%bb%bd%e6%81%a2%e5%a4%8d">备份恢复 (2)
                </a><a class="tag " data-tag="工具" href="#%e5%b7%a5%e5%85%b7">工具 (4)
                </a><a class="tag " data-tag="性能" href="#%e6%80%a7%e8%83%bd">性能 (4)
                </a><a class="tag " data-tag="数据同步" href="#%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5">数据同步 (2)
                </a><a class="tag " data-tag="最佳实践" href="#%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5">最佳实践 (6)
                </a><a class="tag " data-tag="架构" href="#%e6%9e%b6%e6%9e%84">架构 (6)
                </a><a class="tag " data-tag="版本" href="#%e7%89%88%e6%9c%ac">版本 (2)
                </a><a class="tag sel" data-tag="社区" href="#%e7%a4%be%e5%8c%ba">社区 (102)
                </a><a class="tag " data-tag="社区动态" href="#%e7%a4%be%e5%8c%ba%e5%8a%a8%e6%80%81">社区动态 (29)
                </a><a class="tag " data-tag="集群调度" href="#%e9%9b%86%e7%be%a4%e8%b0%83%e5%ba%a6">集群调度 (2)
                </a>
</div>
</div>
<div class="archive">
<div class="content markdown-body">
<h1 class="title">TiKV 源码解析系列文章（十三）MVCC 数据读取</h1>
<ul class="blog-post-meta">
<li class="meta-item">
<img alt="Date icon" src="/images/svgs/icon-date.svg"/>Tue, Sep 3, 2019</li>
<li class="meta-item">
<img alt="Pen icon" src="/images/svgs/icon-writer.svg"/>施闻轩</li>
</ul>
<div class="blog-text"><p>在 <a href="https://pingcap.com/blog-cn/tikv-source-code-reading-12/">《TiKV 源码解析系列文章（十二）分布式事务》</a> 中，我们介绍了如何在满足事务特性的要求下进行数据写入。本文将介绍数据读取的流程。由于顺序扫（Forward Scan）比较具有代表性，因此本文只介绍顺序扫的流程，而不会介绍点查或逆序扫。点查是顺序扫的简化，相信读者理解了顺序扫的流程后能自己想出点查的实现，而逆序扫与顺序扫也比较类似，主要区别在于从后向前扫，稍复杂一些，相信大家在阅读本文后，也能自己对照着代码读懂逆序扫的实现。</p>
<h2 id="heading">数据格式</h2>
<p>首先回忆一下事务写入完成后，<a href="https://tikv.org/deep-dive/distributed-transaction/percolator/#percolator-in-tikv">在 RocksDB 层面存储的具体是什么样的数据</a>：</p>
<table>
<thead>
<tr>
<th align="left">CF</th>
<th align="left">RocksDB Key</th>
<th align="left">RocksDB Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Lock</td>
<td align="left"><code>user_key</code></td>
<td align="left"><code>lock_info</code></td>
</tr>
<tr>
<td align="left">Default</td>
<td align="left"><code>{user_key}{start_ts}</code></td>
<td align="left"><code>user_value</code></td>
</tr>
<tr>
<td align="left">Write</td>
<td align="left"><code>{user_key}{commit_ts}</code></td>
<td align="left"><code>write_info</code></td>
</tr>
</tbody>
</table>
<p>其中：</p>
<ul>
<li>为了消除歧义，约定 User Key (<code>user_key</code>) 指 TiKV Client（如 TiDB）所写入的或所要读取的 Key，User Value (<code>user_value</code>) 指 User Key 对应的 Value。</li>
<li><code>lock_info</code> 包含 lock type、primary key、timestamp、ttl 等信息，见 <a href="https://github.com/tikv/tikv/blob/1924a32376b7823c3faa0795f53e836e65eb9ff0/src/storage/mvcc/lock.rs"><code>src/storage/mvcc/lock.rs</code></a>。</li>
<li><code>write_info</code> 包含 write type、start_ts 等信息，见 <a href="https://github.com/tikv/tikv/blob/1924a32376b7823c3faa0795f53e836e65eb9ff0/src/storage/mvcc/write.rs"><code>src/storage/mvcc/write.rs</code></a>。</li>
</ul>
<h2 id="heading-1">事务样例</h2>
<p>为了便于大家理解代码，我们假设 TiKV Client 之前进行了下面这些事务：</p>
<table>
<thead>
<tr>
<th align="left">事务号</th>
<th align="left">start_ts</th>
<th align="left">commit_ts</th>
<th align="left">KV</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">#1</td>
<td align="left">0x01</td>
<td align="left">0x03</td>
<td align="left"><code>PUT foo =&gt; foo_value</code>, <code>PUT bar =&gt; bar_value</code></td>
</tr>
<tr>
<td align="left">#2</td>
<td align="left">0x11</td>
<td align="left">0x13</td>
<td align="left"><code>PUT foo =&gt; foo_value2</code>, <code>PUT box =&gt; box_value</code></td>
</tr>
<tr>
<td align="left">#3</td>
<td align="left">0x21</td>
<td align="left">0x23</td>
<td align="left"><code>DELETE abc</code></td>
</tr>
<tr>
<td align="left">#4</td>
<td align="left">0x31</td>
<td align="left">0x33</td>
<td align="left"><code>DELETE box</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>注意，TiDB 向 TiKV 写入的 Key（及上面的 user_key）并不会长成 foo、abc、box 这样，而大部分会是 <code>tXXXXXXXX_rXXXXXXXX</code> 或 <code>tXXXXXXXX_iXXXXXXXX</code> 的格式。但 Key 的格式并不影响 TiKV 的逻辑处理，所以我们这里仅采用简化的 Key 作为样例。Value 同理。</p>
</blockquote>
<p>每个事务 Prewrite 并 Commit 完毕后，落到 RocksDB 上的数据类似于这样：</p>
<ul>
<li>
<p>事务 #1：</p>
<table>
<thead>
<tr>
<th align="left">Write Key</th>
<th align="left">Write Value</th>
<th align="left">Default Key</th>
<th align="left">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>{foo}{0x03}</code></td>
<td align="left">type=PUT, start_ts=0x01</td>
<td align="left"><code>{foo}{0x01}</code></td>
<td align="left"><code>foo_value</code></td>
</tr>
<tr>
<td align="left"><code>{bar}{0x03}</code></td>
<td align="left">type=PUT, start_ts=0x01</td>
<td align="left"><code>{bar}{0x01}</code></td>
<td align="left"><code>bar_value</code></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>事务 #2：</p>
<table>
<thead>
<tr>
<th align="left">Write Key</th>
<th align="left">Write Value</th>
<th align="left">Default Key</th>
<th align="left">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>{foo}{0x13}</code></td>
<td align="left">type=PUT, start_ts=0x11</td>
<td align="left"><code>{foo}{0x11}</code></td>
<td align="left"><code>foo_value2</code></td>
</tr>
<tr>
<td align="left"><code>{box}{0x13}</code></td>
<td align="left">type=PUT, start_ts=0x11</td>
<td align="left"><code>{box}{0x11}</code></td>
<td align="left"><code>box_value</code></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>事务 #3：</p>
<table>
<thead>
<tr>
<th align="left">Write Key</th>
<th align="left">Write Value</th>
<th align="left">Default Key</th>
<th align="left">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>{abc}{0x23}</code></td>
<td align="left">type=DELETE, start_ts=0x21</td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>事务 #4：</p>
<table>
<thead>
<tr>
<th align="left">Write Key</th>
<th align="left">Write Value</th>
<th align="left">Default Key</th>
<th align="left">Default Value</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>{box}{0x33}</code></td>
<td align="left">type=DELETE, start_ts=0x31</td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>实际在 RocksDB 中存储的数据与上面表格里写的略微不一样，主要区别有：</p>
<ol>
<li>
<p>TiKV Raft 层会修改实际写入 RocksDB 的 Key（例如增加前缀 <code>z</code>）以便进行数据区分。对于 MVCC 和事务来说这个操作是透明的，因此我们先忽略这个。</p>
</li>
<li>
<p>User Key 会被按照 Memory Comparable Encoding 方式进行编码，编码算法是以 8 字节为单位进行 Padding。这个操作确保了我们在 User Key 后面追加 <code>start_ts</code> 或 <code>commit_ts</code> 之后实际写入的 Key 能保持与 User Key 具有相同的顺序。</p>
<p>例如，假设我们依次写入 <code>abc</code>、<code>abc\x00..\x00</code> 两个 User Key，在不进行 Padding 的情况下：</p>
<table>
<thead>
<tr>
<th align="left">User Key</th>
<th align="left">Start Ts</th>
<th align="left">写入的 Key</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>abc</code></td>
<td align="left">0x05</td>
<td align="left"><code>abc\x00\x00..\x05</code></td>
</tr>
<tr>
<td align="left"><code>abc\x00..\x00</code></td>
<td align="left">0x10</td>
<td align="left"><code>abc\x00\x00..\x00\x00\x00..\x10</code></td>
</tr>
</tbody>
</table>
<p>可见，User Key 顺序是 <code>abc &lt; abc\x00..\x00</code>，但写入的 Key 顺序却是 <code>abc\x00\x00..\x05 &gt; abc\x00\x00..\x00\x00\x00..\x10</code>。显然，在这之后，我们若想要有序地扫数据就会面临巨大的挑战。因此需要对 User Key 进行编码：</p>
<p>Example 1:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">User Key:      abc
Encoded:       abc\x00\x00\x00\x00\x00\xFA
              ^^^                    ^^^^
              Key                    Pad=5
                 ^^^^^^^^^^^^^^^^^^^^
                 Padding
</code></pre></div><p>Example 2:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">User Key:      abc\x00\x00\x00\x00\x00\x00\x00\x00
Encoded[0..9]: abc\x00\x00\x00\x00\x00\xFF
              ^^^^^^^^^^^^^^^^^^^^^^^
              Key[0..8]
                                     ^^^^
                                     Pad=0
Encoded[9..]:  \x00\x00\x00\x00\x00\x00\x00\x00\xFA
              ^^^^^^^^^^^^                    ^^^^
              Key[8..11]                      Pad=5
                          ^^^^^^^^^^^^^^^^^^^^
                          Padding
</code></pre></div><p>编码后的 Key 无论后面再追加什么 8 字节的 Timestamp，都能保持原来的顺序。</p>
</li>
<li>
<p>TiKV 在 Key 中存储的 Timestamp（无论是 <code>start_ts</code> 还是 <code>commit_ts</code>）都是 Timestamp 取反后的结果，其目的是让较新的数据（即 Timestamp 比较大的数据）排列在较老的数据（即 Timestamp 比较小的数据）前面。扫数据的流程利用了这个特性优化性能，继续阅读本文可以有所感受。后面本文中关于时间戳的部分将写作 <code>{!ts}</code> 来反映这个取反操作。</p>
</li>
<li>
<p>TiKV 对较小（&lt;= 64 字节）的 User Value 会进行优化，不存储在 Default CF 中，而是直接内嵌在 Lock Info 或 Write Info 中，从而加快这类 User Key 的扫的效率及写入效率。我们这个示例先暂且忽略这个优化，就当成 User Value 都很长没有进行内嵌。</p>
</li>
</ol>
<h2 id="heading-2">顺序扫</h2>
<p>顺序扫的代码位于 <a href="https://github.com/tikv/tikv/blob/1924a32376b7823c3faa0795f53e836e65eb9ff0/src/storage/mvcc/reader/scanner/forward.rs"><code>src/storage/mvcc/reader/scanner/forward.rs</code></a>。顺序扫的定义是给定 <code>scan_ts</code>、可选的下界 <code>lower_bound</code> 与可选的上界 <code>upper_bound</code>，需要依次知道在 <code>[lower_bound, upper_bound)</code> 范围内所有满足 <code>scan_ts</code>（即最新 <code>commit_ts &lt;= scan_ts</code>）的数据。扫的过程中可以随时中止，不需要扫出范围内所有数据。</p>
<p>以「事务样例」为例，假设其所有事务都 Commit 后：</p>
<ul>
<li>scan_ts = 0x00 顺序扫 <code>[-∞, +∞)</code> 可依次扫出：(空)。</li>
<li>scan_ts = 0x05 顺序扫 <code>[-∞, +∞)</code> 可依次扫出：<code>bar =&gt; bar_value</code>、<code>foo =&gt; foo_value</code>。</li>
<li>scan_ts = 0x12 顺序扫 <code>[-∞, +∞)</code>，可依次扫出 <code>bar =&gt; bar_value</code>、<code>foo =&gt; foo_value</code>。</li>
<li>scan_ts = 0x15 顺序扫 <code>[-∞, +∞)</code> 可依次扫出：<code>bar =&gt; bar_value</code>、<code>box =&gt; box_value</code>、<code>foo =&gt; foo_value2</code>。</li>
<li>scan_ts = 0x35 顺序扫 <code>[-∞, +∞)</code> 可依次扫出：<code>bar =&gt; bar_value</code>、<code>foo =&gt; foo_value2</code>。</li>
<li>scan_ts = 0x05 顺序扫 <code>[c, +∞)</code> 可依次扫出：<code>foo =&gt; foo_value</code>。</li>
</ul>
<p>假设「事务样例」中事务 #1 已 Commit 而事务 #2 已 Prewrite 未 Commit，此时：</p>
<ul>
<li>scan_ts = 0x05 顺序扫 <code>[-∞, +∞)</code>，可依次扫出：<code>bar =&gt; bar_value</code>、<code>foo =&gt; foo_value</code>。</li>
<li>scan_ts = 0x12 顺序扫 <code>[-∞, +∞)</code>，会先扫出 <code>bar =&gt; bar_value</code>，若还要继续扫应当返回 <code>box</code> 的锁冲突。TiDB 拿到这个错误后会等锁、清锁并重试。</li>
</ul>
<h2 id="heading-3">顺序扫流程</h2>
<p>根据上面所说的顺序扫定义及例子，在不考虑锁冲突的情况下，可以想出一个最简单的实现思路就是不断将 Write CF 的 Cursor 从 <code>lower_bound</code> 往后移动，对于各个 User Key 跳过它 <code>commit_ts &gt; scan_ts</code> 的版本，采纳第一个 <code>commit_ts &lt;= scan_ts</code> 的版本，根据版本 Write Info 从 Default CF 中获取 Value，即可组成返回给上层的 KV 对。</p>
<p>这个思路很简单，但无法处理锁冲突。在有锁冲突的情况下，顺序扫只应当对扫到的数据处理锁冲突，没扫到的数据即使有锁，也不应该影响无冲突数据的正常扫（例如用户的 SQL 中有 limit）。由于不同 User Key（及同一个 User Key 的不同版本）都可能同时散落在 Write CF 与 Lock CF 中，因此 <strong>TiKV 的思路类似于归并排序</strong>：同时移动 Write CF Cursor 与 Lock CF Cursor，在移动过程中这两个 Cursor 可能对应了不同的 User Key，较小的那个就是要优先处理的 User Key。如果这个 User Key 是 Lock CF 中的，说明可能遇到了锁冲突，需要返回失败或忽略。如果这个 User Key 是 Write CF 中的，说明有多版本可以供读取，需要找到最近的一个满足 <code>scan_ts</code> 要求的版本信息 Write Info，根据其内部记载的 <code>start_ts</code> 再从 Default CF 中获取 Value，从而组成 KV 对返回给上层。</p>
<p><img alt="TiKV 扫数据算法示意" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-13/1.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="caption-center">图 1 TiKV 扫数据算法示意</div>
<p>单次迭代的具体流程为：</p>
<h3 id="-1">步骤 1.</h3>
<p>首次迭代：将 Lock 及 Write CF Cursor Seek 到 <code>lower_bound</code> 处。此时它们各自指向了第一个 <code>&gt;= lower_bound</code> 的 Key。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>self.is_started {
    <span style="color:#66d9ef">if</span> self.cfg.lower_bound.is_some() {
        self.write_cursor.seek(
            self.cfg.lower_bound.as_ref().unwrap(),
            ...,
        )<span style="color:#f92672">?</span>;
        self.lock_cursor.seek(
            self.cfg.lower_bound.as_ref().unwrap(),
            ...,
        )<span style="color:#f92672">?</span>;
    } <span style="color:#66d9ef">else</span> {
        self.write_cursor.seek_to_first(...);
        self.lock_cursor.seek_to_first(...);
    }
    self.is_started <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
}
</code></pre></div><h3 id="-2">步骤 2.</h3>
<p>Lock Cursor 和 Write Cursor 分别指向的 Key 可能对应不同的 User Key（也可能指向空，代表该 CF 已没有更多数据）。比较 Lock Cursor 与 Write Cursor 可得出第一个遇到的 User Key：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">let</span> w_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">if</span> self.write_cursor.valid()<span style="color:#f92672">?</span> {
    Some(self.write_cursor.key(...))
} <span style="color:#66d9ef">else</span> {
    None
};
<span style="color:#66d9ef">let</span> l_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">if</span> self.lock_cursor.valid()<span style="color:#f92672">?</span> {
    Some(self.lock_cursor.key(...))
} <span style="color:#66d9ef">else</span> {
    None
};

<span style="color:#66d9ef">match</span> (w_key, l_key) { ... }
</code></pre></div><h4 id="-21">分支 2.1.</h4>
<p>Write Cursor 指向空，Lock Cursor 指向空：说明两个 CF 都扫完了，该直接结束了。</p>
<p><img alt="示意图 1" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-13/2.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="caption-center">图 2 进入本分支的一种情况，若 Seek 的是 e，则处于 Write Cursor 和 Lock Cursor 都指向空的状态</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">(current_user_key_slice, has_write, has_lock) <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span> (w_key, l_key) {
    (None, None) <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> {
        <span style="color:#75715e">// Both cursors yield `None`: we know that there is nothing remaining.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> Ok(None);
    }
    ...
}
</code></pre></div><h4 id="-22">分支 2.2.</h4>
<p>Write Cursor 指向某个值 <code>w_key</code>，Lock Cursor 指向空：说明存在一个 <code>User Key = w_key</code> 的 Write Info，且没有任何 <code>&gt;= Start Key</code> 的 Lock Info。<code>w_key</code> 即为第一个遇到的 User Key。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">(current_user_key_slice, has_write, has_lock) <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span> (w_key, l_key) {
    ...
    (Some(k), None) <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> {
        <span style="color:#75715e">// Write cursor yields something but lock cursor yields `None`:
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// We need to further step write cursor to our desired version
</span><span style="color:#75715e"></span>        (Key::truncate_ts_for(k)<span style="color:#f92672">?</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>)
    }
    ...
}
</code></pre></div><h4 id="-23">分支 2.3.</h4>
<p>Write Cursor 指向空，Lock Cursor 指向某个值 <code>l_key</code>：说明存在一个 <code>User Key = l_key</code> 的 Lock Info。<code>l_key</code> 即是第一个遇到的 User Key。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">(current_user_key_slice, has_write, has_lock) <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span> (w_key, l_key) {
    ...
    (None, Some(k)) <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> {
        <span style="color:#75715e">// Write cursor yields `None` but lock cursor yields something:
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// In RC, it means we got nothing.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// In SI, we need to check if the lock will cause conflict.
</span><span style="color:#75715e"></span>        (k, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">true</span>)
    }
    ...
}
</code></pre></div><h4 id="-24">分支 2.4.</h4>
<p>Write Cursor 指向某个值 <code>w_key</code>，Lock Cursor 指向某个值 <code>l_key</code>：说明存在一个 <code>User Key = l_key</code> 的 Lock Info、存在一个 <code>User Key = w_key</code> 的 Write Info。<code>l_key</code> 与 <code>w_key</code> 中小的那个是第一个遇到的 User Key。</p>
<p><img alt="示意图 2" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-13/3.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="caption-center">图 3 进入本分支的一种情况，若 Seek 的是 a，则处于 Write Cursor 和 Lock Cursor 都指向某个值的状态</div>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">(current_user_key_slice, has_write, has_lock) <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span> (w_key, l_key) {
    ...
    (Some(wk), Some(lk)) <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> {
        <span style="color:#66d9ef">let</span> write_user_key <span style="color:#f92672">=</span> Key::truncate_ts_for(wk)<span style="color:#f92672">?</span>;
        <span style="color:#66d9ef">match</span> write_user_key.cmp(lk) {
            Ordering::Less <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> {
                <span style="color:#75715e">// Write cursor user key &lt; lock cursor, it means the lock of the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// current key that write cursor is pointing to does not exist.
</span><span style="color:#75715e"></span>                (write_user_key, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>)
            }
            Ordering::Greater <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> {
                <span style="color:#75715e">// Write cursor user key &gt; lock cursor, it means we got a lock of a
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// key that does not have a write. In SI, we need to check if the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// lock will cause conflict.
</span><span style="color:#75715e"></span>                (lk, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">true</span>)
            }
            Ordering::Equal <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> {
                <span style="color:#75715e">// Write cursor user key == lock cursor, it means the lock of the
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// current key that write cursor is pointing to *exists*.
</span><span style="color:#75715e"></span>                (lk, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">true</span>)
            }
        }
    }
}
</code></pre></div><h3 id="-3">步骤 3.</h3>
<p>如果在步骤 2 中，第一个遇到的 User Key 来自于 Lock，则：</p>
<h4 id="-31">步骤 3.1.</h4>
<p>检查 Lock Info 是否有效，例如需要忽略 <code>start_ts &gt; scan_ts</code> 的 lock。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">let</span> lock <span style="color:#f92672">=</span> {
    <span style="color:#66d9ef">let</span> lock_value <span style="color:#f92672">=</span> self.lock_cursor.value(...);
    Lock::parse(lock_value)<span style="color:#f92672">?</span>
};
<span style="color:#66d9ef">match</span> <span style="color:#66d9ef">super</span>::util::check_lock(<span style="color:#f92672">&amp;</span>current_user_key, self.cfg.ts, <span style="color:#f92672">&amp;</span>lock)<span style="color:#f92672">?</span> {
    CheckLockResult::NotLocked <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> {}
    CheckLockResult::Locked(e) <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> result <span style="color:#f92672">=</span> Err(e),
    CheckLockResult::Ignored(ts) <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> get_ts <span style="color:#f92672">=</span> ts,
}
</code></pre></div><blockquote>
<p>我们一般以当前的时间构造 scan_ts，为什么实际看到的似乎是“未来”的 lock？原因是这个读请求可能来自于一个早期开始的事务，或这个请求被网络阻塞了一会儿，或者我们正在<a href="https://pingcap.com/docs-cn/v3.0/how-to/get-started/read-historical-data/">读取历史数据</a>。</p>
</blockquote>
<h4 id="-32">步骤 3.2.</h4>
<p>将 Lock Cursor 往后移动一个 Key，以便下次迭代可以直接从新的 Lock 继续。此时 Lock Cursor 指向下一个 Lock（也可能指向空）。</p>
<h4 id="-33">步骤 3.3.</h4>
<p>在 3.1 步骤中检查下来有效的话报错返回这个 Lock，TiDB 后续需要进行清锁操作。</p>
<h3 id="-4">步骤 4.</h3>
<p>如果在步骤 2 中，第一个遇到的 User Key 来自于 Write：</p>
<blockquote>
<p>注：Lock Cursor 与 Write Cursor 可能一起指向了同一个 User Key 的不同版本。由于我们只想忽略锁对应的版本而不是想忽略这整个 User Key，因此此时步骤 3 和步骤 4 都会被执行，如下图所示。</p>
<p><img alt="示意图 3" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-13/4.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="caption-center">图 4 一种 User Cursor 和 Lock Cursor 具有相同 User Key 的情况，Seek 的是 c</div>
</blockquote>
<p>走到了目前这一步，说明我们需要从 Write Info 中读取 User Key 满足 <code>scan_ts</code> 的记录。需要注意，此时 User Key 可能是存在 Lock 的，但已被判定为应当忽略。</p>
<h4 id="-41">步骤 4.1.</h4>
<p>将 Write Cursor Seek 到 <code>{w_key}{!scan_ts}</code> 处（注：参见「事务样例」中区别 3，时间戳存储时取了反，因此这里及本文其余部分都以 <code>!</code> 标记取反操作）。如果版本数很少（同时这也符合绝大多数场景），那么这个要 Seek 的 Key 很可能非常靠近当前位置。在这个情况下为了避免较大的 Seek 开销，TiKV 采取先 <code>next</code> 若干次再 <code>seek</code> 的策略：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#75715e">// Try to iterate to `${user_key}_${ts}`. We first `next()` for a few times,
</span><span style="color:#75715e"></span><span style="color:#75715e">// and if we have not reached where we want, we use `seek()`.
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Whether we have *not* reached where we want by `next()`.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> needs_seek <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;

<span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span>..SEEK_BOUND {
    <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> {
        self.write_cursor.next(...);
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>self.write_cursor.valid()<span style="color:#f92672">?</span> {
            <span style="color:#75715e">// Key space ended.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> Ok(None);
        }
    }
    {
        <span style="color:#66d9ef">let</span> current_key <span style="color:#f92672">=</span> self.write_cursor.key(...);
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>Key::is_user_key_eq(current_key, user_key.as_encoded().as_slice()) {
            <span style="color:#75715e">// Meet another key.
</span><span style="color:#75715e"></span>            <span style="color:#f92672">*</span>met_next_user_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
            <span style="color:#66d9ef">return</span> Ok(None);
        }
        <span style="color:#66d9ef">if</span> Key::decode_ts_from(current_key)<span style="color:#f92672">?</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> ts {
            <span style="color:#75715e">// Founded, don't need to seek again.
</span><span style="color:#75715e"></span>            needs_seek <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
            <span style="color:#66d9ef">break</span>;
        }
    }
}
<span style="color:#75715e">// If we have not found `${user_key}_${ts}` in a few `next()`, directly `seek()`.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> needs_seek {
    <span style="color:#75715e">// `user_key` must have reserved space here, so its clone has reserved space too. So no
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// reallocation happens in `append_ts`.
</span><span style="color:#75715e"></span>    self.write_cursor
        .seek(<span style="color:#f92672">&amp;</span>user_key.clone().append_ts(ts), ...)<span style="color:#f92672">?</span>;
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>self.write_cursor.valid()<span style="color:#f92672">?</span> {
        <span style="color:#75715e">// Key space ended.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> Ok(None);
    }
    <span style="color:#66d9ef">let</span> current_key <span style="color:#f92672">=</span> self.write_cursor.key(...);
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>Key::is_user_key_eq(current_key, user_key.as_encoded().as_slice()) {
        <span style="color:#75715e">// Meet another key.
</span><span style="color:#75715e"></span>        <span style="color:#f92672">*</span>met_next_user_key <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
        <span style="color:#66d9ef">return</span> Ok(None);
    }
}
</code></pre></div><h4 id="-42">步骤 4.2.</h4>
<p><code>w_key</code> 可能没有任何 <code>commit_ts &lt;= scan_ts</code> 的记录，因此 Seek <code>{w_key}{!scan_ts}</code> 时可能直接越过了当前 User Key 进入下一个 <code>w_key</code>，因此需要先判断一下现在 Write Cursor 对应的 User Key 是否仍然是 <code>w_key</code>。如果是的话，说明这是我们找到的最大符合 <code>scan_ts</code> 的版本（Write Info）了，我们就可以依据该版本直接确定数据内容。若版本中包含的类型是 <code>DELETE</code>，说明在这个版本下 <code>w_key</code> 或者说 User Key 已被删除，那么我们就当做它不存在；否则如果类型是 <code>PUT</code>，就可以按照版本中存储的 <code>start_ts</code> 在 Default CF 中直接取得 User Value：Get <code>{w_key}{!start_ts}</code>。</p>
<p>另一方面，如果这一步 Seek 到了下一个 <code>w_key</code>，我们就不能采信这个新的 <code>w_key</code>，什么也不做，回到步骤 2，因为这个新的 <code>w_key</code> 可能比 <code>l_key</code> 大了，需要先重新看一下 <code>l_key</code> 的情况。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#75715e">// Now we must have reached the first key &gt;= `${user_key}_${ts}`. However, we may
</span><span style="color:#75715e"></span><span style="color:#75715e">// meet `Lock` or `Rollback`. In this case, more versions needs to be looked up.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">loop</span> {
    <span style="color:#66d9ef">let</span> write <span style="color:#f92672">=</span> Write::parse(self.write_cursor.value(...))<span style="color:#f92672">?</span>;
    self.statistics.write.processed <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;

    <span style="color:#66d9ef">match</span> write.write_type {
        WriteType::Put <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">return</span> Ok(Some(self.load_data_by_write(write, user_key)<span style="color:#f92672">?</span>)),
        WriteType::Delete <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">return</span> Ok(None),
        WriteType::Lock <span style="color:#f92672">|</span> WriteType::Rollback <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> {
            <span style="color:#75715e">// Continue iterate next `write`.
</span><span style="color:#75715e"></span>        }
    }

    ...
}
</code></pre></div><h4 id="-43">步骤 4.3.</h4>
<p>此时我们已经知道了 <code>w_key</code>（即 User Key）符合 <code>scan_ts</code> 版本要求的 Value。为了能允许后续进一步迭代到下一个 <code>w_key</code>，我们需要移动 Write Cursor 跳过当前 <code>w_key</code> 剩余所有版本。跳过的方法是 Seek <code>{w_key}{\xFF..\xFF}</code>，此时 Write Cursor 指向第一个 <code>&gt;= {w_key}{\xFF..\xFF}</code> 的 Key，也就是下一个 <code>w_key</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">move_write_cursor_to_next_user_key</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, current_user_key: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">Key</span>) -&gt; Result<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">for</span> i <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span>..SEEK_BOUND {
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> {
            self.write_cursor.next(...);
        }
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>self.write_cursor.valid()<span style="color:#f92672">?</span> {
            <span style="color:#75715e">// Key space ended. We are done here.
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> Ok(());
        }
        {
            <span style="color:#66d9ef">let</span> current_key <span style="color:#f92672">=</span> self.write_cursor.key(...);
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>Key::is_user_key_eq(current_key, current_user_key.as_encoded().as_slice()) {
                <span style="color:#75715e">// Found another user key. We are done here.
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span> Ok(());
            }
        }
    }
    <span style="color:#75715e">// We have not found another user key for now, so we directly `seek()`.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// After that, we must pointing to another key, or out of bound.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// `current_user_key` must have reserved space here, so its clone has reserved space too.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// So no reallocation happens in `append_ts`.
</span><span style="color:#75715e"></span>    self.write_cursor.internal_seek(
        <span style="color:#f92672">&amp;</span>current_user_key.clone().append_ts(<span style="color:#ae81ff">0</span>),
        ...,
    )<span style="color:#f92672">?</span>;
    Ok(())
}
</code></pre></div><h4 id="-44">步骤 4.4.</h4>
<p>依据之前取得的 User Value 返回 (User Key, User Value)。</p>
<h3 id="-5">步骤 5.</h3>
<p>如果没有扫到值，回到 2。</p>
<h2 id="heading-4">样例解释</h2>
<p>上面的步骤可能过于枯燥，接下来结合「事务样例」看一下流程。假设现在样例中的事务 #1 已递交而事务 #2 prewrite 完毕但还没 commit，则这几个样例事务在 RocksDB 存储的数据类似于如下所示：</p>
<p><img alt="样例事务在 RocksDB 的存储数据" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-13/5.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="caption-center">图 5 样例事务在 RocksDB 的存储数据</div>
<p>现在尝试以 scan_ts = 0x05 顺序扫 <code>[-∞, +∞)</code>。</p>
<ul>
<li>
<p>执行步骤 1：首次迭代：将 Lock 及 Write CF Cursor Seek 到 <code>lower_bound</code> 处。</p>
<p><img alt="执行完毕后各个 Cursor 位置示意" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-13/6.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="caption-center">图 6 执行完毕后各个 Cursor 位置示意</div>
</li>
<li>
<p>执行步骤 2：对比 Lock Cursor 与 Write Cursor，进入分支 2.4。</p>
</li>
<li>
<p>执行分支 2.4：Write Cursor 指向 <code>bar</code>，Lock Cursor 指向 <code>box</code>，User Key 为 <code>bar</code>。</p>
</li>
<li>
<p>执行步骤 3：User Key = bar 不来自于 Lock，跳过。</p>
</li>
<li>
<p>执行步骤 4：User Key = bar 来自于 Write，继续。</p>
</li>
<li>
<p>执行步骤 4.1：Seek <code>{w_key}{!scan_ts}</code>，即 Seek <code>bar......\xFF\xFF..\xFA</code>。Write Cursor 仍然是当前位置。</p>
<p><img alt="执行完毕后各个 Cursor 位置示意" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-13/7.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="caption-center">图 7 执行完毕后各个 Cursor 位置示意</div>
</li>
<li>
<p>执行步骤 4.2：此时 Write Key 指向 bar 与 User Key 相同，因此依据 <code>PUT (start_ts=1)</code> 从 Default CF 中获取到 <code>value = bar_value</code>。</p>
</li>
<li>
<p>执行步骤 4.3：移动 Write Cursor 跳过当前 <code>bar</code> 剩余所有版本，即 Seek <code>bar......\xFF\xFF..\xFF</code>：</p>
<p><img alt="执行完毕后各个 Cursor 位置示意" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-13/8.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="caption-center">图 8 执行完毕后各个 Cursor 位置示意</div>
</li>
<li>
<p>执行步骤 4.4：对外返回 Key Value 对 <code>(bar, bar_value)</code>。</p>
</li>
<li>
<p>若外部只需要 1 个 KV 对（例如 limit = 1），此时就可以停止了，若外部还要继续获取更多 KV 对，则重新开始执行步骤 1。</p>
</li>
<li>
<p>执行步骤 1：不是首次迭代，跳过。</p>
</li>
<li>
<p>执行步骤 2：对比 Lock Cursor 与 Write Cursor，进入分支 2.4。</p>
</li>
<li>
<p>执行分支 2.4：Write Cursor 指向 <code>foo</code>，Lock Cursor 指向 <code>box</code>，User Key 为 <code>box</code>。</p>
<p><img alt="执行完毕后各个 Cursor 位置示意" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-13/9.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="caption-center">图 9 执行完毕后各个 Cursor 位置示意</div>
</li>
<li>
<p>执行步骤 3：User Key = box 来自于 Lock，继续。</p>
</li>
<li>
<p>执行步骤 3.1：检查 Lock Info。Lock 的 ts 为 0x11，<code>scan_ts</code> 为 0x05，忽略这个 Lock 不返回锁冲突错误。</p>
</li>
<li>
<p>执行步骤 3.2：将 Lock Cursor 往后移动一个 Key。</p>
<p><img alt="执行完毕后各个 Cursor 位置示意" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-13/10.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="caption-center">图 10 执行完毕后各个 Cursor 位置示意</div>
</li>
<li>
<p>执行步骤 4：User Key = box 不来自于 Write，跳过，回到步骤 2。</p>
</li>
<li>
<p>执行步骤 2：对比 Lock Cursor 与 Write Cursor，进入分支 2.4。</p>
</li>
<li>
<p>执行分支 2.4：Write Cursor 指向 <code>foo</code>，Lock Cursor 指向 <code>foo</code>，User Key 为 <code>foo</code>。</p>
<p><img alt="执行完毕后各个 Cursor 位置示意" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-13/11.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="caption-center">图 11 执行完毕后各个 Cursor 位置示意</div>
</li>
<li>
<p>执行步骤 3：User Key = foo 来自于 Lock，继续。与之前类似，锁被忽略，且 Lock Cursor 往后移动。</p>
<p><img alt="执行完毕后各个 Cursor 位置示意" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-13/12.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="caption-center">图 12 执行完毕后各个 Cursor 位置示意</div>
</li>
<li>
<p>执行步骤 4：User Key = foo 同样来自于 Write，继续。</p>
</li>
<li>
<p>执行步骤 4.1：Seek <code>{w_key}{!scan_ts}</code>，即 Seek <code>foo......\xFF\xFF..\xFA</code>。Write Cursor 仍然是当前位置。</p>
</li>
<li>
<p>执行步骤 4.2：此时 Write Key 指向 foo 与 User Key 相同，因此依据 <code>PUT (start_ts=1)</code> 从 Default CF 中获取到 <code>value = foo_value</code>。</p>
</li>
<li>
<p>执行步骤 4.3：移动 Write Cursor 跳过当前 <code>foo</code> 剩余所有版本，即 Seek <code>foo......\xFF\xFF..\xFF</code>：</p>
<p><img alt="执行完毕后各个 Cursor 位置示意" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-13/13.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="caption-center">图 13 执行完毕后各个 Cursor 位置示意</div>
</li>
<li>
<p>执行步骤 4.4：对外返回 Key Value 对 <code>(foo, foo_value)</code>。</p>
</li>
<li>
<p>若外部选择继续扫，则继续回到步骤 1。</p>
</li>
<li>
<p>执行步骤 1：不是首次迭代，跳过。</p>
</li>
<li>
<p>执行步骤 2：对比 Lock Cursor 与 Write Cursor，进入分支 2.1。</p>
<p><img alt="执行完毕后各个 Cursor 位置示意" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-13/14.png" src="/images/svgs/loader-spinner.svg"/></p>
<div class="caption-center">图 14 执行完毕后各个 Cursor 位置示意</div>
</li>
<li>
<p>执行步骤 2.1：Write Cursor 和 Lock Cursor 都指向空，没有更多数据了。</p>
</li>
</ul>
<h2 id="heading-5">总结</h2>
<p>以上就是 MVCC 顺序扫数据代码的解析，点查和逆序扫流程与其类似，并且代码注释很详细，大家可以自主阅读理解。下篇文章我们会详细介绍悲观事务的代码实现。</p>
</div>
</div><div class="ssba-wrap">
<div class="ssba">
<a class="ssba_mail_share" href="mailto:info@pingcap.com" onclick="trackViews('blog-contact-us', 'mail_to_info_view')" target="_blank">
<svg height="18" viewbox="0 0 14 14" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M7 9L5.268 7.484.316 11.729c.18.167.423.271.691.271h11.986c.267 0 .509-.104.688-.271L8.732 7.484 7 9z"></path><path d="M13.684 2.271A1.007 1.007 0 0 0 12.993 2H1.007c-.267 0-.509.104-.689.273L7 8l6.684-5.729zM0 2.878v8.308l4.833-4.107zM9.167 7.079L14 11.186V2.875z"></path></svg>
</a>
<a class="ssba_wechat_share" data-site="wechat" data-url="https://pingcap.com/blog-cn/tikv-source-code-reading-13/" href="javascript:void(0)" id="wechat_share_btn" onclick="toggleBlogQRCode()">
<svg height="18" viewbox="0 0 31.403 31.404" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"></path><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"></path></svg>
</a>
</div>
</div>
<style type="text/css">
    .fixed-qrcode {
        position: fixed;
        top: 120px;
        right: 105px;
        padding: 10px 15px;
        width: 200px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.9);
        text-align: center;
    }

    .fixed-qrcode p {
        font-size: 14px;
        font-weight: 300;
        line-height: 1.6;
        margin: 8px 0;
        color: #333;
    }

    .fixed-qrcode #close_share_qrcode {
        position: absolute;
        top: 0;
        right: 0;
        width: 30px;
        height: 30px;
        padding: 10px;
    }

    .fixed-qrcode #close_share_qrcode svg {
        display: block;
    }

    .f-hide #share_qrcode {
        visibility: hidden;
        opacity: 0;
    }

    .fixed-qrcode #share_qrcode {
        visibility: visible;
        opacity: 1;
        height: 128px;
        transition: visibility 0s linear 0s, opacity .3s 0s;
        -webkit-transition: visibility 0s linear 0s, opacity .3s 0s;
    }

    #share_qrcode img {
        margin: 0 auto;
    }
</style>
<div class="f-hide" id="share_qrcode_outer">
<i id="close_share_qrcode"><svg viewbox="0 0 224.512 224.512" xmlns="http://www.w3.org/2000/svg"><path d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z" fill="#010002"></path></svg></i>
<p>分享到微信</p>
<div id="share_qrcode"></div>
<p>打开微信，使用 “扫一扫” 即可将网页分享至朋友圈。</p>
</div>
<script src="/js/vendor/qrcode.min.js" type="text/javascript"></script>
<script type="text/javascript">
    window.onload = function() {
        var close_share_qrcode_btn = document.getElementById('close_share_qrcode')
        var wechat_share_btn = document.getElementById('wechat_share_btn')
        var blog_url = wechat_share_btn.getAttribute('data-url')

        window.pingcap_blog_qrcode = new QRCode(
            document.getElementById('share_qrcode'),
            {
            text: blog_url,
            width: 128,
            height: 128,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
            }
        )

        close_share_qrcode_btn.addEventListener('click', function(event) {
            document
            .getElementById('share_qrcode_outer')
            .setAttribute('class', 'f-hide')
        })
    }

    function toggleBlogQRCode() {
        var qrcode_wrapper = document.getElementById('share_qrcode_outer')

        if (qrcode_wrapper.getAttribute('class') == 'f-hide') {
            qrcode_wrapper.setAttribute('class', 'fixed-qrcode')
        } else {
            qrcode_wrapper.setAttribute('class', 'f-hide')
        }
    }
</script>
</div>
</div>
</div>
<footer>
<div class="container">
<div class="flex-list-wrap">
<div class="flex-list">
<h4 class="list-title"><strong>产品</strong></h4>
<ul>
<li><a href="/docs-cn/v3.0/" onclick="trackViews('footer-product-tidb', 'docs-cn_view')">TiDB</a></li>
<li><a href="/docs-cn/v3.0/reference/tispark/">TiSpark</a></li>
<li><a href="/docs-cn/v3.0/roadmap/">TiDB 路线图</a></li>
</ul>
</div>
<div class="flex-list">
<h4 class="list-title"><strong>文档</strong></h4>
<ul>
<li><a href="https://docs.pingcap.com/zh/tidb/v4.0/quick-start-with-tidb">快速入门</a></li>
<li><a href="/blog-cn/tidb-best-practice/">最佳实践</a></li>
<li><a href="/docs-cn/stable/faq/tidb/">常见问题解答</a></li>
<li><a href="/docs-cn/stable/reference/tools/user-guide/">TiDB 周边工具</a></li>
<li><a href="https://docs.pingcap.com/zh/tidb/dev/release-notes">版本发布说明</a></li>
</ul>
</div>
<div class="flex-list">
<h4 class="list-title"><strong>资源</strong></h4>
<ul>
<li><a href="/blog-cn/">博客</a></li>
<li><a href="https://github.com/pingcap" target="_blank">GitHub</a></li>
<li><a href="https://book.tidb.io" target="_blank">TiDB in Action</a></li>
<li><a href="https://university.pingcap.com/" onclick="trackViews('footer-source-university', 'pingcap-university_view')" target="_blank">PingCAP
                    University</a></li>
<li><a href="/solutions/intel/" onclick="trackViews('footer-resource-solutions', 'solutions_view')">联合解决方案</a></li>
<li><a href="https://asktug.com/" onclick="trackViews('footer-resource-asktug', 'asktug_view')" target="_blank">Ask TUG</a></li>
</ul>
</div>
<div class="flex-list">
<h4 class="list-title"><strong>公司</strong></h4>
<ul>
<li><a href="/about-cn/">关于我们</a></li>
<li><a href="https://job.pingcap.com/" onclick="trackViews('footer-recruit-join', 'recruit-join_view')" target="_blank">招贤纳士</a>
</li>
<li><a href="/about-cn/news/">新闻报道</a></li>
<li><a href="/zh/privacy-policy/">隐私申明</a></li>
</ul>
</div>
</div>
<div class="contact-list-wrap">
<div class="flex-list">
<h4 class="list-title"><strong>联系我们</strong></h4>
<ul>
<li><a class="twitter" href="https://twitter.com/PingCAP" target="_blank"><svg height="19" viewbox="0 0 612 612" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"></path></svg> Twitter</a></li>
<li><a class="linkedin" href="https://www.linkedin.com/company/pingcap/" target="_blank"><svg height="16" viewbox="0 0 438.536 438.535" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"></path></svg> LinkedIn</a></li>
<li><a class="reddit" href="https://www.reddit.com/r/TiDB/" target="_blank"><svg height="18" viewbox="0 0 279.748 279.748" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"></path></svg> Reddit</a></li>
<li><a class="google-plus" href="https://groups.google.com/forum/#!forum/tidb-user" target="_blank"><svg height="20" viewbox="0 0 491.858 491.858" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"></path></svg> Google Group</a></li>
<li><a class="stack-overflow" href="https://stackoverflow.com/questions/tagged/tidb" target="_blank"><svg height="17" viewbox="0 0 547.597 547.597" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"></path><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"></path><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"></path></svg> Stack Overflow</a></li>
<li id="wechat"><a class="wechat" href="javascript:void(0)"><svg height="17" viewbox="0 0 31.403 31.404" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"></path><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"></path></svg> 微信公众号</a> <div class="qr_code_outer f-hide f-tc">
<div class="qr_code">
<i id="close_qrcode"><svg viewbox="0 0 224.512 224.512" xmlns="http://www.w3.org/2000/svg"><path d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z" fill="#010002"></path></svg></i>
<img alt="Wechat qrCode" class="qr_code_img" id="js_qr_code_img" src="/images/wechat-qrcode.jpg"/>
<p>微信扫一扫<br/> 微信ID：pingcap2015</p>
</div>
</div>
</li>
</ul>
</div>
<div class="subscribe" id="subscribe-pc"></div>
</div>
</div>
<div class="container copyright-container">
<p class="copyright">© 2020 北京平凯星辰科技发展有限公司</p>
<a class="copyright-btn-lang copyright-btn-en" href="/blog" id="lang">English</a>
<a class="prepared-num" href="http://www.beian.miit.gov.cn/">京 ICP 备 16046278 号 - 2</a>
</div>
</footer>
<button class="back-to-top" type="button"><svg height="512" viewbox="0 0 284.929 284.929" width="512" xmlns="http://www.w3.org/2000/svg"><path d="M282.082 195.285L149.028 62.24c-1.901-1.903-4.088-2.856-6.562-2.856s-4.665.953-6.567 2.856L2.856 195.285C.95 197.191 0 199.378 0 201.853c0 2.474.953 4.664 2.856 6.566l14.272 14.271c1.903 1.903 4.093 2.854 6.567 2.854s4.664-.951 6.567-2.854l112.204-112.202 112.208 112.209c1.902 1.903 4.093 2.848 6.563 2.848 2.478 0 4.668-.951 6.57-2.848l14.274-14.277c1.902-1.902 2.847-4.093 2.847-6.566.001-2.476-.944-4.666-2.846-6.569z" fill="#FFF"></path></svg>
</button>
</div><div class="overlay"></div><script src="https://download.pingcap.com/js/jquery.min.js"></script><script src="/js/vendor/lazyload.min.js" type="text/javascript"></script>
<script src="/js/doc.js" type="text/javascript"></script>
<script src="/js/anchor.js" type="text/javascript"></script><script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script crossorigin="anonymous" integrity="sha384-jbFinqIbKkHNg+QL+yxB4VrBC0EAPTuaLGeRT0T+NfEV89YC6u1bKxHLwoo+/xxY" src="https://browser.sentry-cdn.com/5.11.0/bundle.min.js"></script><script>Sentry.init({ 
            dsn: 'https://3f28ed393c5545daa74496b3cdb2e9ba@sentry.io/1887163' 
        });</script></body></html>