<!doctype html><html lang="en"><head>
<meta name="robots" content="noindex"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<script>
window.ga =
    window.ga ||
    function() {
        ;(ga.q = ga.q || []).push(arguments)
    }
ga.l = +new Date()
ga('create', 'UA-99991864-4', 'auto')
ga('send', 'pageview')
</script>
<script async src="https://download.pingcap.com/js/ga-analytics.js"></script>



<link rel="stylesheet" href="https://download.pingcap.com/style/github-markdown.css">


<link rel="stylesheet" href="/css/doc.css">

        <title>DM 源码阅读系列文章（四）dump/load 全量同步的实现 |&nbsp;PingCAP</title><link rel="icon" href="/images/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<meta name="description" content="本文将详细介绍 dump 和 load 两个数据同步处理单元的设计实现，重点关注数据同步处理单元 interface 的实现，数据导入并发模型的设计，以及导入任务在暂停或出现异常后如何恢复。">
<meta name="robots" content="noodp">
<meta name="keywords" content="TiDB, MySQL, HTAP, Open Source, Cloud-Native, NewSQL, Aurora Alternative">
<meta property="og:locale" content="en_US">
<meta property="og:type" content="website">
<meta property="og:title" content="DM 源码阅读系列文章（四）dump/load 全量同步的实现 | PingCAP">
<meta property="og:description" content="本文将详细介绍 dump 和 load 两个数据同步处理单元的设计实现，重点关注数据同步处理单元 interface 的实现，数据导入并发模型的设计，以及导入任务在暂停或出现异常后如何恢复。">
<meta property="og:url" content="https://pingcap.com/blog-cn/dm-source-code-reading-4/">
<meta property="og:site_name" content="MySQL at Scale. No more manual sharding">
<meta property="og:image" content="/images/pingcap-opengraph.jpg">
<meta property="og:image:secure_url" content="/images/pingcap-opengraph.jpg"><meta name="twitter:card" content="summary"><meta name="twitter:description" content="本文将详细介绍 dump 和 load 两个数据同步处理单元的设计实现，重点关注数据同步处理单元 interface 的实现，数据导入并发模型的设计，以及导入任务在暂停或出现异常后如何恢复。">
<meta name="twitter:title" content="DM 源码阅读系列文章（四）dump/load 全量同步的实现 | PingCAP">
<meta name="twitter:site" content="@pingcap">
<meta name="twitter:image" content="https://download.pingcap.com/images/pingcap-opengraph.jpg"><meta name="twitter:creator" content="@pingcap">





<script type="application/ld+json">
{
    "@context": "http:\/\/schema.org",
    "@type": "WebSite",
    "url": "https:\/\/pingcap.com\/",
    "name": "PingCAP",
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https:\/\/pingcap.com\/?s={search_term_string}",
        "query-input": "required name=search_term_string"
    }
}
</script>


<script>
    (function(){
        var bp = document.createElement('script');
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>


<script type="text/javascript" async src="https://accounts.pingcap.com/static/pingcap_sso/js/track.beta.js"></script>
    
<link rel="preload" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.woff" as="font" type="font/woff" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.ttf" as="font" type="font/ttf" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff" as="font" type="font/woff" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.ttf" as="font" type="font/ttf" crossorigin="anonymous">

<link rel="preload" href="https://download.pingcap.com/js/jquery.min.js" as="script">


<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="https://download.pingcap.com/style/docsearch.min.css">
<script type="text/javascript">
var trackOutboundLink = function(url) {
  var redirectTriggered = false
  ga('send', 'event', 'outbound', 'click', url, {
    hitCallback: function() {
      redirectTriggered = true
      document.location = url
    }
  })
  setTimeout(function() {
    if (!redirectTriggered) {
      document.location = url
    }
  }, 1500)
}

var trackViews = function(btn_type, event_category) {
  var event_label = btn_type
  var eventCategory = event_category
  ga('send', 'event', {
    'eventCategory': eventCategory,
    'eventAction': 'click',
    'eventLabel': event_label,
    'transport': 'beacon'
  });
}
</script>
<script>if (location.pathname === '/') {
        if (location.hostname === 'pingcap.github.io') {
            location.href = '/en/'
        }
    }</script></head>       <body data-lang="cn" ><div id="page-content">
<header role="navigation" class="fixed-top">
    <div class="container">
        <a class="nav-brand" href="/zh"><img src="/images/pingcap-logo.png" alt="PingCAP"></a>
        <div class="nav-wrapper">
            <div class="navigation">
                <ul>
                    <li><a href="https://university.pingcap.com/" target="_blank" class="nav-blinking"
                            onclick="trackViews('navbar-university', 'pingcap-university_view')">PingCAP
                            University</a></li>
                    <li class="docs-type-selector " id="docsTypeSelector">
                        
                        <a class="header-doc-nav" href="https://docs.pingcap.com/zh" target="_blank">文档</a>
                    </li>
                    <li ><a href="/cases-cn">案例</a></li>
                    <li ><a href="/community-cn">社区</a></li>
                    <li class="sel" ><a href="/blog-cn">博客</a></li>
                    <li ><a href="/about-cn">关于</a></li>
                    <li><a href="https://asktug.com" target="_blank"
                            onclick="trackViews('navbar-asktug', 'asktug_view')">问答</a></li>
                    <li ><a href="/download-cn">下载试用</a></li>
                    <li><a class="link-download" href="mailto:info@pingcap.com" target="_blank"
                            onclick="trackViews('navbar-contact-us', 'mail_to_info_view')">联系我们</a></li>
                </ul>
            </div>
            <div class="global-search">
                
                
                
                <div class="search-wrapper">
    <span class="icon-search"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#fff" viewBox="0 0 67.125 67.125"><path d="M23.902 0C11.01 0 .523 10.488.523 23.38c0 12.891 10.487 23.379 23.379 23.379a23.258 23.258 0 0 0 14.471-5.037l24.816 24.817c.391.391.902.586 1.414.586s1.023-.195 1.414-.586a2 2 0 0 0 0-2.828L41.293 38.985c3.721-4.142 5.989-9.613 5.989-15.605C47.282 10.488 36.794 0 23.902 0zM4.523 23.38C4.523 12.694 13.216 4 23.902 4c10.687 0 19.38 8.694 19.38 19.38 0 5.396-2.221 10.279-5.791 13.795a1.959 1.959 0 0 0-.488.349 2.003 2.003 0 0 0-.271.343C33.31 40.9 28.825 42.76 23.903 42.76c-10.686-.001-19.38-8.695-19.38-19.38z"/><path d="M24.075 8.591c-8.25 0-14.962 6.712-14.962 14.962a2 2 0 0 0 4 0c0-6.044 4.918-10.962 10.962-10.962a2 2 0 0 0 0-4z"/></svg></span>
    <input data-lang="cn" data-type="" type="search" id="search-input" name="q"
        placeholder="搜索 TiDB 文档">
</div>

<script>
    const inputNode = document.getElementById("search-input")

    inputNode.addEventListener('keyup', ({key}) => {
        if (key === "Enter") {
            if ($('#search-input').data('lang') == 'cn') {
                lang = 'zh'
            }

            const query = $('#search-input').val()
            if (query) {
                url = "https://docs.pingcap.com/" + (lang == 'zh' ? 'zh/' : '') + "search/?lang=" + lang + "&type=tidb&version=v4.0&q=" + query
                window.location.href = url
            }
        }
    })
</script>

            </div>
        </div>
        <div class="nav-btn nav-slider">
            <i class="material-icons"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 459 459"><path d="M0 382.5h459v-51H0v51zM0 255h459v-51H0v51zM0 76.5v51h459v-51H0z" fill="#FFF"/></svg></i>
        </div>
    </div>
</header>



<nav class="mobile-sidebar">
    <div class="nav-header">
        <div class="logo-wrap">
        <a class="nav-brand" href="/en"><img src="/images/pingcap-logo.png" alt="PingCAP"></a>
        </div>
    </div>
    <ul class="ul-base">
        

        <li ><a href="https://docs.pingcap.com/zh/tidb/v4.0/">文档</a></li>
        <li ><a href="/cases-cn">案例</a></li>
        <li ><a href="/community-cn">社区</a></li>
        <li class="sel"><a href="/blog-cn">博客</a></li>
        <li ><a href="/about-cn">关于</a></li>
        <li><a href="https://asktug.com" target="_blank"
            onclick="trackViews('navbar-asktug', 'asktug_view')">问答</a></li>
        <li ><a href="/download-cn">下载试用</a></li>
        <li><a class="link-download" href="mailto:info@pingcap.com" target="_blank"
            onclick="trackViews('navbar-contact-us', 'mail_to_info_view')">联系我们</a></li>
        <li><a href="https://university.pingcap.com/"
            onclick="trackViews('navbar-university', 'pingcap-university_view')" target="_blank"
            class="nav-blinking">PingCAP University</a></li>
    </ul>
    <div class="nav-footer">
        <div class="contact-list-wrap">
        <div class="flex-list">
            <h4 class="list-title"><strong>Contact</strong></h4>
            <ul class="social social-cn ul-base">
            <li><a href="https://twitter.com/PingCAP" class="twitter" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" width="18" height="18"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"/></svg></a></li>
            <li><a href="https://www.linkedin.com/company/pingcap/" class="linkedin" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 438.536 438.535"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"/></svg></a></li>
            <li><a href="https://www.reddit.com/r/TiDB/" class="reddit" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 279.748 279.748" width="18" height="18"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"/></svg></a></li>
            <li><a href="https://groups.google.com/forum/#!forum/tidb-user" class="google-plus" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 491.858 491.858" width="18" height="18"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"/></svg></a></li>
            <li><a href="https://stackoverflow.com/questions/tagged/tidb" class="stack-overflow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 547.597 547.597"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"/><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"/><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"/></svg></a></li>
            <li id="wechat-mobile"><a class="wechat" href="javascript:void(0)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 31.403 31.404"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"/><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"/></svg></a><div class="qr_code_outer f-hide f-tc">
    <div class="qr_code">
        <i id="close_qrcode"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 224.512 224.512"><path fill="#010002" d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z"/></svg></i>
        <img id="js_qr_code_img" class="qr_code_img" src="/images/wechat-qrcode.jpg" alt="Wechat qrCode" />
        <p>微信扫一扫<br> 微信ID：pingcap2015</p>
    </div>
</div>
</li>
            </ul>
        </div>
        <div class="subscribe" id="subscribe-mobile"></div>
        </div>
        <div class="container">
        <a href="/blog" class="btn-lang" id="lang">English</a>
        </div>
    </div>
</nav>

<div class="blog">
        <div class="container">
<div class="sidebar nav-tags" data-type="single"><div class="title">热门标签<a class="rss" href="/blog-cn/index.xml" title="RSS Feed"><svg xmlns="http://www.w3.org/2000/svg" width="13" height="17" viewBox="0 0 402.041 402.04"><g fill="#3A59F0"><path d="M54.816 292.382c-15.229 0-28.169 5.331-38.831 15.988C5.33 319.026 0 331.969 0 347.197c0 15.232 5.325 28.172 15.985 38.828 10.662 10.657 23.606 15.988 38.831 15.988 15.227 0 28.168-5.331 38.828-15.988 10.656-10.656 15.986-23.596 15.986-38.828 0-15.229-5.33-28.171-15.986-38.827-10.657-10.657-23.598-15.988-38.828-15.988zM181.01 221.002c-21.51-21.698-46.158-38.97-73.948-51.816-27.79-12.85-56.914-20.511-87.366-22.985h-1.425c-4.949 0-9.042 1.619-12.275 4.854C1.997 154.477 0 158.953 0 164.472v38.543c0 4.757 1.569 8.85 4.708 12.279 3.14 3.429 7.089 5.332 11.848 5.708 43.586 4.189 80.845 21.752 111.773 52.678 30.93 30.926 48.49 68.187 52.677 111.771.382 4.764 2.284 8.712 5.712 11.847 3.427 3.148 7.517 4.72 12.275 4.72h38.545c5.517 0 9.989-1.995 13.415-5.996 3.621-3.812 5.236-8.381 4.863-13.709-2.478-30.447-10.14-59.573-22.987-87.361-12.846-27.792-30.121-52.438-51.819-73.95z"/><path d="M367.728 239.701c-20.365-45.585-48.345-86.078-83.936-121.482-35.405-35.594-75.896-63.572-121.485-83.939C116.723 13.917 68.996 2.494 19.126.02h-.855c-4.949 0-9.136 1.713-12.563 5.14C1.903 8.583 0 12.964 0 18.294v40.825c0 4.76 1.667 8.897 4.996 12.419 3.33 3.523 7.373 5.376 12.132 5.57 40.924 2.478 79.799 12.188 116.63 29.127 36.83 16.94 68.806 38.972 95.93 66.09 27.118 27.123 49.149 59.101 66.089 95.931 16.94 36.836 26.557 75.705 28.839 116.627.195 4.764 2.046 8.809 5.564 12.139 3.524 3.329 7.762 4.999 12.71 4.999h40.823c5.331 0 9.701-1.902 13.134-5.715 3.809-3.806 5.517-8.274 5.144-13.415-2.471-49.874-13.898-97.6-34.263-143.19z"/></g></svg></a></div><a href="#" class="tag all">ALL (254)</a>
    <div class="tag-list"><a href="#Chaos-Mesh" class="tag " data-tag="Chaos-Mesh">Chaos Mesh&nbsp;(7)
                </a><a href="#Committer" class="tag " data-tag="Committer">Committer&nbsp;(3)
                </a><a href="#Contributor" class="tag " data-tag="Contributor">Contributor&nbsp;(9)
                </a><a href="#DM" class="tag " data-tag="DM">DM&nbsp;(2)
                </a><a href="#DM-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb" class="tag sel" data-tag="DM-源码阅读">DM 源码阅读&nbsp;(10)
                </a><a href="#Go" class="tag " data-tag="Go">Go&nbsp;(3)
                </a><a href="#HTAP" class="tag " data-tag="HTAP">HTAP&nbsp;(3)
                </a><a href="#Hackathon" class="tag " data-tag="Hackathon">Hackathon&nbsp;(4)
                </a><a href="#K8s" class="tag " data-tag="K8s">K8s&nbsp;(2)
                </a><a href="#Key-Visualizer" class="tag " data-tag="Key-Visualizer">Key Visualizer&nbsp;(2)
                </a><a href="#Kubernetes" class="tag " data-tag="Kubernetes">Kubernetes&nbsp;(3)
                </a><a href="#Linux" class="tag " data-tag="Linux">Linux&nbsp;(4)
                </a><a href="#MVCC" class="tag " data-tag="MVCC">MVCC&nbsp;(2)
                </a><a href="#MySQL" class="tag " data-tag="MySQL">MySQL&nbsp;(2)
                </a><a href="#PD" class="tag " data-tag="PD">PD&nbsp;(5)
                </a><a href="#Percolator" class="tag " data-tag="Percolator">Percolator&nbsp;(2)
                </a><a href="#PingCAP" class="tag " data-tag="PingCAP">PingCAP&nbsp;(2)
                </a><a href="#Prometheus" class="tag " data-tag="Prometheus">Prometheus&nbsp;(3)
                </a><a href="#Raft" class="tag " data-tag="Raft">Raft&nbsp;(11)
                </a><a href="#RocksDB" class="tag " data-tag="RocksDB">RocksDB&nbsp;(3)
                </a><a href="#Rust" class="tag " data-tag="Rust">Rust&nbsp;(5)
                </a><a href="#SQL" class="tag " data-tag="SQL">SQL&nbsp;(6)
                </a><a href="#Spanner" class="tag " data-tag="Spanner">Spanner&nbsp;(2)
                </a><a href="#TiDB" class="tag " data-tag="TiDB">TiDB&nbsp;(79)
                </a><a href="#TiDB-4.0-%e6%96%b0%e7%89%b9%e6%80%a7" class="tag " data-tag="TiDB-4.0-新特性">TiDB 4.0 新特性&nbsp;(11)
                </a><a href="#TiDB-Binlog" class="tag " data-tag="TiDB-Binlog">TiDB Binlog&nbsp;(5)
                </a><a href="#TiDB-Binlog-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb" class="tag " data-tag="TiDB-Binlog-源码阅读">TiDB Binlog 源码阅读&nbsp;(9)
                </a><a href="#TiDB-Ecosystem-Tools" class="tag " data-tag="TiDB-Ecosystem-Tools">TiDB Ecosystem Tools&nbsp;(3)
                </a><a href="#TiDB-Operator" class="tag " data-tag="TiDB-Operator">TiDB Operator&nbsp;(5)
                </a><a href="#TiDB-%e6%80%a7%e8%83%bd%e6%8c%91%e6%88%98%e8%b5%9b" class="tag " data-tag="TiDB-性能挑战赛">TiDB 性能挑战赛&nbsp;(2)
                </a><a href="#TiDB-%e6%98%93%e7%94%a8%e6%80%a7%e6%8c%91%e6%88%98%e8%b5%9b" class="tag " data-tag="TiDB-易用性挑战赛">TiDB 易用性挑战赛&nbsp;(4)
                </a><a href="#TiDB-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb" class="tag " data-tag="TiDB-源码阅读">TiDB 源码阅读&nbsp;(24)
                </a><a href="#TiFlash" class="tag " data-tag="TiFlash">TiFlash&nbsp;(7)
                </a><a href="#TiKV" class="tag " data-tag="TiKV">TiKV&nbsp;(28)
                </a><a href="#TiKV-%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90" class="tag " data-tag="TiKV-源码解析">TiKV 源码解析&nbsp;(20)
                </a><a href="#TiSpark" class="tag " data-tag="TiSpark">TiSpark&nbsp;(4)
                </a><a href="#WebAssembly" class="tag " data-tag="WebAssembly">WebAssembly&nbsp;(2)
                </a><a href="#gRPC" class="tag " data-tag="gRPC">gRPC&nbsp;(2)
                </a><a href="#%e4%ba%8b%e5%8a%a1" class="tag " data-tag="事务">事务&nbsp;(4)
                </a><a href="#%e4%bc%98%e5%8c%96%e5%99%a8" class="tag " data-tag="优化器">优化器&nbsp;(2)
                </a><a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e5%89%8d%e6%b2%bf%e6%8a%80%e6%9c%af" class="tag " data-tag="分布式系统前沿技术">分布式系统前沿技术&nbsp;(4)
                </a><a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e6%b5%8b%e8%af%95" class="tag " data-tag="分布式系统测试">分布式系统测试&nbsp;(3)
                </a><a href="#%e5%a4%87%e4%bb%bd%e6%81%a2%e5%a4%8d" class="tag " data-tag="备份恢复">备份恢复&nbsp;(2)
                </a><a href="#%e5%b7%a5%e5%85%b7" class="tag " data-tag="工具">工具&nbsp;(4)
                </a><a href="#%e6%80%a7%e8%83%bd" class="tag " data-tag="性能">性能&nbsp;(4)
                </a><a href="#%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5" class="tag " data-tag="数据同步">数据同步&nbsp;(2)
                </a><a href="#%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" class="tag " data-tag="最佳实践">最佳实践&nbsp;(6)
                </a><a href="#%e6%9e%b6%e6%9e%84" class="tag " data-tag="架构">架构&nbsp;(6)
                </a><a href="#%e7%89%88%e6%9c%ac" class="tag " data-tag="版本">版本&nbsp;(2)
                </a><a href="#%e7%a4%be%e5%8c%ba" class="tag sel" data-tag="社区">社区&nbsp;(102)
                </a><a href="#%e7%a4%be%e5%8c%ba%e5%8a%a8%e6%80%81" class="tag " data-tag="社区动态">社区动态&nbsp;(29)
                </a><a href="#%e9%9b%86%e7%be%a4%e8%b0%83%e5%ba%a6" class="tag " data-tag="集群调度">集群调度&nbsp;(2)
                </a>
    </div>
</div>
<div class="archive">
                <div class="content markdown-body">
                    <h1 class="title">DM 源码阅读系列文章（四）dump/load 全量同步的实现</h1>
                    <ul class="blog-post-meta">
                        <li class="meta-item">
                            <img src="/images/svgs/icon-date.svg" alt="Date icon">Fri, Apr 26, 2019</li>
                        <li class="meta-item">
                            <img src="/images/svgs/icon-writer.svg" alt="Pen icon">杨非</li>
                    </ul>
                    <div class="blog-text"><p>本文为 TiDB Data Migration 源码阅读系列文章的第四篇，<a href="https://pingcap.com/blog-cn/dm-source-code-reading-3/">《DM 源码阅读系列文章（三）数据同步处理单元介绍》</a> 介绍了数据同步处理单元实现的功能，数据同步流程的运行逻辑以及数据同步处理单元的 interface 设计。本篇文章在此基础上展开，详细介绍 dump 和 load 两个数据同步处理单元的设计实现，重点关注数据同步处理单元 interface 的实现，数据导入并发模型的设计，以及导入任务在暂停或出现异常后如何恢复。</p>
<h2 id="dump-">dump 处理单元</h2>
<p>dump 处理单元的代码位于 <a href="https://github.com/pingcap/dm/tree/release-1.0/mydumper">github.com/pingcap/dm/mydumper</a> 包内，作用是从上游 MySQL 将表结构和数据导出到逻辑 SQL 文件，由于该处理单元总是运行在任务的第一个阶段（full 模式和 all 模式），该处理单元每次运行不依赖于其他处理单元的处理结果。另一方面，如果在 dump 运行过程中被强制终止（例如在 dmctl 中执行 pause-task 或者 stop-task），也不会记录已经 dump 数据的 checkpoint 等信息。不记录 checkpoint 是因为每次运行 Mydumper 从上游导出数据，上游的数据都可能发生变更，为了能得到一致的数据和 metadata 信息，每次恢复任务或重新运行任务时该处理单元会 <a href="https://github.com/pingcap/dm/blob/092b5e4378ce42cf6c2488dd06498792190a091b/mydumper/mydumper.go#L68">清理旧的数据目录</a>，重新开始一次完整的数据 dump。</p>
<p>导出表结构和数据的逻辑并不是在 DM 内部直接实现，而是 <a href="https://github.com/pingcap/dm/blob/092b5e4378ce42cf6c2488dd06498792190a091b/mydumper/mydumper.go#L104">通过 <code>os/exec</code> 包调用外部 mydumper 二进制文件</a> 来完成。在 Mydumper 内部，我们需要关注以下几个问题：</p>
<ul>
<li>
<p>数据导出时的并发模型是如何实现的。</p>
</li>
<li>
<p>no-locks, lock-all-tables, less-locking 等参数有怎样的功能。</p>
</li>
<li>
<p>库表黑白名单的实现方式。</p>
</li>
</ul>
<h3 id="mydumper-">Mydumper 的实现细节</h3>
<p>Mydumper 的一次完整的运行流程从主线程开始，主线程按照以下步骤执行：</p>
<ol>
<li>
<p>解析参数。</p>
</li>
<li>
<p><a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1076">创建到数据库的连接</a>。</p>
</li>
<li>
<p>会根据 <code>no-locks</code> 选项进行一系列的备份安全策略，包括 <a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1253-L1292"><code>long query guard</code></a> 和 <a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1294-L1453"><code>lock all tables or FLUSH TABLES WITH READ LOCK</code></a>。</p>
</li>
<li>
<p><a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1469"><code>START TRANSACTION WITH CONSISTENT SNAPSHOT</code></a>。</p>
</li>
<li>
<p><a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1496-L1503">记录 binlog 位点信息</a>。</p>
</li>
<li>
<p><a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1508-L1519"><code>less locking</code> 处理线程的初始化</a>。</p>
</li>
<li>
<p><a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1525-L1530">普通导出线程初始化</a>。</p>
</li>
<li>
<p><a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1534-L1539">如果配置了 <code>trx-consistency-only</code> 选项，执行 <code>UNLOCK TABLES /* trx-only */</code> 释放之前获取的表锁。</a>注意，如果开启该选项，是无法保证非 InnoDB 表导出数据的一致性。更多关于一致性读的细节可以参考 <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-consistent-read.html">MySQL 官方文档 Consistent Nonlocking Reads 部分</a>。</p>
</li>
<li>
<p><a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1541-L1566">根据配置规则（包括 &ndash;database, &ndash;tables-list 和 &ndash;regex 配置）读取需要导出的 schema 和表信息，并在这个过程中有区分的记录 innodb_tables 和 non_innodb_table</a>。</p>
</li>
<li>
<p><a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1572-L1646">为工作子线程创建任务，并将任务 push 到相关的工作队列</a>。</p>
</li>
<li>
<p><a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1648-L1654">如果没有配置 <code>no-locks</code> 和 <code>trx-consistency-only</code> 选项，执行 UNLOCK TABLES /* FTWRL */ 释放锁</a>。</p>
</li>
<li>
<p><a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1663-L1668">如果开启 <code>less-locking</code>，等待所有 <code>less locking</code> 子线程退出</a>。</p>
</li>
<li>
<p><a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1670-L1679">等待所有工作子线程退出</a>。</p>
</li>
</ol>
<p>工作线程的并发控制包括了两个层面，一层是在不同表级别的并发，另一层是同一张表级别的并发。Mydumper 的主线程会将一次同步任务拆分为多个同步子任务，并将每个子任务分发给同一个异步队列 <code>conf.queue_less_locking/conf.queue</code>，工作子线程从队列中获取任务并执行。具体的子任务划分包括以下策略：</p>
<ul>
<li>
<p>开启 <code>less-locking</code> 选项的非 InnoDB 表的处理。</p>
<ul>
<li><a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1574-L1586">先将所有 <code>non_innodb_table</code> 分为 <code>num_threads</code> 组，分组方式是遍历这些表，依此将遍历到的表加入到当前数据量最小的分组，尽量保证每个分组内的数据量相近</a>。</li>
<li>上述得到的每个分组内会包含一个或多个非 InnoDB 表，如果配置了 <code>rows-per-file</code> 选项，会对每张表进行 <code>chunks</code> 估算，<a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L3033-L3046">对于每一张表，如果估算结果包含多个 chunks，会将子任务进一步按照 <code>chunks</code> 进行拆分，分发 <code>chunks</code> 数量个子任务</a>，<a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L3047-L3057">如果没有 <code>chunks</code> 划分，分发为一个独立的子任务</a>。</li>
<li>注意，在该模式下，子任务会 <a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L3059">发送到 <code>queue_less_locking</code></a>，并在编号为 <code>num_threads</code> ~ 2 * <code>num_threads</code> 的子线程中处理任务。
<ul>
<li><code>less_locking_threads</code> 任务执行完成之后，<a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1648-L1654">主线程就会 UNLOCK TABLES /* FTWRL */ 释放锁</a>，这样有助于减少锁持有的时间。主线程根据 <code>conf.unlock_tables</code> 来判断非 InnoDB 表是否全部导出，<a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L639-L641">普通工作线程</a> 或者 <a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L787-L789">queue_less_locking</a> 工作线程每次处理完一个非 InnoDB 表任务都会根据 <code>non_innodb_table_counter</code> 和 <code>non_innodb_done</code> 两个变量判断是否还有没有导出结束的非 InnoDB 表，如果都已经导出结束，就会向异步队列 <code>conf.unlock_tables</code> 中发送一条数据，表示可以解锁全局锁。</li>
<li>每个 <code>less_locking_threads</code> 处理非 InnoDB 表任务时，会先 <a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L771-L778">加表锁</a>，导出数据，最后 <a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L803">解锁表锁</a>。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>未开启 <code>less-locking</code> 选项的非 InnoDB 表的处理。</p>
<ul>
<li><a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1606-L1614">遍历每一张非 InnoDB 表，同样对每张表进行 <code>chunks</code> 估算，如果包含多个 <code>chunks</code>，按照 chunks 个数分发同样的子任务数；如果没有划分 <code>chunks</code>，每张表分发一个子任务。所有的任务都分发到 conf-&gt;queue 队列。</a></li>
</ul>
</li>
<li>
<p>InnoDB 表的处理。</p>
<ul>
<li>与未开启 <code>less-locking</code> 选项的非 InnoDB 表的处理相同，同样是 <a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1616-L1620">按照表分发子任务，如果有 <code>chunks</code> 子任务会进一步细分</a>。</li>
</ul>
</li>
</ul>
<p>从上述的并发模型可以看出 Mydumper 首先按照表进行同步任务拆分，对于同一张表，如果配置 <code>rows-per-file</code> 参数，会根据该参数和表行数将表划分为合适的 <code>chunks</code> 数，这即是同一张表内部的并发。具体表行数的估算和 <code>chunks</code> 划分的实现见 <a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L1885-L2004"><code>get_chunks_for_table</code></a> 函数。</p>
<p>需要注意目前 DM 在任务配置中指定的库表黑白名单功能只应用于 load 和 binlog replication 处理单元。如果在 dump 处理单元内使用库表黑白名单功能，需要在同步任务配置文件的 dump 处理单元配置提供 extra-args 参数，并指定 Mydumper 相关参数，包括 &ndash;database, &ndash;tables-list 和 &ndash;regex。Mydumper 使用 regex 过滤库表的实现参考 <a href="https://github.com/pingcap/mydumper/blob/9493dd752b9ea8804458e56a955e7f74960fa969/mydumper.c#L314-L338"><code>check_regex</code></a> 函数。</p>
<h2 id="load-">load 处理单元</h2>
<p>load 处理单元的代码位于 <a href="https://github.com/pingcap/dm/tree/master/loader">github.com/pingcap/dm/loader</a> 包内，该处理单元在 dump 处理单元运行结束后运行，读取 dump 处理单元导出的 SQL 文件解析并在下游数据库执行逻辑 SQL。我们重点分析 <code>Init</code> 和 <code>Process</code> 两个 interface 的实现。</p>
<h3 id="init-">Init 实现细节</h3>
<p>该阶段进行一些初始化和清理操作，并不会开始同步任务，如果在该阶段运行中出现错误，会通过 <a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L356-L361">rollback 机制</a> 清理资源，不需要调用 Close 函数。该阶段包含的初始化操作包括以下几点：</p>
<ul>
<li>
<p><a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L363">创建 <code>checkpoint</code></a>，<code>checkpoint</code> 用于记录全量数据的导入进度和 load 处理单元暂停或异常终止后，恢复或重新开始任务时可以从断点处继续导入数据。</p>
</li>
<li>
<p>应用任务配置的数据同步规则，包括以下规则：</p>
<ul>
<li><a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L370">初始化黑白名单</a></li>
<li><a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L380">初始化表路有规则</a></li>
<li><a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L385-L390">初始化列值转换规则</a></li>
</ul>
</li>
</ul>
<h3 id="process-">Process 实现细节</h3>
<p>该阶段的工作流程也很直观，通过 <a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L408-L422">一个收发数据类型为 <code>*pb.ProcessError</code> 的 <code>channel</code> 接收运行过程中出现的错误，出错后通过 context 的 <code>CancelFunc</code> 强制结束处理单元运行</a>。在核心的 <a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L485">数据导入函数</a> 中，工作模型与 mydumper 类似，即在 <a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L507">主线程中分发任务</a>，<a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L500-L503">有多个工作线程执行具体的数据导入任务</a>。具体的工作细节如下：</p>
<ul>
<li>
<p>主线程会按照库，表的顺序读取创建库语句文件 <code>&lt;db-name&gt;-schema-create.sql</code> 和建表语句文件 <code>&lt;db-name&gt;.&lt;table-name&gt;-schema-create.sql</code>，并在下游执行 SQL 创建相对应的库和表。</p>
</li>
<li>
<p><a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L944-L1015">主线程读取 <code>checkpoint</code> 信息，结合数据文件信息创建 fileJob 随机分发任务给一个工作子线程</a>，fileJob 任务的结构如下所示	：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">fileJob</span> <span style="color:#66d9ef">struct</span> {
   <span style="color:#a6e22e">schema</span>    <span style="color:#66d9ef">string</span>
   <span style="color:#a6e22e">table</span>     <span style="color:#66d9ef">string</span>
   <span style="color:#a6e22e">dataFile</span>  <span style="color:#66d9ef">string</span>
   <span style="color:#a6e22e">offset</span>    <span style="color:#66d9ef">int64</span> <span style="color:#75715e">// 表示读取文件的起始 offset，如果没有 checkpoint 断点信息该值为 0
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">info</span>      <span style="color:#f92672">*</span><span style="color:#a6e22e">tableInfo</span> <span style="color:#75715e">// 保存原库表，目标库表，列名，insert 语句 column 名字列表等信息
</span><span style="color:#75715e"></span>}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">
</code></pre></div></li>
<li>
<p>在每个工作线程内部，有一个循环不断从自己 <code>fileJobQueue</code> 获取任务，每次获取任务后会对文件进行解析，并将解析后的结果分批次打包为 SQL 语句分发给线程内部的另外一个工作协程，该工作协程负责处理 SQL 语句的执行。工作流程的伪代码如下所示，完整的代码参考 <a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L114-L173"><code>func (w *Worker) run()</code></a>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// worker 工作线程内分发给内部工作协程的任务结构
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">dataJob</span> <span style="color:#66d9ef">struct</span> {
   <span style="color:#a6e22e">sql</span>         <span style="color:#66d9ef">string</span> <span style="color:#75715e">// insert 语句, insert into &lt;table&gt; values (x, y, z), (x2, y2, z2), … (xn, yn, zn);
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">schema</span>      <span style="color:#66d9ef">string</span> <span style="color:#75715e">// 目标数据库
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">file</span>        <span style="color:#66d9ef">string</span> <span style="color:#75715e">// SQL 文件名
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">offset</span>      <span style="color:#66d9ef">int64</span> <span style="color:#75715e">// 本次导入数据在 SQL 文件的偏移量
</span><span style="color:#75715e"></span>   <span style="color:#a6e22e">lastOffset</span>  <span style="color:#66d9ef">int64</span> <span style="color:#75715e">// 上一次已导入数据对应 SQL 文件偏移量
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">// SQL 语句执行协程
</span><span style="color:#75715e"></span><span style="color:#a6e22e">doJob</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>() {
   <span style="color:#66d9ef">for</span> {
       <span style="color:#66d9ef">select</span> {
       <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
           <span style="color:#66d9ef">return</span>
       <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">job</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">jobQueue</span>:
           <span style="color:#a6e22e">sqls</span> <span style="color:#f92672">:=</span> []<span style="color:#66d9ef">string</span>{
               <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;USE `%s`;&#34;</span>, <span style="color:#a6e22e">job</span>.<span style="color:#a6e22e">schema</span>), <span style="color:#75715e">// 指定插入数据的 schema
</span><span style="color:#75715e"></span>               <span style="color:#a6e22e">job</span>.<span style="color:#a6e22e">sql</span>,
               <span style="color:#a6e22e">checkpoint</span>.<span style="color:#a6e22e">GenSQL</span>(<span style="color:#a6e22e">job</span>.<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">job</span>.<span style="color:#a6e22e">offset</span>), <span style="color:#75715e">// 更新 checkpoint 的 SQL 语句
</span><span style="color:#75715e"></span>           }
           <span style="color:#a6e22e">executeSQLInOneTransaction</span>(<span style="color:#a6e22e">sqls</span>) <span style="color:#75715e">// 在一个事务中执行上述 3 条 SQL 语句
</span><span style="color:#75715e"></span>       }
   }
}
<span style="color:#960050;background-color:#1e0010">​</span>
<span style="color:#75715e">// worker 主线程
</span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> {
   <span style="color:#66d9ef">select</span> {
   <span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Done</span>():
       <span style="color:#66d9ef">return</span>
   <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">job</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">fileJobQueue</span>:
       <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">doJob</span>()
       <span style="color:#a6e22e">readDataFileAndDispatchSQLJobs</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">dir</span>, <span style="color:#a6e22e">job</span>.<span style="color:#a6e22e">dataFile</span>, <span style="color:#a6e22e">job</span>.<span style="color:#a6e22e">offset</span>, <span style="color:#a6e22e">job</span>.<span style="color:#a6e22e">info</span>)
   }
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">
</code></pre></div></li>
<li>
<p><a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L192"><code>dispatchSQL</code></a> 函数负责在工作线程内部读取 SQL 文件和重写 SQL，该函数会在运行初始阶段 <a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L211">创建所操作表的 <code>checkpoint</code> 信息</a>，需要注意在任务中断恢复之后，如果这个文件的导入还没有完成，<a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/checkpoint.go#L271-L274"><code>checkpoint.Init</code> 仍然会执行，但是这次运行不会更新该文件的 <code>checkpoint</code> 信息</a>。<a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L256-L264">列值转换和库表路由也是在这个阶段内完成</a>。</p>
<ul>
<li>
<p>列值转换：需要对输入 SQL 进行解析拆分为每一个 field，对需要转换的 field 进行转换操作，然后重新拼接起 SQL 语句。详细重写流程见 <a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/convert_data.go#L293">reassemble</a> 函数。</p>
</li>
<li>
<p>库表路由：这种场景下只需要 <a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L263">替换源表到目标表</a> 即可。</p>
</li>
</ul>
</li>
<li>
<p>在工作线程执行一个批次的 SQL 语句之前，<a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/loader.go#L132-L137">会首先根据文件 <code>offset</code> 信息生成一条更新 checkpoint 的语句，加入到打包的 SQL 语句中</a>，具体执行时这些语句会 <a href="https://github.com/pingcap/dm/blob/25f95ee08d008fb6469f0b172e432270aaa6be52/loader/db.go#L152-L195">在一个事务中提交</a>，这样就保证了断点信息的准确性，如果导入过程暂停或中断，恢复任务后从断点重新同步可以保证数据一致。</p>
</li>
</ul>
<h2 id="heading">小结</h2>
<p>本篇详细介绍 dump 和 load 两个数据同步处理单元的设计实现，对核心 interface 实现、数据导入并发模型、数据导入暂停或中断的恢复进行了分析。接下来的文章会继续介绍 <code>binlog replication</code>，<code>relay log</code> 两个数据同步处理单元的实现。</p>
</div>
                </div><div class="ssba-wrap">
    <div class="ssba">
        <a class="ssba_mail_share" href="mailto:info@pingcap.com" target="_blank"
        onclick="trackViews('blog-contact-us', 'mail_to_info_view')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" width="18" height="18"><path d="M7 9L5.268 7.484.316 11.729c.18.167.423.271.691.271h11.986c.267 0 .509-.104.688-.271L8.732 7.484 7 9z"/><path d="M13.684 2.271A1.007 1.007 0 0 0 12.993 2H1.007c-.267 0-.509.104-.689.273L7 8l6.684-5.729zM0 2.878v8.308l4.833-4.107zM9.167 7.079L14 11.186V2.875z"/></svg>
        </a>
        <a id="wechat_share_btn" data-site="wechat" data-url="https://pingcap.com/blog-cn/dm-source-code-reading-4/" class="ssba_wechat_share" href="javascript:void(0)" onclick="toggleBlogQRCode()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 31.403 31.404"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"/><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"/></svg>
        </a>
    </div>
</div>

<style type="text/css">
    .fixed-qrcode {
        position: fixed;
        top: 120px;
        right: 105px;
        padding: 10px 15px;
        width: 200px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.9);
        text-align: center;
    }

    .fixed-qrcode p {
        font-size: 14px;
        font-weight: 300;
        line-height: 1.6;
        margin: 8px 0;
        color: #333;
    }

    .fixed-qrcode #close_share_qrcode {
        position: absolute;
        top: 0;
        right: 0;
        width: 30px;
        height: 30px;
        padding: 10px;
    }

    .fixed-qrcode #close_share_qrcode svg {
        display: block;
    }

    .f-hide #share_qrcode {
        visibility: hidden;
        opacity: 0;
    }

    .fixed-qrcode #share_qrcode {
        visibility: visible;
        opacity: 1;
        height: 128px;
        transition: visibility 0s linear 0s, opacity .3s 0s;
        -webkit-transition: visibility 0s linear 0s, opacity .3s 0s;
    }

    #share_qrcode img {
        margin: 0 auto;
    }
</style>
<div id="share_qrcode_outer" class="f-hide">
    <i id="close_share_qrcode"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 224.512 224.512"><path fill="#010002" d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z"/></svg></i>
    <p>分享到微信</p>
    <div id="share_qrcode"></div>
    <p>打开微信，使用 “扫一扫” 即可将网页分享至朋友圈。</p>
</div>

<script type="text/javascript" src="/js/vendor/qrcode.min.js"></script>
<script type="text/javascript">
    window.onload = function() {
        var close_share_qrcode_btn = document.getElementById('close_share_qrcode')
        var wechat_share_btn = document.getElementById('wechat_share_btn')
        var blog_url = wechat_share_btn.getAttribute('data-url')

        window.pingcap_blog_qrcode = new QRCode(
            document.getElementById('share_qrcode'),
            {
            text: blog_url,
            width: 128,
            height: 128,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
            }
        )

        close_share_qrcode_btn.addEventListener('click', function(event) {
            document
            .getElementById('share_qrcode_outer')
            .setAttribute('class', 'f-hide')
        })
    }

    function toggleBlogQRCode() {
        var qrcode_wrapper = document.getElementById('share_qrcode_outer')

        if (qrcode_wrapper.getAttribute('class') == 'f-hide') {
            qrcode_wrapper.setAttribute('class', 'fixed-qrcode')
        } else {
            qrcode_wrapper.setAttribute('class', 'f-hide')
        }
    }
</script>
</div>
        </div>
    </div>
<footer>
    <div class="container">
        <div class="flex-list-wrap">
            <div class="flex-list">
                <h4 class="list-title"><strong>产品</strong></h4>
                <ul>
                <li><a href="/docs-cn/v3.0/" onclick="trackViews('footer-product-tidb', 'docs-cn_view')">TiDB</a></li>
                <li><a href="/docs-cn/v3.0/reference/tispark/">TiSpark</a></li>
                <li><a href="/docs-cn/v3.0/roadmap/">TiDB 路线图</a></li>
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>文档</strong></h4>
                <ul>
                <li><a href="https://docs.pingcap.com/zh/tidb/v4.0/quick-start-with-tidb">快速入门</a></li>
                <li><a href="/blog-cn/tidb-best-practice/">最佳实践</a></li>
                <li><a href="/docs-cn/stable/faq/tidb/">常见问题解答</a></li>
                <li><a href="/docs-cn/stable/reference/tools/user-guide/">TiDB 周边工具</a></li>
                <li><a href="https://docs.pingcap.com/zh/tidb/dev/release-notes">版本发布说明</a></li>
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>资源</strong></h4>
                <ul>
                <li><a href="/blog-cn/">博客</a></li>
                <li><a href="https://github.com/pingcap" target="_blank">GitHub</a></li>
                <li><a href="https://book.tidb.io" target="_blank">TiDB in Action</a></li>
                <li><a href="https://university.pingcap.com/"
                    onclick="trackViews('footer-source-university', 'pingcap-university_view')" target="_blank">PingCAP
                    University</a></li>
                <li><a href="/solutions/intel/"
                    onclick="trackViews('footer-resource-solutions', 'solutions_view')" >联合解决方案</a></li>
                <li><a href="https://asktug.com/"
                    onclick="trackViews('footer-resource-asktug', 'asktug_view')" target="_blank">Ask TUG</a></li>
                
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>公司</strong></h4>
                <ul>
                <li><a href="/about-cn/">关于我们</a></li>
                <li><a href="https://job.pingcap.com/" target="_blank" onclick="trackViews('footer-recruit-join', 'recruit-join_view')">招贤纳士</a>
                </li>
                <li><a href="/about-cn/news/">新闻报道</a></li>
                <li><a href="/zh/privacy-policy/">隐私申明</a></li>
                </ul>
            </div>
        </div>
        <div class="contact-list-wrap">
            <div class="flex-list">
                <h4 class="list-title"><strong>联系我们</strong></h4>
                <ul>
                <li><a href="https://twitter.com/PingCAP" class="twitter"  target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" width="18" height="19"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"/></svg> Twitter</a></li>
                <li><a href="https://www.linkedin.com/company/pingcap/" class="linkedin" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="16" viewBox="0 0 438.536 438.535"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"/></svg> LinkedIn</a></li>
                <li><a href="https://www.reddit.com/r/TiDB/" class="reddit" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 279.748 279.748" width="18" height="18"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"/></svg> Reddit</a></li>
                <li><a href="https://groups.google.com/forum/#!forum/tidb-user" class="google-plus" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 491.858 491.858" width="18" height="20"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"/></svg> Google Group</a></li>
                <li><a href="https://stackoverflow.com/questions/tagged/tidb" class="stack-overflow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="17" viewBox="0 0 547.597 547.597"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"/><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"/><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"/></svg> Stack Overflow</a></li>
                <li id="wechat"><a class="wechat" href="javascript:void(0)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="17" viewBox="0 0 31.403 31.404"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"/><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"/></svg> 微信公众号</a> <div class="qr_code_outer f-hide f-tc">
    <div class="qr_code">
        <i id="close_qrcode"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 224.512 224.512"><path fill="#010002" d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z"/></svg></i>
        <img id="js_qr_code_img" class="qr_code_img" src="/images/wechat-qrcode.jpg" alt="Wechat qrCode" />
        <p>微信扫一扫<br> 微信ID：pingcap2015</p>
    </div>
</div>
</li>
                </ul>
            </div>
            <div class="subscribe" id="subscribe-pc"></div>
        </div>
    </div>
    <div class="container copyright-container">
        <p class="copyright">&copy; 2020 北京平凯星辰科技发展有限公司</p>
        <a href="/blog" class="copyright-btn-lang copyright-btn-en" id="lang">English</a>
        <a href="http://www.beian.miit.gov.cn/" class="prepared-num">京 ICP 备 16046278 号 - 2</a>
    </div>
</footer>
<button class="back-to-top" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 284.929 284.929"><path d="M282.082 195.285L149.028 62.24c-1.901-1.903-4.088-2.856-6.562-2.856s-4.665.953-6.567 2.856L2.856 195.285C.95 197.191 0 199.378 0 201.853c0 2.474.953 4.664 2.856 6.566l14.272 14.271c1.903 1.903 4.093 2.854 6.567 2.854s4.664-.951 6.567-2.854l112.204-112.202 112.208 112.209c1.902 1.903 4.093 2.848 6.563 2.848 2.478 0 4.668-.951 6.57-2.848l14.274-14.277c1.902-1.902 2.847-4.093 2.847-6.566.001-2.476-.944-4.666-2.846-6.569z" fill="#FFF"/></svg>
</button>
</div><div class="overlay"></div><script src="https://download.pingcap.com/js/jquery.min.js"></script><script type="text/javascript" src="/js/vendor/lazyload.min.js"></script>
    <script type="text/javascript" src="/js/doc.js"></script>
    <script type="text/javascript" src="/js/anchor.js"></script><script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script src="https://browser.sentry-cdn.com/5.11.0/bundle.min.js" integrity="sha384-jbFinqIbKkHNg+QL+yxB4VrBC0EAPTuaLGeRT0T+NfEV89YC6u1bKxHLwoo+/xxY" crossorigin="anonymous"></script><script>Sentry.init({ 
            dsn: 'https://3f28ed393c5545daa74496b3cdb2e9ba@sentry.io/1887163' 
        });</script></body></html>