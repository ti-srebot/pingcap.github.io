<!doctype html><html lang="en"><head>
<meta name="robots" content="noindex"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<script>
window.ga =
    window.ga ||
    function() {
        ;(ga.q = ga.q || []).push(arguments)
    }
ga.l = +new Date()
ga('create', 'UA-99991864-4', 'auto')
ga('send', 'pageview')
</script>
<script async src="https://download.pingcap.com/js/ga-analytics.js"></script>



<link rel="stylesheet" href="https://download.pingcap.com/style/github-markdown.css">


<link rel="stylesheet" href="/css/doc.css">

        <title>TiDB 源码阅读系列文章（二十三）Prepare/Execute 请求处理 |&nbsp;PingCAP</title><link rel="icon" href="/images/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
<meta name="description" content="在《（三）SQL 的一生》中，我们介绍了 TiDB 在收到客户端请求包时，最常见的 `Command --- COM_QUERY` 的请求处理流程。本文我们将介绍另外一种大家经常使用的 `Command --- Prepare/Execute` 请求在 TiDB 中的处理过程。">
<meta name="robots" content="noodp">
<meta name="keywords" content="TiDB, MySQL, HTAP, Open Source, Cloud-Native, NewSQL, Aurora Alternative">
<meta property="og:locale" content="en_US">
<meta property="og:type" content="website">
<meta property="og:title" content="TiDB 源码阅读系列文章（二十三）Prepare/Execute 请求处理 | PingCAP">
<meta property="og:description" content="在《（三）SQL 的一生》中，我们介绍了 TiDB 在收到客户端请求包时，最常见的 `Command --- COM_QUERY` 的请求处理流程。本文我们将介绍另外一种大家经常使用的 `Command --- Prepare/Execute` 请求在 TiDB 中的处理过程。">
<meta property="og:url" content="https://pingcap.com/blog-cn/tidb-source-code-reading-23/">
<meta property="og:site_name" content="MySQL at Scale. No more manual sharding">
<meta property="og:image" content="/images/pingcap-opengraph.jpg">
<meta property="og:image:secure_url" content="/images/pingcap-opengraph.jpg"><meta name="twitter:card" content="summary"><meta name="twitter:description" content="在《（三）SQL 的一生》中，我们介绍了 TiDB 在收到客户端请求包时，最常见的 `Command --- COM_QUERY` 的请求处理流程。本文我们将介绍另外一种大家经常使用的 `Command --- Prepare/Execute` 请求在 TiDB 中的处理过程。">
<meta name="twitter:title" content="TiDB 源码阅读系列文章（二十三）Prepare/Execute 请求处理 | PingCAP">
<meta name="twitter:site" content="@pingcap">
<meta name="twitter:image" content="https://download.pingcap.com/images/pingcap-opengraph.jpg"><meta name="twitter:creator" content="@pingcap">





<script type="application/ld+json">
{
    "@context": "http:\/\/schema.org",
    "@type": "WebSite",
    "url": "https:\/\/pingcap.com\/",
    "name": "PingCAP",
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https:\/\/pingcap.com\/?s={search_term_string}",
        "query-input": "required name=search_term_string"
    }
}
</script>


<script>
    (function(){
        var bp = document.createElement('script');
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>


<script type="text/javascript" async src="https://accounts.pingcap.com/static/pingcap_sso/js/track.beta.js"></script>
    
<link rel="preload" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.woff" as="font" type="font/woff" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.ttf" as="font" type="font/ttf" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff" as="font" type="font/woff" crossorigin="anonymous">
<link rel="preload" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.ttf" as="font" type="font/ttf" crossorigin="anonymous">

<link rel="preload" href="https://download.pingcap.com/js/jquery.min.js" as="script">


<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="https://download.pingcap.com/style/docsearch.min.css">
<script type="text/javascript">
var trackOutboundLink = function(url) {
  var redirectTriggered = false
  ga('send', 'event', 'outbound', 'click', url, {
    hitCallback: function() {
      redirectTriggered = true
      document.location = url
    }
  })
  setTimeout(function() {
    if (!redirectTriggered) {
      document.location = url
    }
  }, 1500)
}

var trackViews = function(btn_type, event_category) {
  var event_label = btn_type
  var eventCategory = event_category
  ga('send', 'event', {
    'eventCategory': eventCategory,
    'eventAction': 'click',
    'eventLabel': event_label,
    'transport': 'beacon'
  });
}
</script>
<script>if (location.pathname === '/') {
        if (location.hostname === 'pingcap.github.io') {
            location.href = '/en/'
        }
    }</script></head>       <body data-lang="cn" ><div id="page-content">
<header role="navigation" class="fixed-top">
    <div class="container">
        <a class="nav-brand" href="/zh"><img src="/images/pingcap-logo.png" alt="PingCAP"></a>
        <div class="nav-wrapper">
            <div class="navigation">
                <ul>
                    <li><a href="https://university.pingcap.com/" target="_blank" class="nav-blinking"
                            onclick="trackViews('navbar-university', 'pingcap-university_view')">PingCAP
                            University</a></li>
                    <li class="docs-type-selector " id="docsTypeSelector">
                        
                        <a class="header-doc-nav" href="https://docs.pingcap.com/zh" target="_blank">文档</a>
                    </li>
                    <li ><a href="/cases-cn">案例</a></li>
                    <li ><a href="/community-cn">社区</a></li>
                    <li class="sel" ><a href="/blog-cn">博客</a></li>
                    <li ><a href="/about-cn">关于</a></li>
                    <li><a href="https://asktug.com" target="_blank"
                            onclick="trackViews('navbar-asktug', 'asktug_view')">问答</a></li>
                    <li ><a href="/download-cn">下载试用</a></li>
                    <li><a class="link-download" href="mailto:info@pingcap.com" target="_blank"
                            onclick="trackViews('navbar-contact-us', 'mail_to_info_view')">联系我们</a></li>
                </ul>
            </div>
            <div class="global-search">
                
                
                
                <div class="search-wrapper">
    <span class="icon-search"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="#fff" viewBox="0 0 67.125 67.125"><path d="M23.902 0C11.01 0 .523 10.488.523 23.38c0 12.891 10.487 23.379 23.379 23.379a23.258 23.258 0 0 0 14.471-5.037l24.816 24.817c.391.391.902.586 1.414.586s1.023-.195 1.414-.586a2 2 0 0 0 0-2.828L41.293 38.985c3.721-4.142 5.989-9.613 5.989-15.605C47.282 10.488 36.794 0 23.902 0zM4.523 23.38C4.523 12.694 13.216 4 23.902 4c10.687 0 19.38 8.694 19.38 19.38 0 5.396-2.221 10.279-5.791 13.795a1.959 1.959 0 0 0-.488.349 2.003 2.003 0 0 0-.271.343C33.31 40.9 28.825 42.76 23.903 42.76c-10.686-.001-19.38-8.695-19.38-19.38z"/><path d="M24.075 8.591c-8.25 0-14.962 6.712-14.962 14.962a2 2 0 0 0 4 0c0-6.044 4.918-10.962 10.962-10.962a2 2 0 0 0 0-4z"/></svg></span>
    <input data-lang="cn" data-type="" type="search" id="search-input" name="q"
        placeholder="搜索 TiDB 文档">
</div>

<script>
    const inputNode = document.getElementById("search-input")

    inputNode.addEventListener('keyup', ({key}) => {
        if (key === "Enter") {
            if ($('#search-input').data('lang') == 'cn') {
                lang = 'zh'
            }

            const query = $('#search-input').val()
            if (query) {
                url = "https://docs.pingcap.com/" + (lang == 'zh' ? 'zh/' : '') + "search/?lang=" + lang + "&type=tidb&version=v4.0&q=" + query
                window.location.href = url
            }
        }
    })
</script>

            </div>
        </div>
        <div class="nav-btn nav-slider">
            <i class="material-icons"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 459 459"><path d="M0 382.5h459v-51H0v51zM0 255h459v-51H0v51zM0 76.5v51h459v-51H0z" fill="#FFF"/></svg></i>
        </div>
    </div>
</header>



<nav class="mobile-sidebar">
    <div class="nav-header">
        <div class="logo-wrap">
        <a class="nav-brand" href="/en"><img src="/images/pingcap-logo.png" alt="PingCAP"></a>
        </div>
    </div>
    <ul class="ul-base">
        

        <li ><a href="https://docs.pingcap.com/zh/tidb/v4.0/">文档</a></li>
        <li ><a href="/cases-cn">案例</a></li>
        <li ><a href="/community-cn">社区</a></li>
        <li class="sel"><a href="/blog-cn">博客</a></li>
        <li ><a href="/about-cn">关于</a></li>
        <li><a href="https://asktug.com" target="_blank"
            onclick="trackViews('navbar-asktug', 'asktug_view')">问答</a></li>
        <li ><a href="/download-cn">下载试用</a></li>
        <li><a class="link-download" href="mailto:info@pingcap.com" target="_blank"
            onclick="trackViews('navbar-contact-us', 'mail_to_info_view')">联系我们</a></li>
        <li><a href="https://university.pingcap.com/"
            onclick="trackViews('navbar-university', 'pingcap-university_view')" target="_blank"
            class="nav-blinking">PingCAP University</a></li>
    </ul>
    <div class="nav-footer">
        <div class="contact-list-wrap">
        <div class="flex-list">
            <h4 class="list-title"><strong>Contact</strong></h4>
            <ul class="social social-cn ul-base">
            <li><a href="https://twitter.com/PingCAP" class="twitter" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" width="18" height="18"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"/></svg></a></li>
            <li><a href="https://www.linkedin.com/company/pingcap/" class="linkedin" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 438.536 438.535"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"/></svg></a></li>
            <li><a href="https://www.reddit.com/r/TiDB/" class="reddit" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 279.748 279.748" width="18" height="18"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"/></svg></a></li>
            <li><a href="https://groups.google.com/forum/#!forum/tidb-user" class="google-plus" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 491.858 491.858" width="18" height="18"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"/></svg></a></li>
            <li><a href="https://stackoverflow.com/questions/tagged/tidb" class="stack-overflow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 547.597 547.597"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"/><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"/><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"/></svg></a></li>
            <li id="wechat-mobile"><a class="wechat" href="javascript:void(0)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 31.403 31.404"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"/><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"/></svg></a><div class="qr_code_outer f-hide f-tc">
    <div class="qr_code">
        <i id="close_qrcode"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 224.512 224.512"><path fill="#010002" d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z"/></svg></i>
        <img id="js_qr_code_img" class="qr_code_img" src="/images/wechat-qrcode.jpg" alt="Wechat qrCode" />
        <p>微信扫一扫<br> 微信ID：pingcap2015</p>
    </div>
</div>
</li>
            </ul>
        </div>
        <div class="subscribe" id="subscribe-mobile"></div>
        </div>
        <div class="container">
        <a href="/blog" class="btn-lang" id="lang">English</a>
        </div>
    </div>
</nav>

<div class="blog">
        <div class="container">
<div class="sidebar nav-tags" data-type="single"><div class="title">热门标签<a class="rss" href="/blog-cn/index.xml" title="RSS Feed"><svg xmlns="http://www.w3.org/2000/svg" width="13" height="17" viewBox="0 0 402.041 402.04"><g fill="#3A59F0"><path d="M54.816 292.382c-15.229 0-28.169 5.331-38.831 15.988C5.33 319.026 0 331.969 0 347.197c0 15.232 5.325 28.172 15.985 38.828 10.662 10.657 23.606 15.988 38.831 15.988 15.227 0 28.168-5.331 38.828-15.988 10.656-10.656 15.986-23.596 15.986-38.828 0-15.229-5.33-28.171-15.986-38.827-10.657-10.657-23.598-15.988-38.828-15.988zM181.01 221.002c-21.51-21.698-46.158-38.97-73.948-51.816-27.79-12.85-56.914-20.511-87.366-22.985h-1.425c-4.949 0-9.042 1.619-12.275 4.854C1.997 154.477 0 158.953 0 164.472v38.543c0 4.757 1.569 8.85 4.708 12.279 3.14 3.429 7.089 5.332 11.848 5.708 43.586 4.189 80.845 21.752 111.773 52.678 30.93 30.926 48.49 68.187 52.677 111.771.382 4.764 2.284 8.712 5.712 11.847 3.427 3.148 7.517 4.72 12.275 4.72h38.545c5.517 0 9.989-1.995 13.415-5.996 3.621-3.812 5.236-8.381 4.863-13.709-2.478-30.447-10.14-59.573-22.987-87.361-12.846-27.792-30.121-52.438-51.819-73.95z"/><path d="M367.728 239.701c-20.365-45.585-48.345-86.078-83.936-121.482-35.405-35.594-75.896-63.572-121.485-83.939C116.723 13.917 68.996 2.494 19.126.02h-.855c-4.949 0-9.136 1.713-12.563 5.14C1.903 8.583 0 12.964 0 18.294v40.825c0 4.76 1.667 8.897 4.996 12.419 3.33 3.523 7.373 5.376 12.132 5.57 40.924 2.478 79.799 12.188 116.63 29.127 36.83 16.94 68.806 38.972 95.93 66.09 27.118 27.123 49.149 59.101 66.089 95.931 16.94 36.836 26.557 75.705 28.839 116.627.195 4.764 2.046 8.809 5.564 12.139 3.524 3.329 7.762 4.999 12.71 4.999h40.823c5.331 0 9.701-1.902 13.134-5.715 3.809-3.806 5.517-8.274 5.144-13.415-2.471-49.874-13.898-97.6-34.263-143.19z"/></g></svg></a></div><a href="#" class="tag all">ALL (254)</a>
    <div class="tag-list"><a href="#Chaos-Mesh" class="tag " data-tag="Chaos-Mesh">Chaos Mesh&nbsp;(7)
                </a><a href="#Committer" class="tag " data-tag="Committer">Committer&nbsp;(3)
                </a><a href="#Contributor" class="tag " data-tag="Contributor">Contributor&nbsp;(9)
                </a><a href="#DM" class="tag " data-tag="DM">DM&nbsp;(2)
                </a><a href="#DM-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb" class="tag " data-tag="DM-源码阅读">DM 源码阅读&nbsp;(10)
                </a><a href="#Go" class="tag " data-tag="Go">Go&nbsp;(3)
                </a><a href="#HTAP" class="tag " data-tag="HTAP">HTAP&nbsp;(3)
                </a><a href="#Hackathon" class="tag " data-tag="Hackathon">Hackathon&nbsp;(4)
                </a><a href="#K8s" class="tag " data-tag="K8s">K8s&nbsp;(2)
                </a><a href="#Key-Visualizer" class="tag " data-tag="Key-Visualizer">Key Visualizer&nbsp;(2)
                </a><a href="#Kubernetes" class="tag " data-tag="Kubernetes">Kubernetes&nbsp;(3)
                </a><a href="#Linux" class="tag " data-tag="Linux">Linux&nbsp;(4)
                </a><a href="#MVCC" class="tag " data-tag="MVCC">MVCC&nbsp;(2)
                </a><a href="#MySQL" class="tag " data-tag="MySQL">MySQL&nbsp;(2)
                </a><a href="#PD" class="tag " data-tag="PD">PD&nbsp;(5)
                </a><a href="#Percolator" class="tag " data-tag="Percolator">Percolator&nbsp;(2)
                </a><a href="#PingCAP" class="tag " data-tag="PingCAP">PingCAP&nbsp;(2)
                </a><a href="#Prometheus" class="tag " data-tag="Prometheus">Prometheus&nbsp;(3)
                </a><a href="#Raft" class="tag " data-tag="Raft">Raft&nbsp;(11)
                </a><a href="#RocksDB" class="tag " data-tag="RocksDB">RocksDB&nbsp;(3)
                </a><a href="#Rust" class="tag " data-tag="Rust">Rust&nbsp;(5)
                </a><a href="#SQL" class="tag " data-tag="SQL">SQL&nbsp;(6)
                </a><a href="#Spanner" class="tag " data-tag="Spanner">Spanner&nbsp;(2)
                </a><a href="#TiDB" class="tag " data-tag="TiDB">TiDB&nbsp;(79)
                </a><a href="#TiDB-4.0-%e6%96%b0%e7%89%b9%e6%80%a7" class="tag " data-tag="TiDB-4.0-新特性">TiDB 4.0 新特性&nbsp;(11)
                </a><a href="#TiDB-Binlog" class="tag " data-tag="TiDB-Binlog">TiDB Binlog&nbsp;(5)
                </a><a href="#TiDB-Binlog-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb" class="tag " data-tag="TiDB-Binlog-源码阅读">TiDB Binlog 源码阅读&nbsp;(9)
                </a><a href="#TiDB-Ecosystem-Tools" class="tag " data-tag="TiDB-Ecosystem-Tools">TiDB Ecosystem Tools&nbsp;(3)
                </a><a href="#TiDB-Operator" class="tag " data-tag="TiDB-Operator">TiDB Operator&nbsp;(5)
                </a><a href="#TiDB-%e6%80%a7%e8%83%bd%e6%8c%91%e6%88%98%e8%b5%9b" class="tag " data-tag="TiDB-性能挑战赛">TiDB 性能挑战赛&nbsp;(2)
                </a><a href="#TiDB-%e6%98%93%e7%94%a8%e6%80%a7%e6%8c%91%e6%88%98%e8%b5%9b" class="tag " data-tag="TiDB-易用性挑战赛">TiDB 易用性挑战赛&nbsp;(4)
                </a><a href="#TiDB-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb" class="tag sel" data-tag="TiDB-源码阅读">TiDB 源码阅读&nbsp;(24)
                </a><a href="#TiFlash" class="tag " data-tag="TiFlash">TiFlash&nbsp;(7)
                </a><a href="#TiKV" class="tag " data-tag="TiKV">TiKV&nbsp;(28)
                </a><a href="#TiKV-%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90" class="tag " data-tag="TiKV-源码解析">TiKV 源码解析&nbsp;(20)
                </a><a href="#TiSpark" class="tag " data-tag="TiSpark">TiSpark&nbsp;(4)
                </a><a href="#WebAssembly" class="tag " data-tag="WebAssembly">WebAssembly&nbsp;(2)
                </a><a href="#gRPC" class="tag " data-tag="gRPC">gRPC&nbsp;(2)
                </a><a href="#%e4%ba%8b%e5%8a%a1" class="tag " data-tag="事务">事务&nbsp;(4)
                </a><a href="#%e4%bc%98%e5%8c%96%e5%99%a8" class="tag " data-tag="优化器">优化器&nbsp;(2)
                </a><a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e5%89%8d%e6%b2%bf%e6%8a%80%e6%9c%af" class="tag " data-tag="分布式系统前沿技术">分布式系统前沿技术&nbsp;(4)
                </a><a href="#%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e6%b5%8b%e8%af%95" class="tag " data-tag="分布式系统测试">分布式系统测试&nbsp;(3)
                </a><a href="#%e5%a4%87%e4%bb%bd%e6%81%a2%e5%a4%8d" class="tag " data-tag="备份恢复">备份恢复&nbsp;(2)
                </a><a href="#%e5%b7%a5%e5%85%b7" class="tag " data-tag="工具">工具&nbsp;(4)
                </a><a href="#%e6%80%a7%e8%83%bd" class="tag " data-tag="性能">性能&nbsp;(4)
                </a><a href="#%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5" class="tag " data-tag="数据同步">数据同步&nbsp;(2)
                </a><a href="#%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5" class="tag " data-tag="最佳实践">最佳实践&nbsp;(6)
                </a><a href="#%e6%9e%b6%e6%9e%84" class="tag " data-tag="架构">架构&nbsp;(6)
                </a><a href="#%e7%89%88%e6%9c%ac" class="tag " data-tag="版本">版本&nbsp;(2)
                </a><a href="#%e7%a4%be%e5%8c%ba" class="tag sel" data-tag="社区">社区&nbsp;(102)
                </a><a href="#%e7%a4%be%e5%8c%ba%e5%8a%a8%e6%80%81" class="tag " data-tag="社区动态">社区动态&nbsp;(29)
                </a><a href="#%e9%9b%86%e7%be%a4%e8%b0%83%e5%ba%a6" class="tag " data-tag="集群调度">集群调度&nbsp;(2)
                </a>
    </div>
</div>
<div class="archive">
                <div class="content markdown-body">
                    <h1 class="title">TiDB 源码阅读系列文章（二十三）Prepare/Execute 请求处理</h1>
                    <ul class="blog-post-meta">
                        <li class="meta-item">
                            <img src="/images/svgs/icon-date.svg" alt="Date icon">Thu, Jan 3, 2019</li>
                        <li class="meta-item">
                            <img src="/images/svgs/icon-writer.svg" alt="Pen icon">苏立</li>
                    </ul>
                    <div class="blog-text"><p>在之前的一篇文章<a href="https://pingcap.com/blog-cn/tidb-source-code-reading-3/">《TiDB 源码阅读系列文章（三）SQL 的一生》</a>中，我们介绍了 TiDB 在收到客户端请求包时，最常见的 <code>Command --- COM_QUERY</code> 的请求处理流程。本文我们将介绍另外一种大家经常使用的 <code>Command --- Prepare/Execute</code> 请求在 TiDB 中的处理过程。</p>
<h2 id="prepareexecute-statement-">Prepare/Execute Statement 简介</h2>
<p>首先我们先简单回顾下客户端使用 Prepare 请求过程：</p>
<ol>
<li>
<p>客户端发起 Prepare 命令将带 “?” 参数占位符的 SQL 语句发送到数据库，成功后返回 <code>stmtID</code>。</p>
</li>
<li>
<p>具体执行 SQL 时，客户端使用之前返回的 <code>stmtID</code>，并带上请求参数发起 Execute 命令来执行 SQL。</p>
</li>
<li>
<p>不再需要 Prepare 的语句时，关闭 <code>stmtID</code> 对应的 Prepare 语句。</p>
</li>
</ol>
<p>相比普通请求，Prepare 带来的好处是：</p>
<ul>
<li>
<p>减少每次执行经过 Parser 带来的负担，因为很多场景，线上运行的 SQL 多是相同的内容，仅是参数部分不同，通过 Prepare 可以通过首次准备好带占位符的 SQL，后续只需要填充参数执行就好，可以做到“一次 Parse，多次使用”。</p>
</li>
<li>
<p>在开启 PreparePlanCache 后可以达到“一次优化，多次使用”，不用进行重复的逻辑和物理优化过程。</p>
</li>
<li>
<p>更少的网络传输，因为多次执行只用传输参数部分，并且返回结果 Binary 协议。</p>
</li>
<li>
<p>因为是在执行的同时填充参数，可以防止 SQL 注入风险。</p>
</li>
<li>
<p>某些特性比如 serverSideCursor 需要是通过 Prepare statement 才能使用。</p>
</li>
</ul>
<p>TiDB 和 <a href="https://dev.mysql.com/doc/refman/5.7/en/sql-prepared-statements.html">MySQL 协议</a> 一样，对于发起 Prepare/Execute 这种使用访问模式提供两种方式：</p>
<ul>
<li>
<p>Binary 协议：即上述的使用 <code>COM_STMT_PREPARE</code>，<code>COM_STMT_EXECUTE</code>，<code>COM_STMT_CLOSE</code> 命令并且通过 Binary 协议获取返回结果，这是目前各种应用开发常使用的方式。</p>
</li>
<li>
<p>文本协议：使用 <code>COM_QUERY</code>，并且用 <code>PREPARE</code>，<code>EXECUTE</code>，<code>DEALLOCATE PREPARE</code> 使用文本协议获取结果，这个效率不如上一种，多用于非程序调用场景，比如在 MySQL 客户端中手工执行。</p>
</li>
</ul>
<p>下面我们主要以 Binary 协议来看下 TiDB 的处理过程。文本协议的处理与 Binary 协议处理过程比较类似，我们会在后面简要介绍一下它们的差异点。</p>
<h2 id="com-stmt-prepare"><code>COM_STMT_PREPARE</code></h2>
<p>首先，客户端发起 <code>COM_STMT_PREPARE</code>，在 TiDB 收到后会进入 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/server/conn_stmt.go#L51"><code>clientConn#handleStmtPrepare</code></a>，这个函数会通过调用 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/server/driver_tidb.go#L305"><code>TiDBContext#Prepare</code></a> 来进行实际 Prepare 操作并返回 <a href="https://dev.mysql.com/doc/internals/en/com-stmt-prepare-response.html">结果</a> 给客户端，实际的 Prepare 处理主要在 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/session/session.go#L924"><code>session#PrepareStmt</code></a> 和 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/executor/prepared.go#L73"><code>PrepareExec</code></a> 中完成：</p>
<ol>
<li>
<p>调用 Parser 完成文本到 AST 的转换，这部分可以参考<a href="https://pingcap.com/blog-cn/tidb-source-code-reading-5/">《TiDB 源码阅读系列文章（五）TiDB SQL Parser 的实现》</a>。</p>
</li>
<li>
<p>使用名为 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/executor/prepared.go#L57"><code>paramMarkerExtractor</code></a> 的 visitor 从 AST 中提取 “?” 表达式，并根据出现位置（offset）构建排序 Slice，后面我们会看到在 Execute 时会通过这个 Slice 值来快速定位并替换 “?” 占位符。</p>
</li>
<li>
<p>检查参数个数是否超过 Uint16 最大值（这个是 <a href="https://dev.mysql.com/doc/internals/en/com-stmt-prepare-response.html">协议限制</a>，对于参数只提供 2 个 Byte）。</p>
</li>
<li>
<p>进行 Preprocess， 并且创建 LogicPlan， 这部分实现可以参考之前关于 <a href="https://pingcap.com/blog-cn/tidb-source-code-reading-7/">逻辑优化的介绍</a>，这里生成 LogicPlan 主要为了获取并检查组成 Prepare 响应中需要的列信息。</p>
</li>
<li>
<p>生成 <code>stmtID</code>，生成的方式是当前会话中的递增 int。</p>
</li>
<li>
<p>保存 <code>stmtID</code> 到 <code>ast.Prepared</code> (由 AST，参数类型信息，schema 版本，是否使用 <code>PreparedPlanCache</code> 标记组成) 的映射信息到 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/sessionctx/variable/session.go#L185"><code>SessionVars#PreparedStmts</code></a> 中供 Execute 部分使用。</p>
</li>
<li>
<p>保存 <code>stmtID</code> 到 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/server/driver_tidb.go#L57"><code>TiDBStatement</code></a> （由 <code>stmtID</code>，参数个数，SQL 返回列类型信息，<code>sendLongData</code> 预 <code>BoundParams</code> 组成）的映射信息保存到 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/server/driver_tidb.go#L53"><code>TiDBContext#stmts</code></a>。</p>
</li>
</ol>
<p>在处理完成之后客户端会收到并持有 <code>stmtID</code> 和参数类型信息，返回列类型信息，后续即可通过 <code>stmtID</code> 进行执行时，server 可以通过 6、7 步保存映射找到已经 Prepare 的信息。</p>
<h2 id="com-stmt-execute"><code>COM_STMT_EXECUTE</code></h2>
<p>Prepare 成功之后，客户端会通过 <code>COM_STMT_EXECUTE</code> 命令请求执行，TiDB 会进入 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/server/conn_stmt.go#L108"><code>clientConn#handleStmtExecute</code></a>，首先会通过 stmtID 在上节介绍中保存的 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/server/driver_tidb.go#L53"><code>TiDBContext#stmts</code></a> 中获取前面保存的 <code>TiDBStatement</code>，并解析出是否使用 <code>userCursor</code> 和请求参数信息，并且调用对应 <code>TiDBStatement</code> 的 Execute 进行实际的 Execute 逻辑：</p>
<ol>
<li>
<p>生成 <a href="https://github.com/pingcap/parser/blob/732efe993f70da99fdc18acb380737be33f2333a/ast/misc.go#L218"><code>ast.ExecuteStmt</code></a> 并调用 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/planner/optimize.go#L28"><code>planer.Optimize</code></a> 生成 <code>plancore.Execute</code>，和普通优化过程不同的是会执行 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/planner/optimize.go#L53"><code>Exeucte#OptimizePreparedPlan</code></a>。</p>
</li>
<li>
<p>使用 <code>stmtID</code> 通过 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/sessionctx/variable/session.go#L190"><code>SessionVars#PreparedStmts</code></a> 获取到到 Prepare 阶段的 <code>ast.Prepared</code> 信息。</p>
</li>
<li>
<p>使用上一节第 2 步中准备的 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/planner/core/common_plans.go#L167"><code>prepared.Params</code></a> 来快速查找并填充参数值；同时会保存一份参数到 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/sessionctx/variable/session.go#L190"><code>sessionVars.PreparedParams</code></a> 中，这个主要用于支持 <code>PreparePlanCache</code> 延迟获取参数。</p>
</li>
<li>
<p>判断对比判断 Prepare 和 Execute 之间 schema 是否有变化，如果有变化则重新 Preprocess。</p>
</li>
<li>
<p>之后调用 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/planner/core/common_plans.go#L188"><code>Execute#getPhysicalPlan</code></a> 获取物理计划，实现中首先会根据是否启用 PreparedPlanCache 来查找已缓存的 Plan，本文后面我们也会专门介绍这个。</p>
</li>
<li>
<p>在没有开启 PreparedPlanCache 或者开启了但没命中 cache 时，会对 AST 进行一次正常的 Optimize。</p>
</li>
</ol>
<p>在获取到 PhysicalPlan 后就是正常的 <a href="https://zhuanlan.zhihu.com/p/35134962">Executing 执行</a>。</p>
<h2 id="com-stmt-close"><code>COM_STMT_CLOSE</code></h2>
<p>在客户不再需要执行之前的 Prepared 的语句时，可以通过 <code>COM_STMT_CLOSE</code> 来释放服务器资源，TiDB 收到后会进入 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/server/conn_stmt.go#L501"><code>clientConn#handleStmtClose</code></a>，会通过 <code>stmtID</code> 在 <code>TiDBContext#stmts</code> 中找到对应的 <code>TiDBStatement</code>，并且执行 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/server/driver_tidb.go#L152">Close</a> 清理之前的保存的 <code>TiDBContext#stmts</code> 和 <code>SessionVars#PrepareStmts</code>，不过通过代码我们看到，对于前者的确直接进行了清理，对于后者不会删除而是加入到 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/session/session.go#L1020"><code>RetryInfo#DroppedPreparedStmtIDs</code></a> 中，等待当前事务提交或回滚才会从 <code>SessionVars#PrepareStmts</code> 中清理，之所以延迟删除是由于 TiDB 在事务提交阶段遇到冲突会根据配置决定是否重试事务，参与重试的语句可能只有 Execute 和 Deallocate，为了保证重试还能通过 <code>stmtID</code> 找到 prepared 的语句 TiDB 目前使用延迟到事务执行完成后才做清理。</p>
<h2 id="-com-stmt">其他 <code>COM_STMT</code></h2>
<p>除了上面介绍的 3 个 <code>COM_STMT</code>，还有另外几个 <code>COM_STMT_SEND_LONG_DATA</code>，<code>COM_STMT_FETCH</code>，<code>COM_STMT_RESET</code> 也会在 Prepare 中使用到。</p>
<h3 id="com-stmt-send-long-data"><code>COM_STMT_SEND_LONG_DATA</code></h3>
<p>某些场景我们 SQL 中的参数是 <code>TEXT</code>，<code>TINYTEXT</code>，<code>MEDIUMTEXT</code>，<code>LONGTEXT</code> and <code>BLOB</code>，<code>TINYBLOB</code>，<code>MEDIUMBLOB</code>，<code>LONGBLOB</code> 列时，客户端通常不会在一次 Execute 中带大量的参数，而是单独通过 <a href="https://dev.mysql.com/doc/internals/en/com-stmt-send-long-data.html"><code>COM_SEND_LONG_DATA</code></a> 预先发到 TiDB，最后再进行 Execute。</p>
<p>TiDB 的处理在 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/server/conn_stmt.go#L514"><code>client#handleStmtSendLongData</code></a>，通过 <code>stmtID</code> 在 <code>TiDBContext#stmts</code> 中找到 <code>TiDBStatement</code> 并提前放置 <code>paramID</code> 对应的参数信息，进行追加参数到 <code>boundParams</code>（所以客户端其实可以多次 send 数据并追加到一个参数上），Execute 时会通过 <code>stmt.BoundParams()</code> 获取到提前传过来的参数并和 Execute 命令带的参数 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/server/conn_stmt.go#L176">一起执行</a>，在每次执行完成后会重置 <code>boundParams</code>。</p>
<h3 id="com-stmt-fetch"><code>COM_STMT_FETCH</code></h3>
<p>通常的 Execute 执行后，TiDB 会向客户端持续返回结果，返回速率受 <code>max_chunk_size</code> 控制（见《<a href="https://pingcap.com/blog-cn/tidb-source-code-reading-10/">TiDB 源码阅读系列文章（十）Chunk 和执行框架简介</a>》）， 但实际中返回的结果集可能非常大。客户端受限于资源（一般是内存）无法一次处理那么多数据，就希望服务端一批批返回，<a href="https://dev.mysql.com/doc/internals/en/com-stmt-fetch.html"><code>COM_STMT_FETCH</code></a> 正好解决这个问题。</p>
<p>它的使用首先要和 <code>COM_STMT_EXECUTE</code> 配合（也就是必须使用 Prepared 语句执行）， <code>handleStmtExeucte</code> 请求协议 flag 中有标记要使用 cursor，execute 在完成 plan 拿到结果集后并不立即执行而是把它缓存到 <code>TiDBStatement</code> 中，并立刻向客户端回包中带上列信息并标记 <a href="https://dev.mysql.com/doc/internals/en/status-flags.html"><code>ServerStatusCursorExists</code></a>，这部分逻辑可以参看 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/server/conn_stmt.go#L193"><code>handleStmtExecute</code></a>。</p>
<p>客户端看到 <code>ServerStatusCursorExists</code> 后，会用 <code>COM_STMT_FETCH</code> 向 TiDB 拉去指定 fetchSize 大小的结果集，在 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/server/conn_stmt.go#L210"><code>connClient#handleStmtFetch</code></a> 中，会通过 session 找到 <code>TiDBStatement</code> 进而找到之前缓存的结果集，开始实际调用执行器的 Next 获取满足 fetchSize 的数据并返回客户端，如果执行器一次 Next 超过了 fetchSize 会只返回 fetchSize 大小的数据并把剩下的数据留着下次再给客户端，最后对于结果集最后一次返回会标记 <a href="https://dev.mysql.com/doc/internals/en/status-flags.html"><code>ServerStatusLastRowSend</code></a> 的 flag 通知客户端没有后续数据。</p>
<h3 id="com-stmt-reset"><code>COM_STMT_RESET</code></h3>
<p>主要用于客户端主动重置 <code>COM_SEND_LONG_DATA</code> 发来的数据，正常 <code>COM_STMT_EXECUTE</code> 后会自动重置，主要针对客户端希望主动废弃之前数据的情况，因为 <code>COM_STMT_SEND_LONG_DATA</code> 是一直追加的操作，客户端某些场景需要主动放弃之前预存的参数，这部分逻辑主要位于 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/server/conn_stmt.go#L531"><code>connClient#handleStmtReset</code></a> 中。</p>
<h2 id="prepared-plan-cache">Prepared Plan Cache</h2>
<p>通过前面的解析过程我们看到在 Prepare 时完成了 AST 转换，在之后的 Execute 会通过 <code>stmtID</code> 找之前的 AST 来进行 Plan 跳过每次都进行 Parse SQL 的开销。如果开启了 Prepare Plan Cache，可进一步在 Execute 处理中重用上次的 PhysicalPlan 结果，省掉查询优化过程的开销。</p>
<p>TiDB 可以通过 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/config/config.toml.example#L167">修改配置文件</a> 开启 Prepare Plan Cache， 开启后每个新 Session 创建时会初始化一个 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/util/kvcache/simple_lru.go#L38"><code>SimpleLRUCache</code></a> 类型的 <code>preparedPlanCache</code> 用于保存用于缓存 Plan 结果，缓存的 key 是 <code>pstmtPlanCacheKey</code>（由当前 DB，连接 ID，<code>statementID</code>，<code>schemaVersion</code>， <code>snapshotTs</code>，<code>sqlMode</code>，<code>timezone</code> 组成，所以要命中 plan cache 这以上元素必须都和上次缓存的一致），并根据配置的缓存大小和内存大小做 LRU。</p>
<p>在 Execute 的处理逻辑 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/executor/prepared.go#L161"><code>PrepareExec</code></a> 中除了检查 <code>PreparePlanCache</code> 是否开启外，还会判断当前的语句是否能使用 <code>PreparePlanCache</code>。</p>
<ol>
<li>
<p>只有 <code>SELECT</code>，<code>INSERT</code>，<code>UPDATE</code>，<code>DELETE</code> 有可能可以使用 <code>PreparedPlanCache</code>	。</p>
</li>
<li>
<p>并进一步通过 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/planner/core/cacheable_checker.go#L43"><code>cacheableChecker</code></a> visitor 检查 AST 中是否有变量表达式，子查询，&ldquo;order by ?&quot;，&ldquo;limit ?，?&rdquo; 和 UnCacheableFunctions 的函数调用等不可以使用 PlanCache 的情况。</p>
</li>
</ol>
<p>如果检查都通过则在 <code>Execute#getPhysicalPlan</code> 中会用当前环境构建 cache key 查找 <code>preparePlanCache</code>。</p>
<h3 id="-cache">未命中 Cache</h3>
<p>我们首先来看下没有命中 Cache 的情况。发现没有命中后会用 <code>stmtID</code> 找到的 AST 执行 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/executor/prepared.go#L161">Optimize</a>，但和正常执行 Optimize 不同对于 Cache 的 Plan， 我需要对 “?” 做延迟求值处理， 即将占位符转换为一个 function 做 Plan 并 Cache， 后续从 Cache 获取后 function 在执行时再从具体执行上下文中实际获取执行参数。</p>
<p>回顾下构建 LogicPlan 的过程中会通过 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/planner/core/expression_rewriter.go#L151"><code>expressionRewriter</code></a> 将 AST 转换为各类 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/expression/expression.go#L42"><code>expression.Expression</code></a>，通常对于 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/types/parser_driver/value_expr.go#L167"><code>ParamMarkerExpr</code></a> 会重写为 Constant 类型的 expression，但如果该条 stmt 支持 Cache 的话会重写为 Constant 并带上一个特殊的 <code>DeferredExpr</code> 指向一个 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/expression/builtin_other.go#L787"><code>GetParam</code></a> 的函数表达式，而这个函数会在执行时实际从前面 Execute 保存到 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/sessionctx/variable/session.go#L190"><code>sessionVars.PreparedParams</code></a> 中获取，这样就做到了 Plan 并 Cache 一个参数无关的 Plan，然后实际执行的时填充参数。</p>
<p>新获取 Plan 后会保存到 <code>preparedPlanCache</code> 供后续使用。</p>
<h3 id="-cache-1">命中 Cache</h3>
<p>让我们回到 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/planner/core/common_plans.go#L188"><code>getPhysicalPlan</code></a>，如果 Cache 命中在获取 Plan 后我们需要重新 build plan 的 range，因为前面我们保存的 Plan 是一个带 <code>GetParam</code> 的函数表达式，而再次获取后，当前参数值已经变化，我们需要根据当前 Execute 的参数来重新修正 range，这部分逻辑代码位于 <a href="https://github.com/lysu/tidb/blob/source-read-prepare/planner/core/common_plans.go#L214"><code>Execute#rebuildRange</code></a> 中，之后就是正常的执行过程了。</p>
<h2 id="-prepared">文本协议的 Prepared</h2>
<p>前面主要介绍了二进制协议的 Prepared 执行流程，还有一种执行方式是通过二进制协议来执行。</p>
<p>客户端可以通过 <code>COM_QUREY</code> 发送：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">PREPARE stmt_name FROM prepareable_stmt;
EXECUTE stmt_name USING @var_name1, @var_name2,...
DEALLOCTE PREPARE stmt_name
</code></pre></div><p>来进行 Prepared，TiDB 会走正常 <a href="https://zhuanlan.zhihu.com/p/35134962">文本 Query 处理流程</a>，将 SQL 转换 Prepare，Execute，Deallocate 的 Plan， 并最终转换为和二进制协议一样的 <code>PrepareExec</code>，<code>ExecuteExec</code>，<code>DealocateExec</code> 的执行器进行执行。</p>
<h2 id="heading">写在最后</h2>
<p>Prepared 是提高程序 SQL 执行效率的有效手段之一。熟悉 TiDB 的 Prepared 实现，可以帮助各位读者在将来使用 Prepared 时更加得心应手。另外，如果有兴趣向 TiDB 贡献代码的读者，也可以通过本文更快的理解这部分的实现。</p>
</div>
                </div><div class="ssba-wrap">
    <div class="ssba">
        <a class="ssba_mail_share" href="mailto:info@pingcap.com" target="_blank"
        onclick="trackViews('blog-contact-us', 'mail_to_info_view')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 14 14" width="18" height="18"><path d="M7 9L5.268 7.484.316 11.729c.18.167.423.271.691.271h11.986c.267 0 .509-.104.688-.271L8.732 7.484 7 9z"/><path d="M13.684 2.271A1.007 1.007 0 0 0 12.993 2H1.007c-.267 0-.509.104-.689.273L7 8l6.684-5.729zM0 2.878v8.308l4.833-4.107zM9.167 7.079L14 11.186V2.875z"/></svg>
        </a>
        <a id="wechat_share_btn" data-site="wechat" data-url="https://pingcap.com/blog-cn/tidb-source-code-reading-23/" class="ssba_wechat_share" href="javascript:void(0)" onclick="toggleBlogQRCode()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 31.403 31.404"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"/><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"/></svg>
        </a>
    </div>
</div>

<style type="text/css">
    .fixed-qrcode {
        position: fixed;
        top: 120px;
        right: 105px;
        padding: 10px 15px;
        width: 200px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.9);
        text-align: center;
    }

    .fixed-qrcode p {
        font-size: 14px;
        font-weight: 300;
        line-height: 1.6;
        margin: 8px 0;
        color: #333;
    }

    .fixed-qrcode #close_share_qrcode {
        position: absolute;
        top: 0;
        right: 0;
        width: 30px;
        height: 30px;
        padding: 10px;
    }

    .fixed-qrcode #close_share_qrcode svg {
        display: block;
    }

    .f-hide #share_qrcode {
        visibility: hidden;
        opacity: 0;
    }

    .fixed-qrcode #share_qrcode {
        visibility: visible;
        opacity: 1;
        height: 128px;
        transition: visibility 0s linear 0s, opacity .3s 0s;
        -webkit-transition: visibility 0s linear 0s, opacity .3s 0s;
    }

    #share_qrcode img {
        margin: 0 auto;
    }
</style>
<div id="share_qrcode_outer" class="f-hide">
    <i id="close_share_qrcode"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 224.512 224.512"><path fill="#010002" d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z"/></svg></i>
    <p>分享到微信</p>
    <div id="share_qrcode"></div>
    <p>打开微信，使用 “扫一扫” 即可将网页分享至朋友圈。</p>
</div>

<script type="text/javascript" src="/js/vendor/qrcode.min.js"></script>
<script type="text/javascript">
    window.onload = function() {
        var close_share_qrcode_btn = document.getElementById('close_share_qrcode')
        var wechat_share_btn = document.getElementById('wechat_share_btn')
        var blog_url = wechat_share_btn.getAttribute('data-url')

        window.pingcap_blog_qrcode = new QRCode(
            document.getElementById('share_qrcode'),
            {
            text: blog_url,
            width: 128,
            height: 128,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
            }
        )

        close_share_qrcode_btn.addEventListener('click', function(event) {
            document
            .getElementById('share_qrcode_outer')
            .setAttribute('class', 'f-hide')
        })
    }

    function toggleBlogQRCode() {
        var qrcode_wrapper = document.getElementById('share_qrcode_outer')

        if (qrcode_wrapper.getAttribute('class') == 'f-hide') {
            qrcode_wrapper.setAttribute('class', 'fixed-qrcode')
        } else {
            qrcode_wrapper.setAttribute('class', 'f-hide')
        }
    }
</script>
</div>
        </div>
    </div>
<footer>
    <div class="container">
        <div class="flex-list-wrap">
            <div class="flex-list">
                <h4 class="list-title"><strong>产品</strong></h4>
                <ul>
                <li><a href="/docs-cn/v3.0/" onclick="trackViews('footer-product-tidb', 'docs-cn_view')">TiDB</a></li>
                <li><a href="/docs-cn/v3.0/reference/tispark/">TiSpark</a></li>
                <li><a href="/docs-cn/v3.0/roadmap/">TiDB 路线图</a></li>
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>文档</strong></h4>
                <ul>
                <li><a href="https://docs.pingcap.com/zh/tidb/v4.0/quick-start-with-tidb">快速入门</a></li>
                <li><a href="/blog-cn/tidb-best-practice/">最佳实践</a></li>
                <li><a href="/docs-cn/stable/faq/tidb/">常见问题解答</a></li>
                <li><a href="/docs-cn/stable/reference/tools/user-guide/">TiDB 周边工具</a></li>
                <li><a href="https://docs.pingcap.com/zh/tidb/dev/release-notes">版本发布说明</a></li>
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>资源</strong></h4>
                <ul>
                <li><a href="/blog-cn/">博客</a></li>
                <li><a href="https://github.com/pingcap" target="_blank">GitHub</a></li>
                <li><a href="https://book.tidb.io" target="_blank">TiDB in Action</a></li>
                <li><a href="https://university.pingcap.com/"
                    onclick="trackViews('footer-source-university', 'pingcap-university_view')" target="_blank">PingCAP
                    University</a></li>
                <li><a href="/solutions/intel/"
                    onclick="trackViews('footer-resource-solutions', 'solutions_view')" >联合解决方案</a></li>
                <li><a href="https://asktug.com/"
                    onclick="trackViews('footer-resource-asktug', 'asktug_view')" target="_blank">Ask TUG</a></li>
                
                </ul>
            </div>
            <div class="flex-list">
                <h4 class="list-title"><strong>公司</strong></h4>
                <ul>
                <li><a href="/about-cn/">关于我们</a></li>
                <li><a href="https://job.pingcap.com/" target="_blank" onclick="trackViews('footer-recruit-join', 'recruit-join_view')">招贤纳士</a>
                </li>
                <li><a href="/about-cn/news/">新闻报道</a></li>
                <li><a href="/zh/privacy-policy/">隐私申明</a></li>
                </ul>
            </div>
        </div>
        <div class="contact-list-wrap">
            <div class="flex-list">
                <h4 class="list-title"><strong>联系我们</strong></h4>
                <ul>
                <li><a href="https://twitter.com/PingCAP" class="twitter"  target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" width="18" height="19"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"/></svg> Twitter</a></li>
                <li><a href="https://www.linkedin.com/company/pingcap/" class="linkedin" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="16" viewBox="0 0 438.536 438.535"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"/></svg> LinkedIn</a></li>
                <li><a href="https://www.reddit.com/r/TiDB/" class="reddit" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 279.748 279.748" width="18" height="18"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"/></svg> Reddit</a></li>
                <li><a href="https://groups.google.com/forum/#!forum/tidb-user" class="google-plus" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 491.858 491.858" width="18" height="20"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"/></svg> Google Group</a></li>
                <li><a href="https://stackoverflow.com/questions/tagged/tidb" class="stack-overflow" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="17" viewBox="0 0 547.597 547.597"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"/><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"/><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"/></svg> Stack Overflow</a></li>
                <li id="wechat"><a class="wechat" href="javascript:void(0)"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="17" viewBox="0 0 31.403 31.404"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"/><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"/></svg> 微信公众号</a> <div class="qr_code_outer f-hide f-tc">
    <div class="qr_code">
        <i id="close_qrcode"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 224.512 224.512"><path fill="#010002" d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z"/></svg></i>
        <img id="js_qr_code_img" class="qr_code_img" src="/images/wechat-qrcode.jpg" alt="Wechat qrCode" />
        <p>微信扫一扫<br> 微信ID：pingcap2015</p>
    </div>
</div>
</li>
                </ul>
            </div>
            <div class="subscribe" id="subscribe-pc"></div>
        </div>
    </div>
    <div class="container copyright-container">
        <p class="copyright">&copy; 2020 北京平凯星辰科技发展有限公司</p>
        <a href="/blog" class="copyright-btn-lang copyright-btn-en" id="lang">English</a>
        <a href="http://www.beian.miit.gov.cn/" class="prepared-num">京 ICP 备 16046278 号 - 2</a>
    </div>
</footer>
<button class="back-to-top" type="button"><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 284.929 284.929"><path d="M282.082 195.285L149.028 62.24c-1.901-1.903-4.088-2.856-6.562-2.856s-4.665.953-6.567 2.856L2.856 195.285C.95 197.191 0 199.378 0 201.853c0 2.474.953 4.664 2.856 6.566l14.272 14.271c1.903 1.903 4.093 2.854 6.567 2.854s4.664-.951 6.567-2.854l112.204-112.202 112.208 112.209c1.902 1.903 4.093 2.848 6.563 2.848 2.478 0 4.668-.951 6.57-2.848l14.274-14.277c1.902-1.902 2.847-4.093 2.847-6.566.001-2.476-.944-4.666-2.846-6.569z" fill="#FFF"/></svg>
</button>
</div><div class="overlay"></div><script src="https://download.pingcap.com/js/jquery.min.js"></script><script type="text/javascript" src="/js/vendor/lazyload.min.js"></script>
    <script type="text/javascript" src="/js/doc.js"></script>
    <script type="text/javascript" src="/js/anchor.js"></script><script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script src="https://browser.sentry-cdn.com/5.11.0/bundle.min.js" integrity="sha384-jbFinqIbKkHNg+QL+yxB4VrBC0EAPTuaLGeRT0T+NfEV89YC6u1bKxHLwoo+/xxY" crossorigin="anonymous"></script><script>Sentry.init({ 
            dsn: 'https://3f28ed393c5545daa74496b3cdb2e9ba@sentry.io/1887163' 
        });</script></body></html>