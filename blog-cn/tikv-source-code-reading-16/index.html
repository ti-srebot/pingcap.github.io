<!DOCTYPE html>
<html lang="en"><head>
<meta name="robots" content="noindex"><meta charset="utf-8"/><meta content="IE=edge" http-equiv="X-UA-Compatible"/><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" name="viewport"/>
<script>
window.ga =
    window.ga ||
    function() {
        ;(ga.q = ga.q || []).push(arguments)
    }
ga.l = +new Date()
ga('create', 'UA-99991864-4', 'auto')
ga('send', 'pageview')
</script>
<script async="" src="https://download.pingcap.com/js/ga-analytics.js"></script>
<link href="https://download.pingcap.com/style/github-markdown.css" rel="stylesheet"/>
<link href="/css/doc.css" rel="stylesheet"/>
<title>TiKV 源码解析系列文章（十六）TiKV Coprocessor Executor 源码解析 | PingCAP</title><link href="/images/favicon.ico" rel="icon" type="image/x-icon"/>
<link href="/images/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
<link href="/images/apple-touch-icon.png" rel="apple-touch-icon"/>
<meta content="本文将介绍下推算子的执行流程并分析下推算子的部分实现细节，加深大家对 TiKV Coprocessor 的理解。" name="description"/>
<meta content="noodp" name="robots"/>
<meta content="TiDB, MySQL, HTAP, Open Source, Cloud-Native, NewSQL, Aurora Alternative" name="keywords"/>
<meta content="en_US" property="og:locale"/>
<meta content="website" property="og:type"/>
<meta content="TiKV 源码解析系列文章（十六）TiKV Coprocessor Executor 源码解析 | PingCAP" property="og:title"/>
<meta content="本文将介绍下推算子的执行流程并分析下推算子的部分实现细节，加深大家对 TiKV Coprocessor 的理解。" property="og:description"/>
<meta content="https://pingcap.com/blog-cn/tikv-source-code-reading-16/" property="og:url"/>
<meta content="MySQL at Scale. No more manual sharding" property="og:site_name"/>
<meta content="/images/pingcap-opengraph.jpg" property="og:image"/>
<meta content="/images/pingcap-opengraph.jpg" property="og:image:secure_url"/><meta content="summary" name="twitter:card"/><meta content="本文将介绍下推算子的执行流程并分析下推算子的部分实现细节，加深大家对 TiKV Coprocessor 的理解。" name="twitter:description"/>
<meta content="TiKV 源码解析系列文章（十六）TiKV Coprocessor Executor 源码解析 | PingCAP" name="twitter:title"/>
<meta content="@pingcap" name="twitter:site"/>
<meta content="https://download.pingcap.com/images/pingcap-opengraph.jpg" name="twitter:image"/><meta content="@pingcap" name="twitter:creator"/>
<script type="application/ld+json">
{
    "@context": "http:\/\/schema.org",
    "@type": "WebSite",
    "url": "https:\/\/pingcap.com\/",
    "name": "PingCAP",
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https:\/\/pingcap.com\/?s={search_term_string}",
        "query-input": "required name=search_term_string"
    }
}
</script>
<script>
    (function(){
        var bp = document.createElement('script');
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
<script async="" src="https://accounts.pingcap.com/static/pingcap_sso/js/track.beta.js" type="text/javascript"></script>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.woff" rel="preload" type="font/woff"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/lato/lato-regular-webfont.ttf" rel="preload" type="font/ttf"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.woff" rel="preload" type="font/woff"/>
<link as="font" crossorigin="anonymous" href="https://download.pingcap.com/fonts/titilliumweb/titilliumweb-regular-webfont.ttf" rel="preload" type="font/ttf"/>
<link as="script" href="https://download.pingcap.com/js/jquery.min.js" rel="preload"/>
<link href="/css/main.css" rel="stylesheet"/>
<link href="https://download.pingcap.com/style/docsearch.min.css" rel="stylesheet"/>
<script type="text/javascript">
var trackOutboundLink = function(url) {
  var redirectTriggered = false
  ga('send', 'event', 'outbound', 'click', url, {
    hitCallback: function() {
      redirectTriggered = true
      document.location = url
    }
  })
  setTimeout(function() {
    if (!redirectTriggered) {
      document.location = url
    }
  }, 1500)
}

var trackViews = function(btn_type, event_category) {
  var event_label = btn_type
  var eventCategory = event_category
  ga('send', 'event', {
    'eventCategory': eventCategory,
    'eventAction': 'click',
    'eventLabel': event_label,
    'transport': 'beacon'
  });
}
</script>
<script>if (location.pathname === '/') {
        if (location.hostname === 'pingcap.github.io') {
            location.href = '/en/'
        }
    }</script></head> <body data-lang="cn"><div id="page-content">
<header class="fixed-top" role="navigation">
<div class="container">
<a class="nav-brand" href="/zh"><img alt="PingCAP" src="/images/pingcap-logo.png"/></a>
<div class="nav-wrapper">
<div class="navigation">
<ul>
<li><a class="nav-blinking" href="https://university.pingcap.com/" onclick="trackViews('navbar-university', 'pingcap-university_view')" target="_blank">PingCAP
                            University</a></li>
<li class="docs-type-selector " id="docsTypeSelector">
<a class="header-doc-nav" href="https://docs.pingcap.com/zh" target="_blank">文档</a>
</li>
<li><a href="/cases-cn">案例</a></li>
<li><a href="/community-cn">社区</a></li>
<li class="sel"><a href="/blog-cn">博客</a></li>
<li><a href="/about-cn">关于</a></li>
<li><a href="https://asktug.com" onclick="trackViews('navbar-asktug', 'asktug_view')" target="_blank">问答</a></li>
<li><a href="/download-cn">下载试用</a></li>
<li><a class="link-download" href="mailto:info@pingcap.com" onclick="trackViews('navbar-contact-us', 'mail_to_info_view')" target="_blank">联系我们</a></li>
</ul>
</div>
<div class="global-search">
<div class="search-wrapper">
<span class="icon-search"><svg fill="#fff" height="18" viewbox="0 0 67.125 67.125" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M23.902 0C11.01 0 .523 10.488.523 23.38c0 12.891 10.487 23.379 23.379 23.379a23.258 23.258 0 0 0 14.471-5.037l24.816 24.817c.391.391.902.586 1.414.586s1.023-.195 1.414-.586a2 2 0 0 0 0-2.828L41.293 38.985c3.721-4.142 5.989-9.613 5.989-15.605C47.282 10.488 36.794 0 23.902 0zM4.523 23.38C4.523 12.694 13.216 4 23.902 4c10.687 0 19.38 8.694 19.38 19.38 0 5.396-2.221 10.279-5.791 13.795a1.959 1.959 0 0 0-.488.349 2.003 2.003 0 0 0-.271.343C33.31 40.9 28.825 42.76 23.903 42.76c-10.686-.001-19.38-8.695-19.38-19.38z"></path><path d="M24.075 8.591c-8.25 0-14.962 6.712-14.962 14.962a2 2 0 0 0 4 0c0-6.044 4.918-10.962 10.962-10.962a2 2 0 0 0 0-4z"></path></svg></span>
<input data-lang="cn" data-type="" id="search-input" name="q" placeholder="搜索 TiDB 文档" type="search"/>
</div>
<script>
    const inputNode = document.getElementById("search-input")

    inputNode.addEventListener('keyup', ({key}) => {
        if (key === "Enter") {
            if ($('#search-input').data('lang') == 'cn') {
                lang = 'zh'
            }

            const query = $('#search-input').val()
            if (query) {
                url = "https://docs.pingcap.com/" + (lang == 'zh' ? 'zh/' : '') + "search/?lang=" + lang + "&type=tidb&version=v4.0&q=" + query
                window.location.href = url
            }
        }
    })
</script>
</div>
</div>
<div class="nav-btn nav-slider">
<i class="material-icons"><svg height="16" viewbox="0 0 459 459" width="16" xmlns="http://www.w3.org/2000/svg"><path d="M0 382.5h459v-51H0v51zM0 255h459v-51H0v51zM0 76.5v51h459v-51H0z" fill="#FFF"></path></svg></i>
</div>
</div>
</header>
<nav class="mobile-sidebar">
<div class="nav-header">
<div class="logo-wrap">
<a class="nav-brand" href="/en"><img alt="PingCAP" src="/images/pingcap-logo.png"/></a>
</div>
</div>
<ul class="ul-base">
<li><a href="https://docs.pingcap.com/zh/tidb/v4.0/">文档</a></li>
<li><a href="/cases-cn">案例</a></li>
<li><a href="/community-cn">社区</a></li>
<li class="sel"><a href="/blog-cn">博客</a></li>
<li><a href="/about-cn">关于</a></li>
<li><a href="https://asktug.com" onclick="trackViews('navbar-asktug', 'asktug_view')" target="_blank">问答</a></li>
<li><a href="/download-cn">下载试用</a></li>
<li><a class="link-download" href="mailto:info@pingcap.com" onclick="trackViews('navbar-contact-us', 'mail_to_info_view')" target="_blank">联系我们</a></li>
<li><a class="nav-blinking" href="https://university.pingcap.com/" onclick="trackViews('navbar-university', 'pingcap-university_view')" target="_blank">PingCAP University</a></li>
</ul>
<div class="nav-footer">
<div class="contact-list-wrap">
<div class="flex-list">
<h4 class="list-title"><strong>Contact</strong></h4>
<ul class="social social-cn ul-base">
<li><a class="twitter" href="https://twitter.com/PingCAP" target="_blank"><svg height="18" viewbox="0 0 612 612" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"></path></svg></a></li>
<li><a class="linkedin" href="https://www.linkedin.com/company/pingcap/" target="_blank"><svg height="18" viewbox="0 0 438.536 438.535" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"></path></svg></a></li>
<li><a class="reddit" href="https://www.reddit.com/r/TiDB/" target="_blank"><svg height="18" viewbox="0 0 279.748 279.748" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"></path></svg></a></li>
<li><a class="google-plus" href="https://groups.google.com/forum/#!forum/tidb-user" target="_blank"><svg height="18" viewbox="0 0 491.858 491.858" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"></path></svg></a></li>
<li><a class="stack-overflow" href="https://stackoverflow.com/questions/tagged/tidb" target="_blank"><svg height="18" viewbox="0 0 547.597 547.597" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"></path><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"></path><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"></path></svg></a></li>
<li id="wechat-mobile"><a class="wechat" href="javascript:void(0)"><svg height="18" viewbox="0 0 31.403 31.404" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"></path><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"></path></svg></a><div class="qr_code_outer f-hide f-tc">
<div class="qr_code">
<i id="close_qrcode"><svg viewbox="0 0 224.512 224.512" xmlns="http://www.w3.org/2000/svg"><path d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z" fill="#010002"></path></svg></i>
<img alt="Wechat qrCode" class="qr_code_img" id="js_qr_code_img" src="/images/wechat-qrcode.jpg"/>
<p>微信扫一扫<br/> 微信ID：pingcap2015</p>
</div>
</div>
</li>
</ul>
</div>
<div class="subscribe" id="subscribe-mobile"></div>
</div>
<div class="container">
<a class="btn-lang" href="/blog" id="lang">English</a>
</div>
</div>
</nav>
<div class="blog">
<div class="container">
<div class="sidebar nav-tags" data-type="single"><div class="title">热门标签<a class="rss" href="/blog-cn/index.xml" title="RSS Feed"><svg height="17" viewbox="0 0 402.041 402.04" width="13" xmlns="http://www.w3.org/2000/svg"><g fill="#3A59F0"><path d="M54.816 292.382c-15.229 0-28.169 5.331-38.831 15.988C5.33 319.026 0 331.969 0 347.197c0 15.232 5.325 28.172 15.985 38.828 10.662 10.657 23.606 15.988 38.831 15.988 15.227 0 28.168-5.331 38.828-15.988 10.656-10.656 15.986-23.596 15.986-38.828 0-15.229-5.33-28.171-15.986-38.827-10.657-10.657-23.598-15.988-38.828-15.988zM181.01 221.002c-21.51-21.698-46.158-38.97-73.948-51.816-27.79-12.85-56.914-20.511-87.366-22.985h-1.425c-4.949 0-9.042 1.619-12.275 4.854C1.997 154.477 0 158.953 0 164.472v38.543c0 4.757 1.569 8.85 4.708 12.279 3.14 3.429 7.089 5.332 11.848 5.708 43.586 4.189 80.845 21.752 111.773 52.678 30.93 30.926 48.49 68.187 52.677 111.771.382 4.764 2.284 8.712 5.712 11.847 3.427 3.148 7.517 4.72 12.275 4.72h38.545c5.517 0 9.989-1.995 13.415-5.996 3.621-3.812 5.236-8.381 4.863-13.709-2.478-30.447-10.14-59.573-22.987-87.361-12.846-27.792-30.121-52.438-51.819-73.95z"></path><path d="M367.728 239.701c-20.365-45.585-48.345-86.078-83.936-121.482-35.405-35.594-75.896-63.572-121.485-83.939C116.723 13.917 68.996 2.494 19.126.02h-.855c-4.949 0-9.136 1.713-12.563 5.14C1.903 8.583 0 12.964 0 18.294v40.825c0 4.76 1.667 8.897 4.996 12.419 3.33 3.523 7.373 5.376 12.132 5.57 40.924 2.478 79.799 12.188 116.63 29.127 36.83 16.94 68.806 38.972 95.93 66.09 27.118 27.123 49.149 59.101 66.089 95.931 16.94 36.836 26.557 75.705 28.839 116.627.195 4.764 2.046 8.809 5.564 12.139 3.524 3.329 7.762 4.999 12.71 4.999h40.823c5.331 0 9.701-1.902 13.134-5.715 3.809-3.806 5.517-8.274 5.144-13.415-2.471-49.874-13.898-97.6-34.263-143.19z"></path></g></svg></a></div><a class="tag all" href="#">ALL (254)</a>
<div class="tag-list"><a class="tag " data-tag="Chaos-Mesh" href="#Chaos-Mesh">Chaos Mesh (7)
                </a><a class="tag " data-tag="Committer" href="#Committer">Committer (3)
                </a><a class="tag " data-tag="Contributor" href="#Contributor">Contributor (9)
                </a><a class="tag " data-tag="DM" href="#DM">DM (2)
                </a><a class="tag " data-tag="DM-源码阅读" href="#DM-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb">DM 源码阅读 (10)
                </a><a class="tag " data-tag="Go" href="#Go">Go (3)
                </a><a class="tag " data-tag="HTAP" href="#HTAP">HTAP (3)
                </a><a class="tag " data-tag="Hackathon" href="#Hackathon">Hackathon (4)
                </a><a class="tag " data-tag="K8s" href="#K8s">K8s (2)
                </a><a class="tag " data-tag="Key-Visualizer" href="#Key-Visualizer">Key Visualizer (2)
                </a><a class="tag " data-tag="Kubernetes" href="#Kubernetes">Kubernetes (3)
                </a><a class="tag " data-tag="Linux" href="#Linux">Linux (4)
                </a><a class="tag " data-tag="MVCC" href="#MVCC">MVCC (2)
                </a><a class="tag " data-tag="MySQL" href="#MySQL">MySQL (2)
                </a><a class="tag " data-tag="PD" href="#PD">PD (5)
                </a><a class="tag " data-tag="Percolator" href="#Percolator">Percolator (2)
                </a><a class="tag " data-tag="PingCAP" href="#PingCAP">PingCAP (2)
                </a><a class="tag " data-tag="Prometheus" href="#Prometheus">Prometheus (3)
                </a><a class="tag " data-tag="Raft" href="#Raft">Raft (11)
                </a><a class="tag " data-tag="RocksDB" href="#RocksDB">RocksDB (3)
                </a><a class="tag " data-tag="Rust" href="#Rust">Rust (5)
                </a><a class="tag " data-tag="SQL" href="#SQL">SQL (6)
                </a><a class="tag " data-tag="Spanner" href="#Spanner">Spanner (2)
                </a><a class="tag " data-tag="TiDB" href="#TiDB">TiDB (79)
                </a><a class="tag " data-tag="TiDB-4.0-新特性" href="#TiDB-4.0-%e6%96%b0%e7%89%b9%e6%80%a7">TiDB 4.0 新特性 (11)
                </a><a class="tag " data-tag="TiDB-Binlog" href="#TiDB-Binlog">TiDB Binlog (5)
                </a><a class="tag " data-tag="TiDB-Binlog-源码阅读" href="#TiDB-Binlog-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb">TiDB Binlog 源码阅读 (9)
                </a><a class="tag " data-tag="TiDB-Ecosystem-Tools" href="#TiDB-Ecosystem-Tools">TiDB Ecosystem Tools (3)
                </a><a class="tag " data-tag="TiDB-Operator" href="#TiDB-Operator">TiDB Operator (5)
                </a><a class="tag " data-tag="TiDB-性能挑战赛" href="#TiDB-%e6%80%a7%e8%83%bd%e6%8c%91%e6%88%98%e8%b5%9b">TiDB 性能挑战赛 (2)
                </a><a class="tag " data-tag="TiDB-易用性挑战赛" href="#TiDB-%e6%98%93%e7%94%a8%e6%80%a7%e6%8c%91%e6%88%98%e8%b5%9b">TiDB 易用性挑战赛 (4)
                </a><a class="tag " data-tag="TiDB-源码阅读" href="#TiDB-%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb">TiDB 源码阅读 (24)
                </a><a class="tag " data-tag="TiFlash" href="#TiFlash">TiFlash (7)
                </a><a class="tag " data-tag="TiKV" href="#TiKV">TiKV (28)
                </a><a class="tag sel" data-tag="TiKV-源码解析" href="#TiKV-%e6%ba%90%e7%a0%81%e8%a7%a3%e6%9e%90">TiKV 源码解析 (20)
                </a><a class="tag " data-tag="TiSpark" href="#TiSpark">TiSpark (4)
                </a><a class="tag " data-tag="WebAssembly" href="#WebAssembly">WebAssembly (2)
                </a><a class="tag " data-tag="gRPC" href="#gRPC">gRPC (2)
                </a><a class="tag " data-tag="事务" href="#%e4%ba%8b%e5%8a%a1">事务 (4)
                </a><a class="tag " data-tag="优化器" href="#%e4%bc%98%e5%8c%96%e5%99%a8">优化器 (2)
                </a><a class="tag " data-tag="分布式系统前沿技术" href="#%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e5%89%8d%e6%b2%bf%e6%8a%80%e6%9c%af">分布式系统前沿技术 (4)
                </a><a class="tag " data-tag="分布式系统测试" href="#%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f%e6%b5%8b%e8%af%95">分布式系统测试 (3)
                </a><a class="tag " data-tag="备份恢复" href="#%e5%a4%87%e4%bb%bd%e6%81%a2%e5%a4%8d">备份恢复 (2)
                </a><a class="tag " data-tag="工具" href="#%e5%b7%a5%e5%85%b7">工具 (4)
                </a><a class="tag " data-tag="性能" href="#%e6%80%a7%e8%83%bd">性能 (4)
                </a><a class="tag " data-tag="数据同步" href="#%e6%95%b0%e6%8d%ae%e5%90%8c%e6%ad%a5">数据同步 (2)
                </a><a class="tag " data-tag="最佳实践" href="#%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5">最佳实践 (6)
                </a><a class="tag " data-tag="架构" href="#%e6%9e%b6%e6%9e%84">架构 (6)
                </a><a class="tag " data-tag="版本" href="#%e7%89%88%e6%9c%ac">版本 (2)
                </a><a class="tag sel" data-tag="社区" href="#%e7%a4%be%e5%8c%ba">社区 (102)
                </a><a class="tag " data-tag="社区动态" href="#%e7%a4%be%e5%8c%ba%e5%8a%a8%e6%80%81">社区动态 (29)
                </a><a class="tag " data-tag="集群调度" href="#%e9%9b%86%e7%be%a4%e8%b0%83%e5%ba%a6">集群调度 (2)
                </a>
</div>
</div>
<div class="archive">
<div class="content markdown-body">
<h1 class="title">TiKV 源码解析系列文章（十六）TiKV Coprocessor Executor 源码解析</h1>
<ul class="blog-post-meta">
<li class="meta-item">
<img alt="Date icon" src="/images/svgs/icon-date.svg"/>Wed, Dec 11, 2019</li>
<li class="meta-item">
<img alt="Pen icon" src="/images/svgs/icon-writer.svg"/>邓力铭</li>
</ul>
<div class="blog-text"><p>在前两篇文章 <a href="https://mp.weixin.qq.com/s/cdC7f9N9C88MJ_syNUg21g">TiKV 源码解析系列文章（十四）Coprocessor 概览</a>、<a href="https://mp.weixin.qq.com/s/UYcny9G5snh-MoMFm2qxsw">TiKV 源码解析系列文章（十五）表达式计算框架中</a>，讲到了 TiDB 为了最大化利用分布式计算能力，会尽量将 Selection 算子、Aggregation 算子等算子下推到 TiKV 节点上，以及下推的表达式是如何在 TiKV 上做计算的。本文将在前两篇文章的基础上，介绍下推算子的执行流程并分析下推算子的部分实现细节，加深大家对 TiKV Coprocessor 的理解。</p>
<h2 id="heading">什么是下推算子</h2>
<p>以下边的 <code>SQL</code> 为例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span>  <span style="color:#f92672">*</span>  <span style="color:#66d9ef">from</span> students <span style="color:#66d9ef">where</span> age <span style="color:#f92672">&gt;</span>  <span style="color:#ae81ff">21</span>  <span style="color:#66d9ef">limit</span>  <span style="color:#ae81ff">2</span>
</code></pre></div><p>TiDB 在解析完这条 <code>SQL</code> 语句之后，会开始制定执行计划。在这个语句中， TiDB 会向 TiKV 下推一个可以用有向无环图（DAG）来描述的查询请求：</p>
<p><img alt="图 1 DAG 样例" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-16/1.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>以上的 <code>DAG</code> 是一个由一系列算子组成的有向无环图，算子在 TiKV 中称为 <code>Executor</code> 。整个 <code>DAG</code> 描述了查询计划在 TiKV 的执行过程。在上边的例子中，一条查询 <code>SQL</code> 被翻译成了三个执行步骤：</p>
<ol>
<li>
<p>扫表</p>
</li>
<li>
<p>选择过滤</p>
</li>
<li>
<p>取若干行</p>
</li>
</ol>
<p>有了基本概念后，下面我们简单介绍一下这样的查询计划在 TiKV 内部的一个执行流程。</p>
<h2 id="heading-1">下推算子如何执行</h2>
<h3 id="heading-2">绕不开的火山</h3>
<p>TiKV 执行器是基于 Volcano Model （火山模型），一种经典的基于行的流式迭代模型。现在主流的关系型数据库都采用了这种模型，例如 Oracle，MySQL 等。</p>
<p>我们可以把每个算子看成一个迭代器。每次调用它的 <code>next()</code> 方法，我们就可以获得一行，然后向上返回。而每个算子都把下层算子看成一张表，返回哪些行，返回怎么样的行由算子本身决定。举个例子：</p>
<p>假设我们现在对一张没有主键，没有索引的表 <code>[1]</code> ，执行一次全表扫描操作：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> t <span style="color:#66d9ef">where</span> a <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">limit</span> <span style="color:#ae81ff">2</span>
</code></pre></div><p>表 <code>[1]</code>：</p>
<table>
<thead>
<tr>
<th>a <code>(int)</code></th>
<th>b <code>(int)</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>5</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
</tr>
<tr>
<td>1</td>
<td>4</td>
</tr>
</tbody>
</table>
<p>那么我们就可以得到这样的一个执行计划：</p>
<p><img alt="图 2 DAG 执行流程样例" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-16/2.gif" src="/images/svgs/loader-spinner.svg"/></p>
<p>每个算子都实现了一个 <code>Executor</code> 的 <code>trait</code>， 所以每个算子都可以调用 <code>next()</code> 来向上返回一行。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> Executor: Send {
    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">next</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; Result<span style="color:#f92672">&lt;</span>Option<span style="color:#f92672">&lt;</span>Row<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span>;
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
<span style="color:#960050;background-color:#1e0010">当</span><span style="color:#960050;background-color:#1e0010">以</span><span style="color:#960050;background-color:#1e0010">上</span><span style="color:#960050;background-color:#1e0010">的</span><span style="color:#960050;background-color:#1e0010">请</span><span style="color:#960050;background-color:#1e0010">求</span><span style="color:#960050;background-color:#1e0010">被</span><span style="color:#960050;background-color:#1e0010">解</span><span style="color:#960050;background-color:#1e0010">析</span><span style="color:#960050;background-color:#1e0010">之</span><span style="color:#960050;background-color:#1e0010">后</span><span style="color:#960050;background-color:#1e0010">，</span><span style="color:#960050;background-color:#1e0010">我</span><span style="color:#960050;background-color:#1e0010">们</span><span style="color:#960050;background-color:#1e0010">会</span><span style="color:#960050;background-color:#1e0010">在</span> ExecutorRunner <span style="color:#960050;background-color:#1e0010">里</span><span style="color:#960050;background-color:#1e0010">边</span><span style="color:#960050;background-color:#1e0010">不</span><span style="color:#960050;background-color:#1e0010">断</span><span style="color:#960050;background-color:#1e0010">的</span><span style="color:#960050;background-color:#1e0010">调</span><span style="color:#960050;background-color:#1e0010">用</span><span style="color:#960050;background-color:#1e0010">最</span><span style="color:#960050;background-color:#1e0010">上</span><span style="color:#960050;background-color:#1e0010">层</span><span style="color:#960050;background-color:#1e0010">算</span><span style="color:#960050;background-color:#1e0010">子</span><span style="color:#960050;background-color:#1e0010">的</span> next() <span style="color:#960050;background-color:#1e0010">方</span><span style="color:#960050;background-color:#1e0010">法</span><span style="color:#960050;background-color:#1e0010">，</span> <span style="color:#960050;background-color:#1e0010">直</span><span style="color:#960050;background-color:#1e0010">到</span><span style="color:#960050;background-color:#1e0010">其</span><span style="color:#960050;background-color:#1e0010">无</span><span style="color:#960050;background-color:#1e0010">法</span><span style="color:#960050;background-color:#1e0010">再</span><span style="color:#960050;background-color:#1e0010">返</span><span style="color:#960050;background-color:#1e0010">回</span><span style="color:#960050;background-color:#1e0010">行</span><span style="color:#960050;background-color:#1e0010">。</span>
<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">handle_request</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; Result<span style="color:#f92672">&lt;</span>SelectResponse<span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">loop</span> {
        <span style="color:#66d9ef">match</span> self.executor.next()<span style="color:#f92672">?</span> {
            Some(row) <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> {
                <span style="color:#75715e">// Do some aggregation.
</span><span style="color:#75715e"></span>            },
            None <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> {
                <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span> result;
            }
        }
    }
}
</code></pre></div><p>大概的逻辑就是：<code>Runner</code> 调用 <code>Limit</code> 算子的 <code>next()</code> 方法，然后这个时候 <code>Limit</code> 实现的 <code>next()</code> 方法会去调用下一层算子 <code>Selection</code> 的 <code>next()</code> 方法要一行上来做聚合，直到达到预设的阀值，在例子中也就是两行，接着 <code>Selection</code> 实现的 <code>next()</code> 又会去调用下一层算子的 <code>next()</code> 方法， 也就是 <code>TableScan</code>， <code>TableScan</code> 的 <code>next()</code> 实现是根据请求中的 <code>KeyRange</code>， 向下边的 <code>MVCC</code> 要上一行，然后返回给上层算子, 也就是第一行 <code>(3, 1)</code>，<code>Selection</code> 收到行后根据 <code>where</code> 字句中的表达式的值做判断，如果满足条件向上返回一行， 否则继续问下层算子要一行，此时 <code>a == 3 &gt; 2</code>, 满足条件向上返回， <code>Limit</code> 接收到一行则判断当前收到的行数时候满两行，但是现在只收到一行，所以继续问下层算子要一行。接下来 <code>TableScan</code> 返回 <code>(1,2), Selection</code> 发现不满足条件，继续问 <code>TableScan</code> 要一行也就是 <code>(5,2), Selection</code> 发现这行满足条件，然后返回这一行，<code>Limit</code> 接收到一行，然后在下一次调用其 <code>next()</code> 方法时，发现接收到的行数已经满两行，此时返回 <code>None</code>， <code>Runner</code> 会开始对结果开始聚合，然会返回一个响应结果。</p>
<h3 id="heading-3">引入向量化的查询引擎</h3>
<p>当前 TiKV 引入了向量化的执行引擎，所谓的向量化，就是在 <code>Executor</code> 间传递的不再是单单的一行，而是多行，比如 <code>TableScan</code> 在底层 <code>MVCC Snapshot</code> 中扫上来的不再是一行，而是说多行。自然的，在算子执行计算任务的时候，计算的单元也不再是一个标量，而是一个向量。举个例子，当遇到一个表达式：<code>a + b</code> 的时候， 我们不是计算一行里边 <code>a</code> 列和 <code>b</code> 列两个标量相加的结果，而是计算 <code>a</code> 列和 <code>b</code> 列两列相加的结果。</p>
<p><img alt="图 3 向量化计算模型与标量计算模型对比" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-16/3.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>为什么要引入向量化模型呢，原因有以下几点：</p>
<ol>
<li>
<p>对于每行我们至少得调用 1 次 <code>next()</code> 方法，如果 <code>DAG</code> 的最大深度很深，为了获取一行我们需要调用更多次的 <code>next()</code> 方法，所以在传统的迭代模型中，虚函数调用的开销非常大。如果一次 <code>next()</code> 方法就返回多行，这样平均下来每次 <code>next()</code> 方法就可以返回多行，而不是至多一行。</p>
</li>
<li>
<p>由于迭代的开销非常大，整个执行的循环无法被 <code>loop-pipelining</code> 优化，使得整个循环流水线被卡死，IPC 大大下降。返回多行之后，每个算子内部可以采用开销较小的循环，更好利用 <code>loop-pipelining</code> 优化。</p>
</li>
</ol>
<p>当然向量化模型也会带来一些问题：</p>
<ol>
<li>
<p>原先最上层算子按需向下层算子拿上一行，而现在拿上多行，内存开销自然会增加。</p>
</li>
<li>
<p>计算模型发生变化，原来基于标量计算的表达式框架需要重构 （详见上篇文章）。</p>
</li>
</ol>
<p>但是这样并不影响向量化查询带来的显著的性能提升，下边是引入向量化模型后一个基准测试结果：（需要注意的是，Coprocessor 计算还只是 TPC-H 中的其中一部分，所以计算任务比重很大程度上决定了开不开向量化带来的提升比例）。</p>
<p><img alt="图 4 向量化查询引擎benchmark" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-16/4.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>引入向量化模型后，原先的 <code>Execturor</code> trait 就变成了 <code>BatchExecutor</code>， 对应的 <code>next()</code> 方法就成了 <code>next_batch()</code>。 自然的 <code>next_batch</code> 不再返回一个行，而是一个 <code>BatchExecuteResult</code>，上边记录了扫上来的一张表 <code>physical_columns</code>，以及子表中哪些行应当被保留的 <code>logical_rows</code> 和一个 <code>is_drain</code> 用来表示下层算子是否已经没有数据可以返回。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> BatchExecutor: Send {

    <span style="color:#e6db74">/// 获取表的 `schema`
</span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">schema</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span>[FieldType];

    <span style="color:#75715e">// 向下层算子要回一张表
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">next_batch</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, scan_rows: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#a6e22e">BatchExecuteResult</span>;

    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">BatchExecuteResult</span> {
    <span style="color:#75715e">// 本轮循环 `TableScan` 扫上来的数据
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> physical_columns: <span style="color:#a6e22e">LazyBatchColumnVec</span>,

    <span style="color:#e6db74">/// 记录 `physical_columns` 中有效的行的下标
</span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> logical_rows: Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>,

    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// 表示下层算子是否已经没有数据可以返回
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> is_drained: Result<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">bool</span><span style="color:#f92672">&gt;</span>,
}
</code></pre></div><p>在接下来的文章中，我们将简单介绍一下几种典型算子的实现细节，旨在让大家更加熟悉各个算子的工作原理。</p>
<h2 id="heading-4">典型算子的实现</h2>
<h3 id="batchtablescanexecutor-"><code>BatchTableScanExecutor</code> 的实现</h3>
<p>首先我们先明确一下 <code>BatchTableScanExecutor</code> 的功能，<code>TableScan</code> 实现的 <code>next_batch()</code> 每被调用一次，它就会从底层的实现了 <code>Storage trait</code> 的存储层中扫上指定的行数，也就是 <code>scan_rows</code> 行。但是由于我们在计算的时候是采用向量化的计算模型，计算都是基于列进行的，所以我们会对扫上来的行进行一次行列转换，将表从行存格式转换成列存格式。</p>
<p><img alt="图 5 行存转列存" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-16/5.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>接下来我们看看 <a href="https://github.com/tikv/tikv/blob/96c3f978f655148b1703a520cb9b2e9001dd256d/components/tidb_query/src/batch/interface.rs#L19"><code>BatchTableScanExecutor</code></a> 现在的定义：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">BatchTableScanExecutor</span><span style="color:#f92672">&lt;</span>S: <span style="color:#a6e22e">Storage</span><span style="color:#f92672">&gt;</span>(ScanExecutor<span style="color:#f92672">&lt;</span>S, TableScanExecutorImpl<span style="color:#f92672">&gt;</span>);
</code></pre></div><p>从结构体的定义中我们可以看出，<code>BatchTableScanExecutor</code> 依赖于 <code>ScanExecutor</code>，而这个 <code>ScanExecutor</code> 依赖于一个实现 <code>Storage</code> 的类型和具体 <code>TableScanExecutorImpl</code>。</p>
<p>其中 <a href="https://github.com/tikv/tikv/blob/96c3f978f655148b1703a520cb9b2e9001dd256d/components/tidb_query/src/batch/executors/util/scan_executor.rs#L38"><code>ScanExecutor</code></a> 是一个通用的结构体，其作用是为了抽象出扫表和扫索引两种操作，这两种操作都需要依赖一个 <code>Storage</code> 而区别他们具体行为的是一个实现了 <code>ScanExecutorImpl</code> 的结构体，在上边的定义中就是：<code>TableScanExecutorImpl</code>。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">ScanExecutor</span><span style="color:#f92672">&lt;</span>S: <span style="color:#a6e22e">Storage</span>, I: <span style="color:#a6e22e">ScanExecutorImpl</span><span style="color:#f92672">&gt;</span> {
    <span style="color:#e6db74">/// 具体的扫表/扫索引实现。
</span><span style="color:#e6db74"></span>    imp: <span style="color:#a6e22e">I</span>,

    <span style="color:#e6db74">/// 给定一个 `KeyRange`，扫上一行或者多行。
</span><span style="color:#e6db74"></span>    scanner: <span style="color:#a6e22e">RangesScanner</span><span style="color:#f92672">&lt;</span>S<span style="color:#f92672">&gt;</span>,

    <span style="color:#75715e">// 标记是否已经扫完了所有的行。
</span><span style="color:#75715e"></span>    is_ended: <span style="color:#66d9ef">bool</span>,
}
</code></pre></div><p><code>BatchTableScanExecutor</code> 中我们需要重点关注的是其实现的 <code>BatchExecutor</code>, 其中最为关键的就是 <code>next_batch()</code>，然而其依赖于内部 <code>ScanExecutor</code> 的 <code>BatchExecutor</code> 实现，也就是：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">next_batch</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, scan_rows: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#a6e22e">BatchExecuteResult</span> {

        <span style="color:#75715e">// 创建一个列数组
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> logical_columns <span style="color:#f92672">=</span> self.imp.build_column_vec(scan_rows);
        
        <span style="color:#75715e">// 扫上 `scan_rows` 行， 然后按列填充到创建好的列数组中。
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> is_drained <span style="color:#f92672">=</span> self.fill_column_vec(scan_rows, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> logical_columns);

        <span style="color:#75715e">// 创建一个 `logical_rows`, 表示当前表中所有行有效。后边可能根据 `Selection` 的结果修改这个 `logical_rows`。
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> logical_rows <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0</span>..logical_columns.rows_len()).collect();

        <span style="color:#75715e">// 判断是否扫完传入的 `KeyRange`
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">match</span> <span style="color:#f92672">&amp;</span>is_drained {
            <span style="color:#75715e">// Note: `self.is_ended` is only used for assertion purpose.
</span><span style="color:#75715e"></span>            Err(_) <span style="color:#f92672">|</span> Ok(<span style="color:#66d9ef">true</span>) <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> self.is_ended <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
            Ok(<span style="color:#66d9ef">false</span>) <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> {}
        };

        <span style="color:#75715e">// 返回 `BatchExecuteResult`
</span><span style="color:#75715e"></span>        BatchExecuteResult {
            <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>        }
    }
</code></pre></div><p>值得注意的是上边 <code>fill_column_vec</code> 的实现, 它大概的逻辑就是每次问 <code>self.scanner</code> 要上一个 <code>Key-Value</code> 对, 然后扔给 <code>self.imp.process_kv_pair</code> 处理，在扫表的实现中就是将 <code>value</code> 看成是一个行的 <code>datum</code> 编码，然后将每列的数据解出来然后放到建好的列数组里边去。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">fill_column_vec</span>(
        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
        scan_rows: <span style="color:#66d9ef">usize</span>,
        columns: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> LazyBatchColumnVec,
    ) -&gt; Result<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">bool</span><span style="color:#f92672">&gt;</span> {
        assert<span style="color:#f92672">!</span>(scan_rows <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>);

        <span style="color:#66d9ef">for</span> _ <span style="color:#66d9ef">in</span> <span style="color:#ae81ff">0</span>..scan_rows {
            <span style="color:#66d9ef">let</span> some_row <span style="color:#f92672">=</span> self.scanner.next()<span style="color:#f92672">?</span>;
            <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Some((key, value)) <span style="color:#f92672">=</span> some_row {
                <span style="color:#75715e">// 将扫上来的一行放入 `columns` 中
</span><span style="color:#75715e"></span>                self.imp.process_kv_pair(<span style="color:#f92672">&amp;</span>key, <span style="color:#f92672">&amp;</span>value, columns)<span style="color:#f92672">?</span>;
            } <span style="color:#66d9ef">else</span> {
                <span style="color:#75715e">// 没有 `KeyRange` 可供扫描，已经完成扫表。
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">return</span> Ok(<span style="color:#66d9ef">true</span>);
            }
        }

        <span style="color:#75715e">// 表示下层数据还没有扫完。
</span><span style="color:#75715e"></span>        Ok(<span style="color:#66d9ef">false</span>)
    }
</code></pre></div><p><strong>值得注意的是，现在表中的数据都是未经解码的生数据，所谓的生数据就是还不能直接参与到表达式计算的数据，这里采用的是一种 lazy decoding 的策略，只有要参与计算的时候，我们才会解码特定的列，而不是将数据扫上来就开始解码数据，将其变成能够直接参与计算的结构。</strong></p>
<h3 id="batchselectionexecutor-"><code>BatchSelectionExecutor</code> 的实现</h3>
<p>接下来要介绍的是 <a href="https://github.com/tikv/tikv/blob/96c3f978f655148b1703a520cb9b2e9001dd256d/components/tidb_query/src/batch/executors/selection_executor.rs#L17"><code>BatchSelectionExecutor</code></a> 的实现，我们首先来看看定义：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">BatchSelectionExecutor</span><span style="color:#f92672">&lt;</span>Src: <span style="color:#a6e22e">BatchExecutor</span><span style="color:#f92672">&gt;</span> {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    
    <span style="color:#75715e">// 数据源
</span><span style="color:#75715e"></span>    src: <span style="color:#a6e22e">Src</span>,

    <span style="color:#75715e">// 条件表达式
</span><span style="color:#75715e"></span>    conditions: Vec<span style="color:#f92672">&lt;</span>RpnExpression<span style="color:#f92672">&gt;</span>,
}
</code></pre></div><p>首先， <code>BatchSelectionExecutor</code> 需要依赖一个 <code>Src</code>，一个 <code>BatchExecutor</code> 来提供数据的来源，然后是一组条件表达式，当 <code>BatchSelectionExecutor</code> 在执行的时候会对表达式进行求值，然后根据求出的值对下层数据拉上来的行做过滤聚合，然后返回过滤出的行。</p>
<p>观察 <code>BatchSelectionExecutor</code> 实现的 <code>BatchExecutor</code> 可以发现，其中的 <code>next_batch()</code> 方法依赖于 <code>handle_src_result()</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">    <span style="color:#75715e">#[</span><span style="color:#75715e">inline</span><span style="color:#75715e">]</span>
    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">next_batch</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, scan_rows: <span style="color:#66d9ef">usize</span>) -&gt; <span style="color:#a6e22e">BatchExecuteResult</span> {
        <span style="color:#75715e">// 从下层算子那会一块数据开始过滤
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> src_result <span style="color:#f92672">=</span> self.src.next_batch(scan_rows);

        <span style="color:#75715e">// 根据表达式的值，过滤出对应的行。
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Err(e) <span style="color:#f92672">=</span> self.handle_src_result(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> src_result) {
            src_result.is_drained <span style="color:#f92672">=</span> src_result.is_drained.and(Err(e));
            src_result.logical_rows.clear();
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#75715e">// ... 
</span><span style="color:#75715e"></span>        }

        src_result
</code></pre></div><p>通过观察 <code>handle_src_result</code> 的实现，我们可以发现，它会遍历所有表达式，对其求值，表达式的值可能是一个标量，也可能是一个向量，但是我们完全是可以把标量看成是每行都一样的向量，然后根据每行的值，将其转换成 <code>bool</code>，如果该行的值为 <code>true</code>，则在 <code>logical_rows</code> 中保留他的下标。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">handle_src_result</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, src_result: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> BatchExecuteResult) -&gt; Result<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span> {
        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> src_logical_rows_copy <span style="color:#f92672">=</span> Vec::with_capacity(src_result.logical_rows.len());
        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> condition_index <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        <span style="color:#66d9ef">while</span> condition_index <span style="color:#f92672">&lt;</span> self.conditions.len() <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> <span style="color:#f92672">!</span>src_result.logical_rows.is_empty() {
            <span style="color:#75715e">// 拷贝一份下层算子的 `logical_rows`，用做计算表达式。
</span><span style="color:#75715e"></span>            src_logical_rows_copy.clear();
            src_logical_rows_copy.extend_from_slice(<span style="color:#f92672">&amp;</span>src_result.logical_rows);

            <span style="color:#75715e">// 计算表达式的值，然后根据表达式的值去更新下层算子的 `logical_rows`。
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">match</span> self.conditions[condition_index].eval(
                <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self.context,
                self.src.schema(),
                <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> src_result.physical_columns,
                <span style="color:#f92672">&amp;</span>src_logical_rows_copy,
                <span style="color:#75715e">// 表达式产生的结果如果是一列的话, 这里表示表达式应该输出的行数
</span><span style="color:#75715e"></span>                src_logical_rows_copy.len(),
            )<span style="color:#f92672">?</span> {
                RpnStackNode::Scalar { value, .. } <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> {
                    <span style="color:#75715e">// 如果表达式是一个标量，根据转换成 `bool` 的值确定是否保留该列。
</span><span style="color:#75715e"></span>                    update_logical_rows_by_scalar_value(
                        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> src_result.logical_rows,
                        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self.context,
                        value,
                    )<span style="color:#f92672">?</span>;
                }
                RpnStackNode::Vector { value, .. } <span style="color:#f92672">=</span><span style="color:#f92672">&gt;</span> {
                    <span style="color:#75715e">// 根据每行的结果，确定是否保留那行。
</span><span style="color:#75715e"></span>                    update_logical_rows_by_vector_value(
                    <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> src_result.logical_rows,
                    <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self.context,
                    eval_result,
                    eval_result_logical_rows,
                    )<span style="color:#f92672">?</span>;
                }
            }

            condition_index <span style="color:#f92672">+</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
        }

        Ok(())
    }
}
</code></pre></div><h3 id="batchfasthashaggregationexecutor-"><code>BatchFastHashAggregationExecutor</code> 的实现</h3>
<p>聚合算子的种类有很多种，包括：</p>
<ol>
<li><code>SimpleAggregation</code> (没有 <code>group by</code> 字句，只有聚合函数)</li>
</ol>
<ul>
<li>=&gt; <code>select count(*) from t where a &gt; 1</code></li>
</ul>
<ol start="2">
<li><code>FastHashAggregation</code> (只有一个 <code>group by</code> column)</li>
</ol>
<ul>
<li>=&gt; <code>select count(*) from t group by a</code></li>
</ul>
<ol start="3">
<li><code>SlowHashAggregation</code> (多个 <code>groub by</code> columns, 或者表达式值不是 <code>Hashable</code> 的)</li>
</ol>
<ul>
<li>=&gt; <code>select sum(*) from t group by a, b</code></li>
</ul>
<ol start="4">
<li><code>StreamAggregation</code> 这种聚合算子假设输入已经按照 <code>group by</code> columns 排好序。</li>
</ol>
<p>我们这里挑出一个比较具有代表性的算子：<code>BatchFastHashAggregationExecutor</code> 来进行分析。</p>
<p>首先要明确一下 <code>BatchFastHashAggregationExecutor</code> 大致的执行过程，首先我们会根据 <code>group by</code> column 里边的值给下层算子返回的表进行分组，比如：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> <span style="color:#66d9ef">count</span>(<span style="color:#f92672">*</span>) <span style="color:#66d9ef">from</span> t <span style="color:#66d9ef">group</span> <span style="color:#66d9ef">by</span> a
</code></pre></div><p><img alt="图 6 根据 a 列的值对行进行分组" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-16/6.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>然后，我们会遍历每个组，然后针对每个组求出每个聚合函数的值，在这里就是：</p>
<p><img alt="图 7 遍历每个组求出聚合函数的值" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-16/7.png" src="/images/svgs/loader-spinner.svg"/></p>
<p>接下来就涉及到两个重要的细节：</p>
<ol>
<li>
<p>聚合函数如何求值。</p>
</li>
<li>
<p>如何根据 <code>group_by column</code> 对行进行分组并聚合。</p>
</li>
</ol>
<p>后续几节我们着重介绍一下这两个细节是如何实现的。</p>
<h4 id="heading-5">聚合函数</h4>
<p>每个聚合函数都会实现一个 <a href="https://github.com/tikv/tikv/blob/96c3f978f655148b1703a520cb9b2e9001dd256d/components/tidb_query/src/aggr_fn/mod.rs#L35"><code>AggrFunction</code></a> 这个 trait：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> AggrFunction: <span style="color:#a6e22e">std</span>::fmt::Debug <span style="color:#f92672">+</span> Send <span style="color:#f92672">+</span> 'static {
    <span style="color:#e6db74">/// The display name of the function.
</span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">name</span>(<span style="color:#f92672">&amp;</span>self) -&gt; <span style="color:#66d9ef">&amp;</span>'static <span style="color:#66d9ef">str</span>;

    <span style="color:#e6db74">/// Creates a new state instance. Different states aggregate independently.
</span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">create_state</span>(<span style="color:#f92672">&amp;</span>self) -&gt; Box<span style="color:#f92672">&lt;</span>dyn AggrFunctionState<span style="color:#f92672">&gt;</span>;
}

<span style="color:#75715e">// NOTE: AggrFunctionState 是 AggrFunctionStateUpdatePartial 的 super trait
</span><span style="color:#75715e"></span><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> AggrFunctionState:
    <span style="color:#a6e22e">std</span>::fmt::Debug
    <span style="color:#f92672">+</span> Send
    <span style="color:#f92672">+</span> 'static
    <span style="color:#f92672">+</span> AggrFunctionStateUpdatePartial<span style="color:#f92672">&lt;</span>Int<span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">+</span> AggrFunctionStateUpdatePartial<span style="color:#f92672">&lt;</span>Real<span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">+</span> AggrFunctionStateUpdatePartial<span style="color:#f92672">&lt;</span>Decimal<span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">+</span> AggrFunctionStateUpdatePartial<span style="color:#f92672">&lt;</span>Bytes<span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">+</span> AggrFunctionStateUpdatePartial<span style="color:#f92672">&lt;</span>DateTime<span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">+</span> AggrFunctionStateUpdatePartial<span style="color:#f92672">&lt;</span>Duration<span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">+</span> AggrFunctionStateUpdatePartial<span style="color:#f92672">&lt;</span>Json<span style="color:#f92672">&gt;</span>
{
    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">push_result</span>(<span style="color:#f92672">&amp;</span>self, ctx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> EvalContext, target: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> [VectorValue]) -&gt; Result<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span>;
}
<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> AggrFunctionStateUpdatePartial<span style="color:#f92672">&lt;</span>T: <span style="color:#a6e22e">Evaluable</span><span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">update</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, ctx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> EvalContext, value: <span style="color:#66d9ef">&amp;</span>Option<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>) -&gt; Result<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span>;

    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">update_repeat</span>(
        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
        ctx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> EvalContext,
        value: <span style="color:#66d9ef">&amp;</span>Option<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>,
        repeat_times: <span style="color:#66d9ef">usize</span>,
    ) -&gt; Result<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span>;

    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">update_vector</span>(
        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
        ctx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> EvalContext,
        physical_values: <span style="color:#66d9ef">&amp;</span>[Option<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span>],
        logical_rows: <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">usize</span>],
    ) -&gt; Result<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span>;
}
</code></pre></div><p>聚合函数的求值过程分为三个步骤：</p>
<ol>
<li>
<p>创建并初始化状态，这一过程一般是由调用者调用：<code>create_state</code> 实现的。</p>
</li>
<li>
<p>然后在不断遍历行/向量的过程中，我们会将行的内容传入 <code>update/update_repeat/update_vector</code> 函数(具体调用那种取决于不同的聚合函数实现)，更新内部的状态，比如遇到一个非空行，<code>COUNT()</code> 就会给自己内部计数器+1。</p>
</li>
<li>
<p>当遍历结束之后，聚合函数就会将自己的状态通过 push_result(), 写入到一个列数组里边，这里之所以是列数组是因为聚合函数可能有多个输出列，比如 AVG()，在分布式的场景，我们需要返回两列：<code>SUM</code> 和 <code>COUNT</code>。</p>
</li>
</ol>
<p>这个 <code>trait</code> 可以通过 <code>#[derive(AggrFuntion)]</code> 自动推导出实现，并且可以通过过程宏 <code>#[aggr_funtion(state = FooState::new())]</code> 来指定 <code>create_state</code> 创建出来的 <code>State</code> 类型。举个例子，<code>COUNT</code> 的实现：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#e6db74">/// The COUNT aggregate function.
</span><span style="color:#e6db74"></span><span style="color:#75715e">#[</span><span style="color:#75715e">derive(Debug, AggrFunction)</span><span style="color:#75715e">]</span>
<span style="color:#75715e">#[</span><span style="color:#75715e">aggr_function(state = AggrFnStateCount::new())</span><span style="color:#75715e">]</span>
<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">AggrFnCount</span>;

<span style="color:#e6db74">/// The state of the COUNT aggregate function.
</span><span style="color:#e6db74"></span><span style="color:#75715e">#[</span><span style="color:#75715e">derive(Debug)</span><span style="color:#75715e">]</span>
<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">AggrFnStateCount</span> {
    count: <span style="color:#66d9ef">usize</span>,
}

<span style="color:#66d9ef">impl</span> AggrFnStateCount {
    <span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">new</span>() -&gt; <span style="color:#a6e22e">Self</span> {
        Self { count: <span style="color:#ae81ff">0</span> }
    }
}

<span style="color:#66d9ef">impl</span> AggrFunctionStateUpdatePartial <span style="color:#66d9ef">for</span> AggrFnStateCount { <span style="color:#75715e">/*</span><span style="color:#75715e"> .. </span><span style="color:#75715e">*/</span> }
<span style="color:#66d9ef">impl</span> AggrFunctionState <span style="color:#66d9ef">for</span> AggrFnStateCount { <span style="color:#75715e">/*</span><span style="color:#75715e"> .. </span><span style="color:#75715e">*/</span> }
</code></pre></div><p>这个时候，调用 <code>create_state()</code> 的时候就会将内部状态 Box 起来然后返回。</p>
<h4 id="-group-by-column-">如何根据 <code>group by</code> column 分组并聚合</h4>
<p><code>BatchFastHashAggregationExecutor</code> 内部会有一个 <code>Groups</code> 的结构，其核心是一个 <code>HashTable</code>，根据 <code>group by</code> 表达式具体的类型作为 <code>key</code> 的类型，而 <code>value</code> 的值则是一个 <code>AggrFunctionState</code> 数组中该组对应的聚合函数状态集合的开始下标。举个例子：</p>
<p><img alt="图 8 遍历所有聚合函数创建的状态" class="lazy" data-original="https://download.pingcap.com/images/blog-cn/tikv-source-code-reading-16/8.png" src="/images/svgs/loader-spinner.svg"/></p>
<p><code>Hash</code> 值一样的行会被分配到同一个组中，每组会有若干个状态，聚合的过程其实就是根据每行的 <code>group by</code> column 找到其对应的分组 (HashTable::get)，然后对组内的每一个状态，根据该行的内容进行更新。最后遍历每个组，将他们的状态写入到列数组即可。</p>
<h4 id="heading-6">将两个过程结合起来</h4>
<p>上边两节讨论了聚合函数如何计算，如何分组以及如何对每个组做聚合的基本过程。现在我们通过代码，来探讨一下其中的具体细节。</p>
<p>先来看看 <a href="https://github.com/tikv/tikv/blob/96c3f978f655148b1703a520cb9b2e9001dd256d/components/tidb_query/src/batch/executors/fast_hash_aggr_executor.rs#L34"><code>BatchFastHashAggregationExecutor</code></a> 的定义:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">BatchFastHashAggregationExecutor</span><span style="color:#f92672">&lt;</span>Src: <span style="color:#a6e22e">BatchExecutor</span><span style="color:#f92672">&gt;</span>(
    AggregationExecutor<span style="color:#f92672">&lt;</span>Src, FastHashAggregationImpl<span style="color:#f92672">&gt;</span>,
);
</code></pre></div><p>我们发现，这个和 <code>BatchTableScanExecutor</code> 的定义十分相似，区别每个聚合算子行为的是 <code>AggregationExecutor</code> 里边实现了 <code>AggregationExecutorImpl</code> trait 的一个结构体。 我们也可以看看这个 trait 提供了哪些方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">AggregationExecutor</span><span style="color:#f92672">&lt;</span>Src: <span style="color:#a6e22e">BatchExecutor</span>, I: <span style="color:#a6e22e">AggregationExecutorImpl</span><span style="color:#f92672">&lt;</span>Src<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span> {
    imp: <span style="color:#a6e22e">I</span>,
    is_ended: <span style="color:#66d9ef">bool</span>,
    entities: <span style="color:#a6e22e">Entities</span><span style="color:#f92672">&lt;</span>Src<span style="color:#f92672">&gt;</span>,
}

<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">trait</span> AggregationExecutorImpl<span style="color:#f92672">&lt;</span>Src: <span style="color:#a6e22e">BatchExecutor</span><span style="color:#f92672">&gt;</span>: Send {
    <span style="color:#75715e">// 根据 `group by` columns 和 聚合函数初始化 `entities` 中的 `schema`
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">prepare_entities</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self, entities: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Entities<span style="color:#f92672">&lt;</span>Src<span style="color:#f92672">&gt;</span>);

    <span style="color:#75715e">// 根据下层算子扫上来的数据做聚合和分组
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">process_batch_input</span>(
        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
        entities: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Entities<span style="color:#f92672">&lt;</span>Src<span style="color:#f92672">&gt;</span>,
        input_physical_columns: <span style="color:#a6e22e">LazyBatchColumnVec</span>,
        input_logical_rows: <span style="color:#66d9ef">&amp;</span>[<span style="color:#66d9ef">usize</span>],
    ) -&gt; Result<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span>;

    <span style="color:#75715e">// 将每个聚合函数的状态更新到列数组中，即写入聚合结果
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 这里返回的是 `group by` column，在分布式场景如果不把 `group by` column 返回，`TiDB` 没有办法根据分组做二次聚合。
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">iterate_available_groups</span>(
        <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self,
        entities: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Entities<span style="color:#f92672">&lt;</span>Src<span style="color:#f92672">&gt;</span>,
        src_is_drained: <span style="color:#66d9ef">bool</span>,
        iteratee: <span style="color:#a6e22e">impl</span> FnMut(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> Entities<span style="color:#f92672">&lt;</span>Src<span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&amp;</span>[Box<span style="color:#f92672">&lt;</span>dyn AggrFunctionState<span style="color:#f92672">&gt;</span>]) -&gt; Result<span style="color:#f92672">&lt;</span>()<span style="color:#f92672">&gt;</span>,
    ) -&gt; Result<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>LazyBatchColumn<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span>;
}
</code></pre></div><p>上边代码中的 <code>Entities</code> 是记录源算子已经聚合函数元信息的一个结构体：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Entities</span><span style="color:#f92672">&lt;</span>Src: <span style="color:#a6e22e">BatchExecutor</span><span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">pub</span> src: <span style="color:#a6e22e">Src</span>,
    
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// 聚合后产生的 `schmea`， 包含 `group_by` columns
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> schema: Vec<span style="color:#f92672">&lt;</span>FieldType<span style="color:#f92672">&gt;</span>,

    <span style="color:#e6db74">/// 聚合函数的集合
</span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> each_aggr_fn: Vec<span style="color:#f92672">&lt;</span>Box<span style="color:#f92672">&lt;</span>dyn AggrFunction<span style="color:#f92672">&gt;</span><span style="color:#f92672">&gt;</span>,

    <span style="color:#e6db74">/// 每个聚合函数输出的列大小，`COUNT` 是 1，`AVG` 是 2
</span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> each_aggr_cardinality: Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">usize</span><span style="color:#f92672">&gt;</span>,

    <span style="color:#e6db74">/// 聚合函数里边的表达式
</span><span style="color:#e6db74"></span>    <span style="color:#66d9ef">pub</span> each_aggr_exprs: Vec<span style="color:#f92672">&lt;</span>RpnExpression<span style="color:#f92672">&gt;</span>,

    <span style="color:#75715e">// 每个聚合表达式输出的类型的集合
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">pub</span> all_result_column_types: Vec<span style="color:#f92672">&lt;</span>EvalType<span style="color:#f92672">&gt;</span>,
}
</code></pre></div><p>首先，为了观察到 <code>BatchFastHashAggregationExecutor</code> 我们需要追踪他的 <code>next_batch()</code> 的实现，在这里也就是： <code>AggregationExecutor::handle_next_batch</code>：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">handle_next_batch</span>(<span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self) -&gt; Result<span style="color:#f92672">&lt;</span>(Option<span style="color:#f92672">&lt;</span>LazyBatchColumnVec<span style="color:#f92672">&gt;</span>, <span style="color:#66d9ef">bool</span>)<span style="color:#f92672">&gt;</span> {
        <span style="color:#75715e">// 从下层算子取回一个 `batch`
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> src_result <span style="color:#f92672">=</span> self
            .entities
            .src
            .next_batch(<span style="color:#66d9ef">crate</span>::batch:<span style="color:#960050;background-color:#1e0010">🏃</span>:<span style="color:#a6e22e">BATCH_MAX_SIZE</span>);

        self.entities.context.warnings <span style="color:#f92672">=</span> src_result.warnings;

        <span style="color:#66d9ef">let</span> src_is_drained <span style="color:#f92672">=</span> src_result.is_drained<span style="color:#f92672">?</span>;

        <span style="color:#75715e">// 如果下层返回的数据不为空，将根据每行的结果分组并聚合
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>src_result.logical_rows.is_empty() {
            self.imp.process_batch_input(
                <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> self.entities,
                src_result.physical_columns,
                <span style="color:#f92672">&amp;</span>src_result.logical_rows,
            )<span style="color:#f92672">?</span>;
        }

        <span style="color:#75715e">// 在 `FastHashAggr` 中，只有下层算子没有办法再返回数据的时候，才能认为聚合已经完成，
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 否则我们返回一个空数据给上层算子，等待下一次 `next_batch` 被调用。
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> <span style="color:#66d9ef">if</span> src_is_drained {
            Some(self.aggregate_partial_results(src_is_drained)<span style="color:#f92672">?</span>)
        } <span style="color:#66d9ef">else</span> {
            None
        };
        Ok((result, src_is_drained))
    }
</code></pre></div><p>具体到 <code>FastHashAggr</code> 中，<code>process_batch_input</code> 就是分组并更新每组的状态。<code>aggregate_partial_results</code> 就是写入最终的状态到列数组中。</p>
<h2 id="heading-7">总结</h2>
<p>本文简略的介绍了 TiKV 查询引擎的实现原理和几个简单算子的实现，如果大家对其他算子也感兴趣的话，可以到 <a href="https://github.com/tikv/tikv/tree/983c626b069f2a2314d0a47009ca74033b346069/components/tidb_query/src/batch/executors">tikv/components/tidb_query/src/batch/executors</a> 下边找到对应的实现，本文中出现的代码都经过一定删减，欢迎大家阅读 TiKV 的源码获取更多的细节。</p>
</div>
</div><div class="ssba-wrap">
<div class="ssba">
<a class="ssba_mail_share" href="mailto:info@pingcap.com" onclick="trackViews('blog-contact-us', 'mail_to_info_view')" target="_blank">
<svg height="18" viewbox="0 0 14 14" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M7 9L5.268 7.484.316 11.729c.18.167.423.271.691.271h11.986c.267 0 .509-.104.688-.271L8.732 7.484 7 9z"></path><path d="M13.684 2.271A1.007 1.007 0 0 0 12.993 2H1.007c-.267 0-.509.104-.689.273L7 8l6.684-5.729zM0 2.878v8.308l4.833-4.107zM9.167 7.079L14 11.186V2.875z"></path></svg>
</a>
<a class="ssba_wechat_share" data-site="wechat" data-url="https://pingcap.com/blog-cn/tikv-source-code-reading-16/" href="javascript:void(0)" id="wechat_share_btn" onclick="toggleBlogQRCode()">
<svg height="18" viewbox="0 0 31.403 31.404" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"></path><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"></path></svg>
</a>
</div>
</div>
<style type="text/css">
    .fixed-qrcode {
        position: fixed;
        top: 120px;
        right: 105px;
        padding: 10px 15px;
        width: 200px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.9);
        text-align: center;
    }

    .fixed-qrcode p {
        font-size: 14px;
        font-weight: 300;
        line-height: 1.6;
        margin: 8px 0;
        color: #333;
    }

    .fixed-qrcode #close_share_qrcode {
        position: absolute;
        top: 0;
        right: 0;
        width: 30px;
        height: 30px;
        padding: 10px;
    }

    .fixed-qrcode #close_share_qrcode svg {
        display: block;
    }

    .f-hide #share_qrcode {
        visibility: hidden;
        opacity: 0;
    }

    .fixed-qrcode #share_qrcode {
        visibility: visible;
        opacity: 1;
        height: 128px;
        transition: visibility 0s linear 0s, opacity .3s 0s;
        -webkit-transition: visibility 0s linear 0s, opacity .3s 0s;
    }

    #share_qrcode img {
        margin: 0 auto;
    }
</style>
<div class="f-hide" id="share_qrcode_outer">
<i id="close_share_qrcode"><svg viewbox="0 0 224.512 224.512" xmlns="http://www.w3.org/2000/svg"><path d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z" fill="#010002"></path></svg></i>
<p>分享到微信</p>
<div id="share_qrcode"></div>
<p>打开微信，使用 “扫一扫” 即可将网页分享至朋友圈。</p>
</div>
<script src="/js/vendor/qrcode.min.js" type="text/javascript"></script>
<script type="text/javascript">
    window.onload = function() {
        var close_share_qrcode_btn = document.getElementById('close_share_qrcode')
        var wechat_share_btn = document.getElementById('wechat_share_btn')
        var blog_url = wechat_share_btn.getAttribute('data-url')

        window.pingcap_blog_qrcode = new QRCode(
            document.getElementById('share_qrcode'),
            {
            text: blog_url,
            width: 128,
            height: 128,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
            }
        )

        close_share_qrcode_btn.addEventListener('click', function(event) {
            document
            .getElementById('share_qrcode_outer')
            .setAttribute('class', 'f-hide')
        })
    }

    function toggleBlogQRCode() {
        var qrcode_wrapper = document.getElementById('share_qrcode_outer')

        if (qrcode_wrapper.getAttribute('class') == 'f-hide') {
            qrcode_wrapper.setAttribute('class', 'fixed-qrcode')
        } else {
            qrcode_wrapper.setAttribute('class', 'f-hide')
        }
    }
</script>
</div>
</div>
</div>
<footer>
<div class="container">
<div class="flex-list-wrap">
<div class="flex-list">
<h4 class="list-title"><strong>产品</strong></h4>
<ul>
<li><a href="/docs-cn/v3.0/" onclick="trackViews('footer-product-tidb', 'docs-cn_view')">TiDB</a></li>
<li><a href="/docs-cn/v3.0/reference/tispark/">TiSpark</a></li>
<li><a href="/docs-cn/v3.0/roadmap/">TiDB 路线图</a></li>
</ul>
</div>
<div class="flex-list">
<h4 class="list-title"><strong>文档</strong></h4>
<ul>
<li><a href="https://docs.pingcap.com/zh/tidb/v4.0/quick-start-with-tidb">快速入门</a></li>
<li><a href="/blog-cn/tidb-best-practice/">最佳实践</a></li>
<li><a href="/docs-cn/stable/faq/tidb/">常见问题解答</a></li>
<li><a href="/docs-cn/stable/reference/tools/user-guide/">TiDB 周边工具</a></li>
<li><a href="https://docs.pingcap.com/zh/tidb/dev/release-notes">版本发布说明</a></li>
</ul>
</div>
<div class="flex-list">
<h4 class="list-title"><strong>资源</strong></h4>
<ul>
<li><a href="/blog-cn/">博客</a></li>
<li><a href="https://github.com/pingcap" target="_blank">GitHub</a></li>
<li><a href="https://book.tidb.io" target="_blank">TiDB in Action</a></li>
<li><a href="https://university.pingcap.com/" onclick="trackViews('footer-source-university', 'pingcap-university_view')" target="_blank">PingCAP
                    University</a></li>
<li><a href="/solutions/intel/" onclick="trackViews('footer-resource-solutions', 'solutions_view')">联合解决方案</a></li>
<li><a href="https://asktug.com/" onclick="trackViews('footer-resource-asktug', 'asktug_view')" target="_blank">Ask TUG</a></li>
</ul>
</div>
<div class="flex-list">
<h4 class="list-title"><strong>公司</strong></h4>
<ul>
<li><a href="/about-cn/">关于我们</a></li>
<li><a href="https://job.pingcap.com/" onclick="trackViews('footer-recruit-join', 'recruit-join_view')" target="_blank">招贤纳士</a>
</li>
<li><a href="/about-cn/news/">新闻报道</a></li>
<li><a href="/zh/privacy-policy/">隐私申明</a></li>
</ul>
</div>
</div>
<div class="contact-list-wrap">
<div class="flex-list">
<h4 class="list-title"><strong>联系我们</strong></h4>
<ul>
<li><a class="twitter" href="https://twitter.com/PingCAP" target="_blank"><svg height="19" viewbox="0 0 612 612" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z"></path></svg> Twitter</a></li>
<li><a class="linkedin" href="https://www.linkedin.com/company/pingcap/" target="_blank"><svg height="16" viewbox="0 0 438.536 438.535" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M5.424 145.895H99.64v282.932H5.424zM408.842 171.739c-19.791-21.604-45.967-32.408-78.512-32.408-11.991 0-22.891 1.475-32.695 4.427-9.801 2.95-18.079 7.089-24.838 12.419-6.755 5.33-12.135 10.278-16.129 14.844-3.798 4.337-7.512 9.389-11.136 15.104v-40.232h-93.935l.288 13.706c.193 9.139.288 37.307.288 84.508 0 47.205-.19 108.777-.572 184.722h93.931V270.942c0-9.705 1.041-17.412 3.139-23.127 4-9.712 10.037-17.843 18.131-24.407 8.093-6.572 18.13-9.855 30.125-9.855 16.364 0 28.407 5.662 36.117 16.987 7.707 11.324 11.561 26.98 11.561 46.966V428.82h93.931V266.664c-.007-41.688-9.897-73.328-29.694-94.925zM53.103 9.708c-15.796 0-28.595 4.619-38.4 13.848C4.899 32.787 0 44.441 0 58.529 0 72.42 4.758 84.034 14.275 93.358c9.514 9.325 22.078 13.99 37.685 13.99h.571c15.99 0 28.887-4.661 38.688-13.99 9.801-9.324 14.606-20.934 14.417-34.829-.19-14.087-5.047-25.742-14.561-34.973C81.562 14.323 68.9 9.708 53.103 9.708z"></path></svg> LinkedIn</a></li>
<li><a class="reddit" href="https://www.reddit.com/r/TiDB/" target="_blank"><svg height="18" viewbox="0 0 279.748 279.748" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M279.748 133.142c0-19.299-15.701-35-35-35-10.768 0-20.674 4.812-27.279 13.064-18.532-8.431-39.663-13.626-62.015-15.271l19.206-60.692 42.895 9.294c3.285 12.782 14.901 22.258 28.693 22.258 16.336 0 29.627-13.29 29.627-29.626 0-16.336-13.291-29.627-29.627-29.627-11.801 0-21.999 6.941-26.759 16.95l-49.497-10.725a10.002 10.002 0 0 0-11.651 6.756L134.636 95.43c-26.164.638-50.988 6.053-72.356 15.775-6.606-8.251-16.512-13.063-27.28-13.063-19.299 0-35 15.701-35 35 0 9.373 3.683 18.173 10.222 24.709-3.9 8.37-5.875 17.076-5.875 25.936 0 24.048 14.396 46.492 40.538 63.199 25.447 16.264 59.183 25.221 94.989 25.221 35.808 0 69.542-8.957 94.989-25.221 26.142-16.707 40.538-39.151 40.538-63.199 0-8.859-1.975-17.565-5.875-25.936 6.539-6.537 10.222-15.336 10.222-24.709zM15.369 145.139c-2.212-3.59-3.369-7.688-3.369-11.997 0-12.682 10.317-23 23-23 5.444 0 10.558 1.851 14.649 5.258-14.622 8.302-26.132 18.289-34.28 29.739zm52.671 20.266c0-13.785 11.215-25 25-25s25 11.215 25 25-11.215 25-25 25-25-11.215-25-25zm123.119 57.054c-9.745 10.637-29.396 17.244-51.285 17.244-21.888 0-41.539-6.607-51.284-17.244a9.937 9.937 0 0 1-2.617-7.192 9.933 9.933 0 0 1 3.235-6.937 9.974 9.974 0 0 1 6.754-2.627c2.797 0 5.484 1.183 7.373 3.244 5.803 6.333 20.827 10.756 36.539 10.756s30.737-4.423 36.539-10.756a10.022 10.022 0 0 1 7.374-3.244c2.508 0 4.906.933 6.755 2.627a9.928 9.928 0 0 1 3.234 6.937 9.933 9.933 0 0 1-2.617 7.192zm-4.451-32.054c-13.785 0-25-11.215-25-25s11.215-25 25-25 25 11.215 25 25-11.215 25-25 25zm77.671-45.266c-8.147-11.45-19.657-21.436-34.28-29.739 4.092-3.408 9.205-5.258 14.649-5.258 12.683 0 23 10.318 23 23 0 4.309-1.157 8.407-3.369 11.997z"></path></svg> Reddit</a></li>
<li><a class="google-plus" href="https://groups.google.com/forum/#!forum/tidb-user" target="_blank"><svg height="20" viewbox="0 0 491.858 491.858" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M377.472 224.957H201.319v58.718H308.79c-16.032 51.048-63.714 88.077-120.055 88.077-69.492 0-125.823-56.335-125.823-125.824 0-69.492 56.333-125.823 125.823-125.823 34.994 0 66.645 14.289 89.452 37.346l42.622-46.328c-34.04-33.355-80.65-53.929-132.074-53.929C84.5 57.193 0 141.693 0 245.928s84.5 188.737 188.736 188.737c91.307 0 171.248-64.844 188.737-150.989v-58.718l-.001-.001zM491.858 224.857h-36.031v-36.031h-30.886v36.031H388.91v30.883h36.031v36.032h30.886V255.74h36.031z"></path></svg> Google Group</a></li>
<li><a class="stack-overflow" href="https://stackoverflow.com/questions/tagged/tidb" target="_blank"><svg height="17" viewbox="0 0 547.597 547.597" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M140.81 475.111h.024l189.91-.269c8.434-.013 15.3-6.886 15.3-15.318v-21.298c0-8.428-6.854-15.288-15.3-15.288l-189.91.264c-8.433.012-15.3 6.885-15.3 15.318v21.31c.001 8.427 6.855 15.281 15.276 15.281z"></path><path d="M58.667 517.854c.073 29.26.073 29.449 3.072 29.449h.055l10.612.294h.086s85.814 0 171.629-.036c42.914-.019 85.821-.05 118-.092 16.09-.019 29.505-.043 38.887-.074 17.803-.055 17.803-.055 17.803-3.072l.3-10.697V333.299c0-8.434-6.866-15.3-15.3-15.3h-11.909c-8.434 0-15.3 6.866-15.3 15.3V496.22c0 5.062-4.119 9.18-9.181 9.18H110.51c-5.061 0-9.18-4.118-9.18-9.18V333.299c0-8.434-6.867-15.3-15.3-15.3H73.82c-8.433 0-15.3 6.86-15.3 15.3 0 23.342.012 76.084.055 122.981.019 23.447.05 45.442.092 61.574z"></path><path d="M142.322 397.399l189.402 17.467c.478.043.948.062 1.413.062 7.956 0 14.468-5.985 15.159-13.917l1.83-21.096c.729-8.396-5.508-15.851-13.898-16.628l-189.102-17.461c-8.593-.795-15.869 5.441-16.653 13.825l-1.97 21.108a15.172 15.172 0 0 0 3.452 11.181 15.19 15.19 0 0 0 10.367 5.459zM437.636 208.849a15.253 15.253 0 0 0 17.694 12.443l21.065-3.678c8.311-1.451 13.898-9.395 12.454-17.706l-32.504-187.23c-1.42-8.207-9.21-13.917-17.692-12.448l-21.065 3.678c-8.311 1.451-13.898 9.395-12.454 17.705l32.502 187.236zM190.333 194.375l163.6 96.708a15.28 15.28 0 0 0 7.778 2.136c5.393 0 10.447-2.876 13.183-7.509l10.876-18.36c2.08-3.519 2.674-7.631 1.658-11.591a15.18 15.18 0 0 0-7.032-9.358l-163.6-96.714c-7.014-4.149-16.836-1.597-20.967 5.374l-10.869 18.36a15.2 15.2 0 0 0-1.658 11.591 15.21 15.21 0 0 0 7.031 9.363zM387.525 240.501a15.276 15.276 0 0 0 12.626 6.659c3.091 0 6.077-.924 8.635-2.681l17.405-11.934c6.953-4.768 8.752-14.314 4.015-21.292L323.29 54.104c-4.584-6.732-14.498-8.623-21.236-3.984l-17.737 12.21c-6.945 4.779-8.727 14.327-3.971 21.291l107.179 156.88zM154.482 302.319l183.465 49.156c1.298.349 2.632.526 3.966.526 6.903 0 12.98-4.67 14.762-11.347l5.508-20.624c2.179-8.152-2.681-16.555-10.826-18.74l-183.465-49.162c-8.017-2.148-16.604 2.852-18.728 10.826l-5.508 20.63c-2.179 8.142 2.68 16.551 10.826 18.735z"></path></svg> Stack Overflow</a></li>
<li id="wechat"><a class="wechat" href="javascript:void(0)"><svg height="17" viewbox="0 0 31.403 31.404" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M31.403 21.306c0-4.597-4.388-8.32-9.8-8.32-5.414 0-9.802 3.725-9.802 8.32 0 4.597 4.388 8.322 9.802 8.322 1.701 0 3.302-.369 4.697-1.019l3.863 1.671-.447-4.309c1.066-1.329 1.687-2.937 1.687-4.665zm-13.102-2.254a1.395 1.395 0 1 1 0-2.79 1.395 1.395 0 0 1 0 2.79zm6.604 0a1.395 1.395 0 1 1 .003-2.79 1.395 1.395 0 0 1-.003 2.79z"></path><path d="M21.604 11.885c1.515 0 2.957.27 4.271.755.009-.175.03-.345.03-.521 0-6.074-5.801-10.996-12.953-10.996C5.799 1.123 0 6.044 0 12.119c0 2.284.822 4.408 2.229 6.167l-.591 5.694 5.104-2.213c1.264.59 2.661.986 4.136 1.189a8.143 8.143 0 0 1-.179-1.65c.001-5.195 4.892-9.421 10.905-9.421zm-4.287-6.428a1.84 1.84 0 1 1-1.841 1.84c0-1.016.825-1.84 1.841-1.84zM8.586 9.139a1.84 1.84 0 0 1 0-3.682 1.84 1.84 0 1 1 0 3.682z"></path></svg> 微信公众号</a> <div class="qr_code_outer f-hide f-tc">
<div class="qr_code">
<i id="close_qrcode"><svg viewbox="0 0 224.512 224.512" xmlns="http://www.w3.org/2000/svg"><path d="M224.507 6.997L217.521 0 112.256 105.258 6.998 0 .005 6.997l105.258 105.257L.005 217.512l6.993 7L112.256 119.24l105.265 105.272 6.986-7-105.258-105.258z" fill="#010002"></path></svg></i>
<img alt="Wechat qrCode" class="qr_code_img" id="js_qr_code_img" src="/images/wechat-qrcode.jpg"/>
<p>微信扫一扫<br/> 微信ID：pingcap2015</p>
</div>
</div>
</li>
</ul>
</div>
<div class="subscribe" id="subscribe-pc"></div>
</div>
</div>
<div class="container copyright-container">
<p class="copyright">© 2020 北京平凯星辰科技发展有限公司</p>
<a class="copyright-btn-lang copyright-btn-en" href="/blog" id="lang">English</a>
<a class="prepared-num" href="http://www.beian.miit.gov.cn/">京 ICP 备 16046278 号 - 2</a>
</div>
</footer>
<button class="back-to-top" type="button"><svg height="512" viewbox="0 0 284.929 284.929" width="512" xmlns="http://www.w3.org/2000/svg"><path d="M282.082 195.285L149.028 62.24c-1.901-1.903-4.088-2.856-6.562-2.856s-4.665.953-6.567 2.856L2.856 195.285C.95 197.191 0 199.378 0 201.853c0 2.474.953 4.664 2.856 6.566l14.272 14.271c1.903 1.903 4.093 2.854 6.567 2.854s4.664-.951 6.567-2.854l112.204-112.202 112.208 112.209c1.902 1.903 4.093 2.848 6.563 2.848 2.478 0 4.668-.951 6.57-2.848l14.274-14.277c1.902-1.902 2.847-4.093 2.847-6.566.001-2.476-.944-4.666-2.846-6.569z" fill="#FFF"></path></svg>
</button>
</div><div class="overlay"></div><script src="https://download.pingcap.com/js/jquery.min.js"></script><script src="/js/vendor/lazyload.min.js" type="text/javascript"></script>
<script src="/js/doc.js" type="text/javascript"></script>
<script src="/js/anchor.js" type="text/javascript"></script><script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script><script src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script><script crossorigin="anonymous" integrity="sha384-jbFinqIbKkHNg+QL+yxB4VrBC0EAPTuaLGeRT0T+NfEV89YC6u1bKxHLwoo+/xxY" src="https://browser.sentry-cdn.com/5.11.0/bundle.min.js"></script><script>Sentry.init({ 
            dsn: 'https://3f28ed393c5545daa74496b3cdb2e9ba@sentry.io/1887163' 
        });</script></body></html>